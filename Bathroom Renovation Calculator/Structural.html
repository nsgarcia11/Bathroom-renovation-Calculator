import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from "firebase/app";
import { getAuth, signInAnonymously, onAuthStateChanged } from "firebase/auth";
import { getFirestore, doc, onSnapshot, setDoc, setLogLevel } from "firebase/firestore";


// --- Firebase Configuration ---
// NOTE: These are placeholders. In a real environment, these would be provided.
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
    apiKey: "your-api-key",
    authDomain: "your-auth-domain",
    projectId: "your-project-id",
    storageBucket: "your-storage-bucket",
    messagingSenderId: "your-messaging-sender-id",
    appId: "your-app-id"
};

// Sanitize the app ID to ensure it's a valid Firestore path segment.
const appId = (typeof __app_id !== 'undefined' ? String(__app_id) : 'default-app-id').replace(/[\/\.]/g, '_');


// --- Data ---
// This object holds all the predefined costs for labor and materials for various tasks.
// Material prices have been updated to reflect Canadian (Ottawa/Toronto) market rates as of late 2025.
const COST_DATA = {
    // Wall Modifications
    frame_new_wall: { category: 'wall', labor: [{ id: 'lab-frame-wall', name: 'Frame new wall(s)', hours: 6, rate: 85 }], materials: [ { id: 'mat-lumber-2x4', name: '2x4 Lumber (8ft)', quantity: 15, price: 6.50, unit: 'stud' }, { id: 'mat-screws-framing', name: 'Framing Screws', quantity: 1, price: 20.00, unit: 'box' } ] },
    remove_wall: { category: 'wall', labor: [{ id: 'lab-remove-wall', name: 'Remove non-load bearing wall', hours: 6, rate: 85 }] },
    install_blocking: { category: 'wall', labor: [{ id: 'lab-install-blocking', name: 'Install blocking', hours: 2, rate: 85 }], materials: [{ id: 'mat-lumber-2x6', name: '2x6 Lumber (8ft)', quantity: 2, price: 12.00, unit: 'board' }] },
    frame_niche: { category: 'wall', labor: [{ id: 'lab-frame-niche', name: 'Frame shower niche', hours: 2.5, rate: 85 }], materials: [{ id: 'mat-lumber-2x4-niche', name: '2x4 Lumber (8ft)', quantity: 2, price: 6.50, unit: 'stud' }] },
    // Floor System
    repair_joist: { category: 'floor', labor: [{ id: 'lab-repair-joist', name: 'Repair / sister floor joists', hours: 5, rate: 85 }], materials: [ { id: 'mat-lumber-2x8', name: '2x8 Lumber (12ft)', quantity: 2, price: 30.00, unit: 'board' }, { id: 'mat-structural-screws', name: 'Structural Screws', quantity: 1, price: 35.00, unit: 'box' } ] },
    level_floor: { category: 'floor', labor: [{ id: 'lab-level-floor', name: 'Level floor', hours: 3, rate: 85 }], materials: [{ id: 'mat-leveler', name: 'Self-Leveling Compound (50lb)', quantity: 3, price: 60.00, unit: 'bag' }] },
    install_plywood: { category: 'floor', labor: [{ id: 'lab-install-plywood', name: 'Install new plywood subfloor', hours: 3, rate: 85 }], materials: [ { id: 'mat-plywood-subfloor', name: '3/4" Plywood Subfloor', quantity: 4, price: 70.00, unit: 'sheet', thicknessOptions: { '1/2': { name: '1/2" Plywood Subfloor', price: 50.00 }, '5/8': { name: '5/8" Plywood Subfloor', price: 60.00 }, '3/4': { name: '3/4" Plywood Subfloor', price: 70.00 } } }, { id: 'mat-floor-screws', name: 'Subfloor Screws', quantity: 1, price: 25.00, unit: 'box' } ] },
    replace_rotten_subfloor: { category: 'floor', labor: [{ id: 'lab-replace-rotten-subfloor', name: 'Replace rotten subfloor', hours: 6, rate: 85 }], materials: [ { id: 'mat-plywood-patch', name: '3/4" Plywood Subfloor (for patch)', quantity: 2, price: 70.00, unit: 'sheet' }, { id: 'mat-lumber-2x4-support', name: '2x4 Lumber for support', quantity: 3, price: 6.50, unit: 'stud' } ] },
    // Window and Door Openings
    add_new_window: { category: 'windowDoor', labor: [{ id: 'lab-add-window', name: 'Frame for new window', hours: 6, rate: 85 }], materials: [ { id: 'mat-lumber-2x6-header', name: '2x6 Lumber for header', quantity: 2, price: 12.00, unit: 'board' }, { id: 'mat-window-flashing', name: 'Window Flashing Tape', quantity: 1, price: 30.00, unit: 'roll' } ] },
    enlarge_window: { category: 'windowDoor', labor: [{ id: 'lab-enlarge-window', name: 'Enlarge existing window opening', hours: 6, rate: 85 }], materials: [ { id: 'mat-lumber-2x6-header-large', name: '2x6 Lumber for new header', quantity: 2, price: 12.00, unit: 'board' }] },
    change_doorway: { category: 'windowDoor', labor: [{ id: 'lab-change-doorway', name: 'Change doorway opening', hours: 4, rate: 85 }], materials: [ { id: 'mat-lumber-2x4-door', name: '2x4 Lumber for door frame', quantity: 3, price: 6.50, unit: 'stud' }] },
    close_off_window: { category: 'windowDoor', labor: [{ id: 'lab-close-window', name: 'Frame and close off window opening', hours: 5, rate: 85 }], materials: [ { id: 'mat-lumber-2x4-close', name: '2x4 Lumber for framing', quantity: 4, price: 6.50, unit: 'stud' }, { id: 'mat-sheathing-close', name: '1/2" Plywood Sheathing', quantity: 1, price: 40.00, unit: 'sheet' }, { id: 'mat-screws-closing', name: 'General Purpose Screws', quantity: 1, price: 15.00, unit: 'box' } ] },
};

// Defines the styling for each category card.
const CATEGORY_STYLES = {
    wall: { name: 'Wall Modifications', bg: 'bg-white', text: 'text-slate-800', },
    floor: { name: 'Floors', bg: 'bg-white', text: 'text-slate-800', },
    windowDoor: { name: 'Window & Door Openings', bg: 'bg-white', text: 'text-slate-800', },
};

// --- Helper Components ---

/**
 * A reusable dropdown component.
 */
const Dropdown = ({ label, options, selectedOption, onSelect, hideLabel }) => { return ( <div className="mt-2">{!hideLabel && <label className="block text-sm font-semibold text-slate-700 mb-1.5">{label}</label>}<div className="relative"><select value={selectedOption} onChange={(e) => onSelect(e.target.value)} className="block appearance-none w-full bg-white border border-slate-300 text-slate-700 py-2.5 px-4 pr-8 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">{options.map((option) => (<option key={option.value} value={option.value}>{option.label}</option>))}</select><div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-slate-500"><svg className="fill-current h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" /></svg></div></div></div> ); };

/**
 * A reusable checkbox component with a toggle switch style.
 */
const CheckboxOption = ({ label, isChecked, onToggle, children }) => {
    return (
        <div className="p-4 bg-white rounded-lg border border-slate-200 shadow-sm">
            <label className="flex items-center justify-between cursor-pointer">
                <span className="text-sm font-semibold text-slate-700">{label}</span>
                <div className="relative">
                    <input type="checkbox" checked={isChecked} onChange={onToggle} className="sr-only peer" />
                    <div className="w-11 h-6 bg-gray-200 rounded-full border-2 border-blue-300 peer-checked:bg-blue-600 peer-checked:border-blue-600 peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all"></div>
                </div>
            </label>
            {isChecked && children && <div className="mt-3 pt-3 border-t border-slate-200 animate-fade-in">{children}</div>}
        </div>
    );
};


// --- View Components ---

/**
 * StructuralView: The main view for selecting project tasks.
 */
const StructuralView = ({ choices, onTaskToggle, onPlywoodChange, onNotesChange }) => {
    const [openCard, setOpenCard] = useState('wall');
    const [showNotes, setShowNotes] = useState(!!choices.notes);

    const wallOptions = [ { id: 'frame_new_wall', label: 'Frame new wall(s)' }, { id: 'remove_wall', label: 'Remove non-load bearing wall' }, { id: 'install_blocking', label: 'Install blocking for accessories (grab bars, etc.)' }, { id: 'frame_niche', label: 'Frame shower niche' }, ];
    const floorOptions = [ { id: 'repair_joist', label: 'Repair / sister floor joists' }, { id: 'level_floor', label: 'Level floor with self-leveling compound' }, { id: 'install_plywood', label: 'Install new plywood subfloor' }, { id: 'replace_rotten_subfloor', label: 'Replace rotten subfloor' } ];
    const windowDoorOptions = [ { id: 'add_new_window', label: 'Add new window' }, { id: 'enlarge_window', label: 'Enlarging an Existing Window' }, { id: 'change_doorway', label: 'Changing Doorway' }, { id: 'close_off_window', label: 'Closing off window' } ];
    const plywoodThicknessOptions = [ { value: '1/2', label: '1/2"' }, { value: '5/8', label: '5/8"' }, { value: '3/4', label: '3/4"' }, ];
    
    // A reusable card component for categories.
    const Card = ({ title, category, children }) => {
        const isOpen = openCard === category;
        return (
            <div className="bg-white rounded-lg border border-slate-200 shadow-sm">
                <button onClick={() => setOpenCard(isOpen ? null : category)} className="w-full flex justify-between items-center p-4">
                    <h3 className="text-lg font-bold text-slate-800">{title}</h3>
                    <svg xmlns="http://www.w3.org/2000/svg" className={`w-5 h-5 text-blue-500 transition-transform ${isOpen ? 'rotate-180' : ''}`} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M6 9l6 6 6-6"/></svg>
                </button>
                {isOpen && <div className="p-4 pt-0 space-y-3 animate-fade-in">{children}</div>}
            </div>
        );
    };

    return (
        <div>
            <div className="pt-2 pb-6">
                <h2 className="text-4xl font-bold text-slate-800 text-center">Structural & Other</h2>
            </div>
            <div className="space-y-6 bg-slate-100 p-6 rounded-xl">
                <Card title="Wall Modifications" category="wall">
                    {wallOptions.map(opt => (<CheckboxOption key={opt.id} label={opt.label} isChecked={(choices.wall || []).includes(opt.id)} onToggle={() => onTaskToggle('wall', opt.id)} />))}
                </Card>
                <Card title="Floors" category="floor">
                    {floorOptions.map(opt => (<CheckboxOption key={opt.id} label={opt.label} isChecked={(choices.floor || []).includes(opt.id)} onToggle={() => onTaskToggle('floor', opt.id)}>{opt.id === 'install_plywood' && (<Dropdown label="Plywood Thickness" options={plywoodThicknessOptions} selectedOption={choices.plywoodThickness || '3/4'} onSelect={onPlywoodChange} />)}</CheckboxOption>))}
                </Card>
                <Card title="Window & Door Openings" category="windowDoor">
                    {windowDoorOptions.map(opt => (<CheckboxOption key={opt.id} label={opt.label} isChecked={(choices.windowDoor || []).includes(opt.id)} onToggle={() => onTaskToggle('windowDoor', opt.id)} />))}
                </Card>
                <section>
                    <h3 className="text-lg font-semibold text-slate-700 mb-3">General Notes</h3>
                    <div className="rounded-lg bg-white p-4 border border-slate-200 shadow-sm">
                        {!showNotes ? (<button onClick={() => setShowNotes(true)} className="w-full text-sm font-semibold text-blue-600 hover:text-blue-800 py-2 rounded-lg hover:bg-blue-100 transition-colors">+ Add Notes</button>) : (<div className="animate-fade-in"><div className="flex justify-between items-center mb-1.5"><label className="block text-sm font-semibold text-slate-700">Notes</label><button onClick={() => setShowNotes(false)} className="text-xs text-slate-500 hover:text-slate-700">Hide</button></div><textarea value={choices.notes || ''} onChange={(e) => onNotesChange(e.target.value)} placeholder="Add notes..." className="w-full p-2.5 border border-slate-300 rounded-lg" rows="3"></textarea></div>)}
                    </div>
                </section>
            </div>
        </div>
    );
};

/**
 * A generic view for displaying and editing line items (Labor or Materials).
 * Now supports editing and deleting ANY item, not just custom ones.
 */
const ItemListView = ({ title, itemsByCategory, onUpdateItem, onAddItem, onDeleteItem, itemType }) => {
    const [openCategories, setOpenCategories] = useState({});
    const toggleCategory = (category) => { setOpenCategories(prev => ({ ...prev, [category]: !prev[category] })); };
    const total = Object.values(itemsByCategory).flat().reduce((sum, item) => sum + (parseFloat(item.quantity || item.hours) || 0) * (parseFloat(item.price || item.rate) || 0), 0);

    return (
        <div className="space-y-6">
            <div className="flex justify-between items-center">
                <h2 className="text-2xl font-bold text-slate-800">{title}</h2>
                <p className="font-bold text-blue-600 text-lg">${total.toFixed(2)}</p>
            </div>
            <div className="space-y-4">
                {Object.entries(itemsByCategory).map(([category, items]) => {
                    if (items.length === 0) return null;
                    const style = CATEGORY_STYLES[category];
                    const categoryTotal = items.reduce((sum, item) => sum + (parseFloat(item.quantity || item.hours) || 0) * (parseFloat(item.price || item.rate) || 0), 0);
                    const isOpen = !!openCategories[category];
                    return (
                        <div key={category} className={`${style.bg} rounded-xl shadow-sm`}>
                            <button onClick={() => toggleCategory(category)} className={`w-full p-4 flex justify-between items-center ${style.text}`}>
                                <h3 className="text-lg font-bold">{style.name}</h3>
                                <div className="flex items-center gap-4"><span className="font-semibold">${categoryTotal.toFixed(2)}</span><svg className={`w-5 h-5 transition-transform ${isOpen ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7" /></svg></div>
                            </button>
                            {isOpen && (
                                <div className="p-4 pt-0 space-y-3 animate-fade-in">
                                    {items.map(item => (
                                        <div key={item.id} className="p-4 bg-white rounded-lg shadow-sm">
                                            <div className="flex justify-between items-start gap-2">
                                                <input type="text" value={item.name} onChange={e => onUpdateItem(item.id, { name: e.target.value })} className="flex-grow font-semibold text-slate-800 p-1 border border-transparent hover:border-slate-200 focus:border-blue-500 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500" />
                                                <button onClick={() => onDeleteItem(item.id)} className="flex-shrink-0 p-1 text-red-400 hover:text-red-600 ml-2"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                                            </div>
                                            <div className="grid grid-cols-3 gap-4 mt-2">
                                                <div>
                                                    <label className="text-xs text-slate-500">{itemType === 'labor' ? 'Hours' : 'Quantity'}</label>
                                                    <input type="number" value={itemType === 'labor' ? item.hours : item.quantity} onChange={e => onUpdateItem(item.id, itemType === 'labor' ? { hours: e.target.value } : { quantity: e.target.value })} className="w-full p-2 text-center border rounded-lg" />
                                                </div>
                                                <div>
                                                    <label className="text-xs text-slate-500">{itemType === 'labor' ? 'Rate ($/hr)' : 'Price/Unit ($)'}</label>
                                                    <input type="number" value={itemType === 'labor' ? item.rate : item.price} onChange={e => onUpdateItem(item.id, itemType === 'labor' ? { rate: e.target.value } : { price: e.target.value })} className="w-full p-2 text-center border rounded-lg" />
                                                </div>
                                                <div>
                                                    <label className="text-xs text-slate-500">Total</label>
                                                    <p className="w-full p-2 text-center font-semibold text-slate-800">${((parseFloat(item.quantity || item.hours) || 0) * (parseFloat(item.price || item.rate) || 0)).toFixed(2)}</p>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                    <button onClick={() => onAddItem(category)} className="w-full text-sm font-semibold text-blue-600 hover:text-blue-800 py-2 mt-2 rounded-lg hover:bg-blue-100 transition-colors">+ Add Custom {itemType === 'labor' ? 'Labor' : 'Material'}</button>
                                </div>
                            )}
                        </div>
                    );
                })}
                {total === 0 && <p className="text-slate-500 text-center py-4">No {itemType} items selected.</p>}
            </div>
        </div>
    );
};

const EstimateView = ({ laborItems, materialItems, notes, taxRate, setTaxRate, contingencyRate, setContingencyRate }) => {
    const laborTotal = Object.values(laborItems).flat().reduce((sum, item) => sum + (parseFloat(item.hours) || 0) * (parseFloat(item.rate) || 0), 0);
    const materialTotal = Object.values(materialItems).flat().reduce((sum, item) => sum + (parseFloat(item.quantity) || 0) * (parseFloat(item.price) || 0), 0);
    const subtotal = laborTotal + materialTotal;
    const contingencyAmount = subtotal * (contingencyRate / 100);
    const subtotalWithContingency = subtotal + contingencyAmount;
    const taxAmount = subtotalWithContingency * (taxRate / 100);
    const grandTotal = subtotalWithContingency + taxAmount;

    const CostRow = ({ label, value, isBold = false, isLast = false }) => (
        <div className={`flex justify-between items-center py-3 ${!isLast ? 'border-b border-slate-200' : ''}`}>
            <p className={`text-sm ${isBold ? 'font-bold text-slate-800' : 'text-slate-600'}`}>{label}</p>
            <p className={`text-sm ${isBold ? 'font-bold text-slate-800' : 'text-slate-700'}`}>${value.toFixed(2)}</p>
        </div>
    );

    return (
        <div className="bg-slate-100 p-6 rounded-xl">
             <h2 className="text-2xl font-bold text-slate-800 text-center mb-6">Project Estimate Summary</h2>
             <div className="bg-white p-6 rounded-lg shadow-sm">
                <h3 className="text-lg font-bold text-slate-800 mb-2">Cost Breakdown</h3>
                <div className="space-y-1">
                    <CostRow label="Total Labor" value={laborTotal} />
                    <CostRow label="Total Materials" value={materialTotal} />
                    <CostRow label="Subtotal" value={subtotal} isBold />
                </div>
             </div>

            <div className="bg-white p-6 rounded-lg shadow-sm mt-6">
                <h3 className="text-lg font-bold text-slate-800 mb-4">Adjustments</h3>
                 <div className="space-y-4">
                    <div>
                        <label className="block text-sm font-semibold text-slate-700 mb-1.5">Contingency (%)</label>
                        <input type="number" value={contingencyRate} onChange={(e) => setContingencyRate(parseFloat(e.target.value) || 0)} className="w-full p-2.5 border border-slate-300 rounded-lg"/>
                        <CostRow label="Contingency Amount" value={contingencyAmount} />
                    </div>
                     <div>
                        <label className="block text-sm font-semibold text-slate-700 mb-1.5">Tax (%)</label>
                        <input type="number" value={taxRate} onChange={(e) => setTaxRate(parseFloat(e.target.value) || 0)} className="w-full p-2.5 border border-slate-300 rounded-lg"/>
                    </div>
                </div>
            </div>

             <div className="bg-white p-6 rounded-lg shadow-sm mt-6">
                 <div className="space-y-1">
                    <CostRow label="Subtotal" value={subtotal} />
                    <CostRow label={`Contingency (${contingencyRate}%)`} value={contingencyAmount} />
                    <CostRow label="Subtotal incl. Contingency" value={subtotalWithContingency} isBold />
                    <CostRow label={`Tax (${taxRate}%)`} value={taxAmount} />
                </div>
                <div className="flex justify-between items-center pt-4 mt-4 border-t-2 border-slate-800">
                    <p className="text-xl font-extrabold text-slate-900">Grand Total</p>
                    <p className="text-xl font-extrabold text-blue-600">${grandTotal.toFixed(2)}</p>
                </div>
            </div>

            {notes && (
                 <div className="bg-white p-6 rounded-lg shadow-sm mt-6">
                    <h3 className="text-lg font-bold text-slate-800 mb-2">Notes</h3>
                    <p className="text-sm text-slate-600 whitespace-pre-wrap">{notes}</p>
                 </div>
            )}
        </div>
    );
};

const PlaceholderView = ({ title }) => { return ( <div className="text-center p-8"><h2 className="text-2xl font-bold text-slate-800">{title}</h2><p className="text-slate-500 mt-4">This section is under construction.</p></div> ); };

// --- Navigation Components ---

const TopNavBar = ({ activeCategory, setActiveCategory }) => {
    const navItems = [
        { id: 'demolition', label: 'Demolition', icon: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6 mb-1.5"><path d="m15 12-9.373 9.373a1 1 0 0 1-3.001-3L12 9"/><path d="m18 15 4-4"/><path d="m21.5 11.5-1.914-1.914A2 2 0 0 1 19 8.172v-.344a2 2 0 0 0-.586-1.414l-1.657-1.657A6 6 0 0 0 12.516 3H9l1.243 1.243A6 6 0 0 1 12 8.485V10l2 2h1.172a2 2 0 0 1 1.414.586L18.5 14.5"/></svg> },
        { id: 'shower_walls', label: 'Shower Walls', icon: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6 mb-1.5"><path d="m4 4 2.5 2.5"/><path d="M13.5 6.5a4.95 4.95 0 0 0-7 7"/><path d="M15 5 5 15"/><path d="M14 17v.01"/><path d="M10 16v.01"/><path d="M13 13v.01"/><path d="M16 10v.01"/><path d="M11 20v.01"/><path d="M17 14v.01"/><path d="M20 11v.01"/></svg> },
        { id: 'shower_base', label: 'Shower Base', icon: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6 mb-1.5"><rect width="18" height="18" x="3" y="3" rx="2"/><circle cx="12" cy="12" r="1"/></svg> },
        { id: 'floors', label: 'Floors', icon: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6 mb-1.5"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg> },
        { id: 'finishings', label: 'Finishings', icon: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6 mb-1.5"><path d="m14.622 17.897-10.68-2.913"/><path d="M18.376 2.622a1 1 0 1 1 3.002 3.002L17.36 9.643a.5.5 0 0 0 0 .707l.944.944a2.41 2.41 0 0 1 0 3.408l-.944.944a.5.5 0 0 1-.707 0L8.354 7.348a.5.5 0 0 1 0-.707l.944-.944a2.41 2.41 0 0 1 3.408 0l.944.944a.5.5 0 0 0 .707 0z"/><path d="M9 8c-1.804 2.71-3.97 3.46-6.583 3.948a.507.507 0 0 0-.302.819l7.32 8.883a1 1 0 0 0 1.185.204C12.735 20.405 16 16.792 16 15"/></svg> },
        { id: 'structural', label: 'Structural/Other', icon: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6 mb-1.5"><path d="M2 9a3 3 0 0 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 0 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/><path d="M9 12h6"/></svg> },
        { id: 'trade', label: 'Trade', icon: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6 mb-1.5"><path d="M10 10V5a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v5"/><path d="M14 6a6 6 0 0 1 6 6v3"/><path d="M4 15v-3a6 6 0 0 1 6-6"/><rect x="2" y="15" width="20" height="4" rx="1"/></svg> },
    ];

    return (
        <div className="fixed top-0 left-0 right-0 z-30 bg-white/80 backdrop-blur-sm shadow-sm px-4 sm:px-6">
            <div className="max-w-xl mx-auto">
                <div className="tab-scrollbar flex space-x-4 overflow-x-auto py-3">
                    {navItems.map(item => {
                        const isActive = activeCategory === item.id;
                        const activeClasses = 'bg-white text-blue-600 shadow-md border-2 border-blue-500';
                        const defaultClasses = 'bg-slate-100 text-slate-500 hover:bg-slate-200';
                        return (
                             <button key={item.id} onClick={() => setActiveCategory(item.id)} className="flex-shrink-0 transition-colors">
                                 <div className={`flex flex-col items-center justify-center w-24 h-20 rounded-xl ${isActive ? activeClasses : defaultClasses}`}>
                                     {item.icon}
                                     <span className="text-xs font-medium">{item.label}</span>
                                 </div>
                             </button>
                        );
                    })}
                </div>
            </div>
        </div>
    );
};


const BottomNavBar = ({ activeView, setActiveView }) => { 
    const [isMenuOpen, setIsMenuOpen] = useState(false);
    const menuRef = useRef(null);

    useEffect(() => {
        const handleClickOutside = (event) => { if (menuRef.current && !menuRef.current.contains(event.target)) { setIsMenuOpen(false); } };
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
    }, []);

    const navItems = [
        { id: 'structural', label: 'Design', icon: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6 mb-1"><path d="M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z"/></svg> },
        { id: 'labor', label: 'Labor', icon: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6 mb-1"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg> },
        { id: 'materials', label: 'Materials', icon: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6 mb-1"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg> },
        { id: 'estimate', label: 'Estimate', icon: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6 mb-1"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg> },
    ];

    return (
        <div className="fixed bottom-0 left-0 right-0 z-20 bg-white/95 backdrop-blur-sm border-t border-slate-200 safe-area-padding">
            <div className="max-w-xl mx-auto">
                <div className="flex justify-evenly py-2">
                    {navItems.map(item => (
                        <button key={item.id} onClick={() => setActiveView(item.id)} className={`flex flex-col items-center justify-center w-20 h-16 rounded-xl transition-colors group ${activeView === item.id ? 'text-blue-600 bg-blue-100' : 'text-slate-600 hover:bg-slate-100'}`}>
                            {item.icon}
                            <span className="text-xs font-semibold">{item.label}</span>
                        </button>
                    ))}
                    <div className="relative" ref={menuRef}>
                        <button onClick={() => setIsMenuOpen(prev => !prev)} className="flex flex-col items-center justify-center w-20 h-16 rounded-xl hover:bg-slate-100 transition-colors group text-slate-600">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6 mb-1"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                            <span className="text-xs font-semibold">Menu</span>
                        </button>
                        {isMenuOpen && (
                            <div className="absolute right-0 bottom-full mb-3 w-56 bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden z-30">
                                <a href="#" className="flex items-center gap-3 px-4 py-3 text-sm text-slate-700 hover:bg-slate-50 transition-colors"><span>Pictures</span></a>
                                <a href="#" className="flex items-center gap-3 px-4 py-3 text-sm text-slate-700 hover:bg-slate-50 transition-colors"><span>Notes</span></a>
                                <a href="#" className="flex items-center gap-3 px-4 py-3 text-sm text-slate-700 hover:bg-slate-50 transition-colors"><span>Send estimate</span></a>
                                <a href="#" className="flex items-center gap-3 px-4 py-3 text-sm text-slate-700 hover:bg-slate-50 transition-colors"><span>Insights</span></a>
                                <a href="#" className="flex items-center gap-3 px-4 py-3 text-sm text-slate-700 hover:bg-slate-50 transition-colors"><span>Settings</span></a>
                            </div>
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
};

// --- Main App Component ---
const App = () => {
    // State for bottom navigation (Design, Labor, Materials)
    const [activeView, setActiveView] = useState('structural');
    // State for top navigation (Demolition, Structural, etc.)
    const [activeCategory, setActiveCategory] = useState('structural');

    // Main state for user's selections and notes
    const [projectChoices, setProjectChoices] = useState({ wall: [], floor: [], windowDoor: [], plywoodThickness: '3/4', notes: '' });
    
    // State for labor and material items. This is now the single source of truth.
    const [laborItems, setLaborItems] = useState({ wall: [], floor: [], windowDoor: [] });
    const [materialItems, setMaterialItems] = useState({ wall: [], floor: [], windowDoor: [] });
    const [taxRate, setTaxRate] = useState(13); // Default HST for Ontario, Canada
    const [contingencyRate, setContingencyRate] = useState(10); // Default 10% contingency

    // --- Firebase State ---
    const [db, setDb] = useState(null);
    const [userId, setUserId] = useState(null);
    const [isAuthReady, setIsAuthReady] = useState(false);
    const dataLoadedRef = useRef(false);
    const debounceTimeoutRef = useRef(null);

    // --- Firebase Initialization and Auth ---
    useEffect(() => {
        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const firestore = getFirestore(app);
            setDb(firestore);
            setLogLevel('debug'); // for detailed logs

            const unsubscribe = onAuthStateChanged(auth, async (user) => {
                if (user) {
                    setUserId(user.uid);
                } else {
                    await signInAnonymously(auth);
                }
                setIsAuthReady(true);
            });
            return () => unsubscribe();
        } catch (error) {
            console.error("Firebase initialization error:", error);
        }
    }, []);

    // --- Data Loading from Firestore ---
    useEffect(() => {
        if (!isAuthReady || !db || !userId) return;

        try {
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/projectData/main`);
            const unsubscribe = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    setProjectChoices(data.projectChoices || { wall: [], floor: [], windowDoor: [], plywoodThickness: '3/4', notes: '' });
                    setLaborItems(data.laborItems || { wall: [], floor: [], windowDoor: [] });
                    setMaterialItems(data.materialItems || { wall: [], floor: [], windowDoor: [] });
                    setTaxRate(data.taxRate !== undefined ? data.taxRate : 13);
                    setContingencyRate(data.contingencyRate !== undefined ? data.contingencyRate : 10);
                } else {
                    console.log("No project data found in Firestore, starting with a fresh slate.");
                }
                // Mark that initial data load has happened
                dataLoadedRef.current = true;
            }, (error) => {
                console.error("Firestore onSnapshot error:", error);
            });

            return () => unsubscribe();
        } catch(error) {
            console.error("Error creating document reference:", error);
        }
    }, [isAuthReady, db, userId, appId]);

    // --- Data Saving to Firestore with Debounce ---
    useEffect(() => {
        // Do not save until the initial data has been loaded from Firestore.
        if (!dataLoadedRef.current || !isAuthReady || !db || !userId) {
            return;
        }

        if (debounceTimeoutRef.current) {
            clearTimeout(debounceTimeoutRef.current);
        }

        debounceTimeoutRef.current = setTimeout(async () => {
            try {
                const dataToSave = {
                    projectChoices,
                    laborItems,
                    materialItems,
                    taxRate,
                    contingencyRate
                };
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/projectData/main`);
                await setDoc(docRef, dataToSave, { merge: true });
                console.log("Project data successfully saved to Firestore.");
            } catch (error) {
                console.error("Error saving data to Firestore:", error);
            }
        }, 1500); // Debounce for 1.5 seconds

        return () => {
            if (debounceTimeoutRef.current) {
                clearTimeout(debounceTimeoutRef.current);
            }
        };
    }, [projectChoices, laborItems, materialItems, taxRate, contingencyRate, isAuthReady, db, userId, appId]);


    // --- Item Handlers ---
    // These functions now directly manipulate the laborItems and materialItems state,
    // providing a more predictable and robust way to manage data.

    const addLaborItem = (category) => {
        const newItem = { id: `custom-lab-${Date.now()}`, name: 'New Custom Labor', category, hours: '', rate: 85, isCustom: true };
        setLaborItems(prev => ({ ...prev, [category]: [...(prev[category] || []), newItem] }));
    };
    const addMaterialItem = (category) => {
        const newItem = { id: `custom-mat-${Date.now()}`, name: 'New Custom Material', category, quantity: 1, price: '', isCustom: true };
        setMaterialItems(prev => ({ ...prev, [category]: [...(prev[category] || []), newItem] }));
    };

    const updateItem = (setter, id, updatedValues) => {
        setter(prev => {
            const newItems = { ...prev };
            for (const category in newItems) {
                newItems[category] = newItems[category].map(item =>
                    item.id === id ? { ...item, ...updatedValues } : item
                );
            }
            return newItems;
        });
    };
    const updateLaborItem = (id, updatedValues) => updateItem(setLaborItems, id, updatedValues);
    const updateMaterialItem = (id, updatedValues) => updateItem(setMaterialItems, id, updatedValues);

    const deleteItem = (setter, id) => {
        setter(prev => {
            const newItems = { ...prev };
            for (const category in newItems) {
                newItems[category] = prev[category].filter(item => item.id !== id);
            }
            return newItems;
        });
    };
    const deleteLaborItem = (id) => deleteItem(setLaborItems, id);
    const deleteMaterialItem = (id) => deleteItem(setMaterialItems, id);

    // --- Choice Handlers ---
    
    const handleTaskToggle = (category, taskId) => {
        const currentTasks = projectChoices[category] || [];
        const isSelected = currentTasks.includes(taskId);
        const newTasks = isSelected ? currentTasks.filter(t => t !== taskId) : [...currentTasks, taskId];
        setProjectChoices(prev => ({ ...prev, [category]: newTasks }));

        const taskData = COST_DATA[taskId];
        if (!taskData) return;

        const currentLabor = laborItems[category] || [];
        const currentMaterials = materialItems[category] || [];

        if (isSelected) { // Deselecting
            if (taskData.labor) {
                const newLabor = currentLabor.filter(item => !taskData.labor.some(l => l.id === item.id));
                setLaborItems(prev => ({ ...prev, [category]: newLabor }));
            }
            if (taskData.materials) {
                const newMaterials = currentMaterials.filter(item => !taskData.materials.some(m => m.id === item.id));
                setMaterialItems(prev => ({ ...prev, [category]: newMaterials }));
            }
        } else { // Selecting
            if (taskData.labor) {
                const newLabor = [...currentLabor, ...JSON.parse(JSON.stringify(taskData.labor))];
                setLaborItems(prev => ({ ...prev, [category]: newLabor }));
            }
            if (taskData.materials) {
                const newMaterials = [...currentMaterials, ...JSON.parse(JSON.stringify(taskData.materials))];
                setMaterialItems(prev => ({ ...prev, [category]: newMaterials }));
            }
        }
    };

    const handlePlywoodThicknessChange = (newThickness) => {
        setProjectChoices(prev => ({ ...prev, plywoodThickness: newThickness }));
        setMaterialItems(prev => {
            const newItems = JSON.parse(JSON.stringify(prev));
            const plywoodItem = (newItems.floor || []).find(item => item.id === 'mat-plywood-subfloor');
            if (plywoodItem) {
                const plywoodData = COST_DATA.install_plywood.materials.find(m => m.id === 'mat-plywood-subfloor');
                const thicknessData = plywoodData.thicknessOptions[newThickness];
                if (thicknessData) {
                    plywoodItem.name = thicknessData.name;
                    plywoodItem.price = thicknessData.price;
                }
            }
            return newItems;
        });
    };
    
    const handleNotesChange = (notes) => {
        setProjectChoices(prev => ({ ...prev, notes }));
    };

    const renderActiveView = () => {
        if (!isAuthReady) {
            return <div className="text-center p-8"><p className="text-slate-500 mt-4">Initializing and authenticating...</p></div>;
        }
        switch (activeView) {
            case 'structural': return <StructuralView choices={projectChoices} onTaskToggle={handleTaskToggle} onPlywoodChange={handlePlywoodThicknessChange} onNotesChange={handleNotesChange} />;
            case 'labor': return <ItemListView title="Labor Costs" itemType="labor" itemsByCategory={laborItems} onUpdateItem={updateLaborItem} onAddItem={addLaborItem} onDeleteItem={deleteLaborItem} />;
            case 'materials': return <ItemListView title="Material List" itemType="material" itemsByCategory={materialItems} onUpdateItem={updateMaterialItem} onAddItem={addMaterialItem} onDeleteItem={deleteMaterialItem} />;
            case 'estimate': return <EstimateView laborItems={laborItems} materialItems={materialItems} notes={projectChoices.notes} taxRate={taxRate} setTaxRate={setTaxRate} contingencyRate={contingencyRate} setContingencyRate={setContingencyRate} />;
            default: return <StructuralView choices={projectChoices} onTaskToggle={handleTaskToggle} onPlywoodChange={handlePlywoodThicknessChange} onNotesChange={handleNotesChange} />;
        }
    };
    
    const renderCategoryView = () => {
        let viewContent;
        switch (activeCategory) {
            case 'structural': viewContent = renderActiveView(); break;
            case 'demolition': viewContent = <PlaceholderView title="Demolition" />; break;
            case 'shower_walls': viewContent = <PlaceholderView title="Shower Walls" />; break;
            case 'shower_base': viewContent = <PlaceholderView title="Shower Base" />; break;
            case 'floors': viewContent = <PlaceholderView title="Floors" />; break;
            case 'finishings': viewContent = <PlaceholderView title="Finishings" />; break;
            case 'trade': viewContent = <PlaceholderView title="Trade" />; break;
            default: viewContent = <PlaceholderView title="Coming Soon" />;
        }
        return (
            <div className="overflow-hidden flex flex-col" style={{ minHeight: '70vh' }}>
                <div className="p-6 sm:p-8 flex-grow">{viewContent}</div>
            </div>
        );
    };

    return (
        <div className="min-h-screen bg-slate-50 font-sans flex flex-col items-center pt-32 px-4">
            <TopNavBar activeCategory={activeCategory} setActiveCategory={setActiveCategory} />
            <div className="w-full max-w-3xl mx-auto pb-24">
                {renderCategoryView()}
                <footer className="text-center mt-10 text-sm text-slate-400"><p>Powered by Gemini</p></footer>
            </div>
            <BottomNavBar activeView={activeView} setActiveView={setActiveView} />
            <style>{`
                @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
                body { font-family: 'Inter', sans-serif; }
                .no-scrollbar::-webkit-scrollbar { display: none; }
                .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
                .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
                @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
                .safe-area-padding { padding-bottom: env(safe-area-inset-bottom); }
                .tab-scrollbar::-webkit-scrollbar { height: 4px; }
                .tab-scrollbar::-webkit-scrollbar-thumb { background-color: #e2e8f0; border-radius: 10px; }
                .tab-scrollbar::-webkit-scrollbar-track { background: transparent; }
            `}</style>
        </div>
    );
};

export default App;

