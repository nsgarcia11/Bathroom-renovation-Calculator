import React, { useState, useEffect, useRef } from 'react';

// --- Configuration ---
// Centralized configuration for rates, hours, and other constants for easy updates.
const CONFIG = {
    DEFAULT_LABOR_RATE: '85',
    SPECIALTY_LABOR_RATE: '100',
    VANITY_BASE_HOURS: 4, // Updated based on research
    VANITY_SINK_ADDON_HOURS: 1, // Adjusted proportionally
    FAUCET_INSTALL_HOURS: 1.5, // Aligned with research
    LIGHT_FIXTURE_INSTALL_HOURS: 1, // Aligned with research
    PAINT_COVERAGE_SQFT_PER_GALLON: 400,
    BASEBOARD_WASTE_FACTOR: 1.1, // 10% waste
    TILE_WASTE_FACTOR: 1.15, // 15% waste for tile
    THINSET_COVERAGE_SQFT_PER_BAG: 80, // Standard 50lb bag
    GROUT_COVERAGE_SQFT_PER_BOX: 90, // Standard small box
    WAINSCOTING_LABOR_SQFT_PER_HOUR: 15,
    TILE_LABOR_SQFT_PER_HOUR: 10,
};


// --- Helper Components ---

const OptionToggle = ({ label, isEnabled, onToggle }) => (
    <label className="flex items-center justify-between cursor-pointer">
        <span className="text-sm font-semibold text-slate-700">{label}</span>
        <div className="relative inline-flex items-center">
            <input type="checkbox" checked={isEnabled} onChange={onToggle} className="sr-only peer" />
            <div className="w-11 h-6 bg-gray-200 rounded-full peer border-2 border-blue-300 peer-checked:bg-blue-600 peer-checked:border-blue-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all"></div>
        </div>
    </label>
);

const QuantityInput = ({ label, value, onChange }) => (
    <div className="flex items-center justify-between">
        <label className="text-sm text-slate-600">{label}</label>
        <input 
            type="number" 
            value={value}
            onChange={e => onChange(parseInt(e.target.value, 10) || 1)}
            className="w-16 p-1.5 text-center border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            min="1"
        />
    </div>
);

const PerformedByToggle = ({ performedBy, onToggle }) => {
    // Base classes for both buttons
    const baseClasses = "px-4 py-1.5 rounded-full text-sm font-semibold transition-colors";
    // Classes for the active button
    const activeClasses = "bg-blue-600 text-white";
    // Classes for the inactive button
    const inactiveClasses = "bg-slate-200 text-slate-700 hover:bg-slate-300";

    return (
        <div className="flex items-center justify-center space-x-2">
            <button
                onClick={() => onToggle('me')}
                className={`${baseClasses} ${performedBy === 'me' ? activeClasses : inactiveClasses}`}
            >
                Me
            </button>
            <button
                onClick={() => onToggle('trade')}
                className={`${baseClasses} ${performedBy === 'trade' ? activeClasses : inactiveClasses}`}
            >
                Trade
            </button>
        </div>
    );
};

const ConfigurableTask = ({ label, isEnabled, onToggle, children }) => (
    <div>
        <OptionToggle label={label} isEnabled={isEnabled} onToggle={onToggle} />
        {isEnabled && (
            <div className="pl-6 pt-3 mt-2 ml-5 space-y-3 border-l-2 border-slate-200 animate-fade-in">
                {children}
            </div>
        )}
    </div>
);

const CollapsibleCard = ({ title, subtitle, children, defaultOpen = false, onDelete }) => {
    const [isOpen, setIsOpen] = useState(defaultOpen);

    return (
        <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
            <div className="flex justify-between items-center p-4">
                <button 
                    onClick={() => setIsOpen(!isOpen)}
                    className="flex-grow text-left"
                >
                    <p className="font-semibold text-slate-800">{title}</p>
                    {subtitle && <p className="text-xs text-slate-500">{subtitle}</p>}
                </button>
                <div className="flex items-center">
                    {onDelete && (
                         <button onClick={onDelete} className="p-2 rounded-full text-red-500 hover:bg-red-100 transition-colors">
                             <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                         </button>
                    )}
                    <button onClick={() => setIsOpen(!isOpen)}>
                        <svg className={`w-5 h-5 text-blue-500 transform transition-transform ${isOpen ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                </div>
            </div>
            {isOpen && (
                <div className="p-4 pt-0 animate-fade-in">
                    <div className="border-t border-slate-200 pt-4">
                        {children}
                    </div>
                </div>
            )}
        </div>
    );
};

const Modal = ({ isOpen, onClose, title, children }) => {
    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4 animate-fade-in-fast">
            <div className="bg-slate-100 rounded-2xl shadow-xl w-full max-w-lg">
                <div className="flex justify-between items-center p-4 border-b border-slate-200">
                    <h3 className="text-lg font-bold text-slate-800">{title}</h3>
                    <button onClick={onClose} className="p-1 rounded-full hover:bg-slate-200 transition-colors">
                        <svg className="w-6 h-6 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div className="p-6 max-h-[70vh] overflow-y-auto">
                    {children}
                </div>
            </div>
        </div>
    );
};

const InfoMessage = ({ message, onClose }) => (
    <div className="text-red-600 flex justify-between items-center my-2 animate-fade-in">
        <div className="flex items-center">
            <svg className="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <p className="text-xs">{message}</p>
        </div>
        <button onClick={onClose} className="p-1 rounded-full hover:bg-slate-200 transition-colors">
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
    </div>
);


// --- View Components ---

const DesignView = ({ 
    designChoices, setDesignChoices,
    finishingsScope, setFinishingsScope,
    accentWalls, setAccentWalls
}) => {
    
    const [showPlumbingTradeMessage, setShowPlumbingTradeMessage] = useState(false);
    const [showElectricalTradeMessage, setShowElectricalTradeMessage] = useState(false);

    // --- HANDLERS ---
    const handleDimensionChange = (field, value) => {
        setDesignChoices(prev => ({ ...prev, dimensions: { ...prev.dimensions, [field]: value } }));
    };

    const handleScopeChange = (key, field, value) => {
        setFinishingsScope(prev => ({
            ...prev,
            [key]: { ...prev[key], [field]: value }
        }));
    };

    const handleCategoryPerformedByChange = (category, value) => {
        setFinishingsScope(prev => ({ ...prev, [category]: value }));
        if (value === 'trade') {
            if (category === 'plumbingPerformedBy') setShowPlumbingTradeMessage(true);
            if (category === 'electricalPerformedBy') setShowElectricalTradeMessage(true);
        } else {
            if (category === 'plumbingPerformedBy') setShowPlumbingTradeMessage(false);
            if (category === 'electricalPerformedBy') setShowElectricalTradeMessage(false);
        }
    };

    // --- Accent Wall Handlers ---
    const handleAddAccentWall = () => {
        const newWall = {
            id: `aw-${Date.now()}`,
            dimensions: { width: '', height: '' },
            finishType: 'tile'
        };
        setAccentWalls(prev => [...prev, newWall]);
    };

    const handleDeleteAccentWall = (id) => {
        setAccentWalls(prev => prev.filter(wall => wall.id !== id));
    };

    const handleAccentWallChange = (id, field, value) => {
        setAccentWalls(prev => prev.map(wall => {
            if (wall.id === id) {
                if (field === 'width' || field === 'height') {
                    return { ...wall, dimensions: { ...wall.dimensions, [field]: value } };
                }
                return { ...wall, [field]: value };
            }
            return wall;
        }));
    };
    
    return (
        <div className="space-y-4">
            <CollapsibleCard title="Measurements" subtitle="Enter the dimensions of the whole bathroom." defaultOpen={true}>
                <div className="grid grid-cols-3 gap-4">
                    <div>
                        <label className="block text-sm font-semibold text-slate-700 mb-1.5">Width (in)</label>
                        <input type="number" value={designChoices.dimensions.width} onChange={(e) => handleDimensionChange('width', e.target.value)} placeholder="e.g., 60" className="w-full p-2.5 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    </div>
                    <div>
                        <label className="block text-sm font-semibold text-slate-700 mb-1.5">Length (in)</label>
                        <input type="number" value={designChoices.dimensions.length} onChange={(e) => handleDimensionChange('length', e.target.value)} placeholder="e.g., 96" className="w-full p-2.5 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    </div>
                    <div>
                        <label className="block text-sm font-semibold text-slate-700 mb-1.5">Height (in)</label>
                        <input type="number" value={designChoices.dimensions.height} onChange={(e) => handleDimensionChange('height', e.target.value)} placeholder="e.g., 96" className="w-full p-2.5 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    </div>
                </div>
            </CollapsibleCard>

            <CollapsibleCard title="Painting" subtitle="Prep, Prime & Paint">
                <div className="pl-4 space-y-3">
                    <OptionToggle label="Drywall Repairs" isEnabled={finishingsScope.fixWalls.selected} onToggle={() => handleScopeChange('fixWalls', 'selected', !finishingsScope.fixWalls.selected)} />
                    <OptionToggle label="Priming" isEnabled={finishingsScope.priming.selected} onToggle={() => handleScopeChange('priming', 'selected', !finishingsScope.priming.selected)} />
                    <OptionToggle label="Paint Walls" isEnabled={finishingsScope.paintWalls.selected} onToggle={() => handleScopeChange('paintWalls', 'selected', !finishingsScope.paintWalls.selected)} />
                    <OptionToggle label="Paint Ceiling" isEnabled={finishingsScope.paintCeiling.selected} onToggle={() => handleScopeChange('paintCeiling', 'selected', !finishingsScope.paintCeiling.selected)} />
                    <OptionToggle label="Paint Trim" isEnabled={finishingsScope.paintTrim.selected} onToggle={() => handleScopeChange('paintTrim', 'selected', !finishingsScope.paintTrim.selected)} />
                    <OptionToggle label="Paint Door" isEnabled={finishingsScope.paintDoor.selected} onToggle={() => handleScopeChange('paintDoor', 'selected', !finishingsScope.paintDoor.selected)} />
                </div>
            </CollapsibleCard>

            <CollapsibleCard title="Accent Wall" subtitle="Add and configure custom wall finishes" defaultOpen={true}>
                <div className="space-y-3">
                    {accentWalls.map((wall, index) => (
                        <div key={wall.id} className="p-4 bg-slate-50 rounded-lg border border-slate-200">
                            <div className="flex justify-between items-center mb-3">
                                <p className="font-semibold text-slate-700">Accent Wall {index + 1}</p>
                                <button onClick={() => handleDeleteAccentWall(wall.id)} className="p-1 text-red-500 hover:text-red-700">
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                </button>
                            </div>
                            <div className="space-y-4">
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-xs font-medium text-slate-600 mb-1">Wall Width (in)</label>
                                        <input type="number" value={wall.dimensions.width} onChange={(e) => handleAccentWallChange(wall.id, 'width', e.target.value)} placeholder="e.g., 96" className="w-full p-2 border border-slate-300 rounded-lg" />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-medium text-slate-600 mb-1">Wall Height (in)</label>
                                        <input type="number" value={wall.dimensions.height} onChange={(e) => handleAccentWallChange(wall.id, 'height', e.target.value)} placeholder="e.g., 96" className="w-full p-2 border border-slate-300 rounded-lg" />
                                    </div>
                                </div>

                                <div className="space-y-2">
                                    <label className="text-xs font-medium text-slate-600">Finish Type</label>
                                    <div className="flex items-center space-x-2">
                                        <button onClick={() => handleAccentWallChange(wall.id, 'finishType', 'tile')} className={`px-4 py-1.5 rounded-full text-sm font-semibold transition-colors ${wall.finishType === 'tile' ? 'bg-blue-600 text-white' : 'bg-slate-200 text-slate-700 hover:bg-slate-300'}`}>Tile</button>
                                        <button onClick={() => handleAccentWallChange(wall.id, 'finishType', 'wainscot')} className={`px-4 py-1.5 rounded-full text-sm font-semibold transition-colors ${wall.finishType === 'wainscot' ? 'bg-blue-600 text-white' : 'bg-slate-200 text-slate-700 hover:bg-slate-300'}`}>Wainscot</button>
                                        <button onClick={() => handleAccentWallChange(wall.id, 'finishType', 'paint')} className={`px-4 py-1.5 rounded-full text-sm font-semibold transition-colors ${wall.finishType === 'paint' ? 'bg-blue-600 text-white' : 'bg-slate-200 text-slate-700 hover:bg-slate-300'}`}>Paint</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ))}
                    <button 
                        onClick={handleAddAccentWall}
                        className="w-full flex items-center justify-center gap-2 py-2.5 px-4 bg-teal-100 hover:bg-teal-200 text-teal-800 font-semibold rounded-lg transition-colors border border-teal-200"
                    >
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        Add Accent Wall
                    </button>
                </div>
            </CollapsibleCard>
            
            <CollapsibleCard title="Installation" subtitle="Plumbing, Electrical & Mounting">
                <div className="pl-4 space-y-4">
                    <div>
                        <div className="flex justify-between items-center mb-2">
                            <p className="text-sm font-semibold text-slate-600">Plumbing</p>
                            <PerformedByToggle performedBy={finishingsScope.plumbingPerformedBy} onToggle={(v) => handleCategoryPerformedByChange('plumbingPerformedBy', v)} />
                        </div>
                        {showPlumbingTradeMessage && (
                            <InfoMessage 
                                message="When 'Trade' is selected, this task's labor isn't included here. Manage it on the 'Trade' screen."
                                onClose={() => setShowPlumbingTradeMessage(false)}
                            />
                        )}
                        <div className="pl-4 space-y-3">
                            <ConfigurableTask label="Vanity" isEnabled={finishingsScope.installVanity.selected} onToggle={() => handleScopeChange('installVanity', 'selected', !finishingsScope.installVanity.selected)}>
                                <QuantityInput label="Number of Sinks" value={finishingsScope.installVanity.sinks} onChange={(v) => handleScopeChange('installVanity', 'sinks', v)} />
                            </ConfigurableTask>
                            <ConfigurableTask label="Sink Faucet(s)" isEnabled={finishingsScope.installSinkFaucet.selected} onToggle={() => handleScopeChange('installSinkFaucet', 'selected', !finishingsScope.installSinkFaucet.selected)}>
                                <QuantityInput label="Number of Faucets" value={finishingsScope.installSinkFaucet.quantity} onChange={(v) => handleScopeChange('installSinkFaucet', 'quantity', v)} />
                            </ConfigurableTask>
                            <OptionToggle label="Shower Drain/Overflow" isEnabled={finishingsScope.installShowerDrain.selected} onToggle={() => handleScopeChange('installShowerDrain', 'selected', !finishingsScope.installShowerDrain.selected)} />
                            <OptionToggle label="Tub Drain/Overflow" isEnabled={finishingsScope.installTubDrain.selected} onToggle={() => handleScopeChange('installTubDrain', 'selected', !finishingsScope.installTubDrain.selected)} />
                            <OptionToggle label="Toilet" isEnabled={finishingsScope.installToilet.selected} onToggle={() => handleScopeChange('installToilet', 'selected', !finishingsScope.installToilet.selected)} />
                        </div>
                    </div>
                     <div className="pt-3 border-t border-slate-200">
                        <div className="flex justify-between items-center mb-2">
                            <p className="text-sm font-semibold text-slate-600">Electrical</p>
                            <PerformedByToggle performedBy={finishingsScope.electricalPerformedBy} onToggle={(v) => handleCategoryPerformedByChange('electricalPerformedBy', v)} />
                        </div>
                        {showElectricalTradeMessage && (
                            <InfoMessage 
                                message="When 'Trade' is selected, this task's labor isn't included here. Manage it on the 'Trade' screen."
                                onClose={() => setShowElectricalTradeMessage(false)}
                            />
                        )}
                        <div className="pl-4 space-y-3">
                            <ConfigurableTask label="Light Fixtures" isEnabled={finishingsScope.installLights.selected} onToggle={() => handleScopeChange('installLights', 'selected', !finishingsScope.installLights.selected)}>
                                <QuantityInput label="Number of Fixtures" value={finishingsScope.installLights.quantity} onChange={(v) => handleScopeChange('installLights', 'quantity', v)} />
                            </ConfigurableTask>
                            <OptionToggle label="Exhaust Fan" isEnabled={finishingsScope.installFan.selected} onToggle={() => handleScopeChange('installFan', 'selected', !finishingsScope.installFan.selected)} />
                        </div>
                    </div>
                    <div className="pt-3 border-t border-slate-200">
                        <p className="text-sm font-semibold text-slate-600 mb-2">Carpentry & Mounting</p>
                        <div className="pl-4 space-y-3">
                            <OptionToggle label="Baseboard" isEnabled={finishingsScope.installBaseboard.selected} onToggle={() => handleScopeChange('installBaseboard', 'selected', !finishingsScope.installBaseboard.selected)} />
                            <OptionToggle label="Door" isEnabled={finishingsScope.installDoor.selected} onToggle={() => handleScopeChange('installDoor', 'selected', !finishingsScope.installDoor.selected)} />
                            <OptionToggle label="Shower Door" isEnabled={finishingsScope.installShowerDoor.selected} onToggle={() => handleScopeChange('installShowerDoor', 'selected', !finishingsScope.installShowerDoor.selected)} />
                            <OptionToggle label="Mirror" isEnabled={finishingsScope.installMirror.selected} onToggle={() => handleScopeChange('installMirror', 'selected', !finishingsScope.installMirror.selected)} />
                            <OptionToggle label="Bathroom Accessories" isEnabled={finishingsScope.installAccessories.selected} onToggle={() => handleScopeChange('installAccessories', 'selected', !finishingsScope.installAccessories.selected)} />
                        </div>
                    </div>
                </div>
            </CollapsibleCard>
        </div>
    );
};


const MaterialsView = ({ constructionMaterials, designMaterials, setDesignMaterials, onPriceChange }) => {
    const handleAddDesignMaterial = () => {
      setDesignMaterials(prev => [...prev, { id: `custom-${Date.now()}`, name: "", unit: "each", price: "", quantity: "1" }]);
    };

    const handleDesignMaterialChange = (id, field, value) => {
        setDesignMaterials(prev => prev.map(mat => mat.id === id ? { ...mat, [field]: value } : mat));
    };
    
    const handleDeleteDesignMaterial = (id) => {
      setDesignMaterials(prev => prev.filter(mat => mat.id !== id));
    };

    const constructionTotal = constructionMaterials.reduce((sum, item) => sum + (parseFloat(item.quantity) || 0) * (parseFloat(item.price) || 0), 0);
    const designTotal = designMaterials.reduce((sum, item) => sum + (parseFloat(item.quantity) || 0) * (parseFloat(item.price) || 0), 0);
    const total = constructionTotal + designTotal;

    // Group materials by category
    const groupedMaterials = constructionMaterials.reduce((acc, item) => {
        const category = item.category || 'Other';
        if (!acc[category]) {
            acc[category] = [];
        }
        acc[category].push(item);
        return acc;
    }, {});

    const renderMaterialItem = (material) => (
         <div key={material.id} className="p-4 bg-white rounded-lg border border-slate-300">
            <div className="flex items-center gap-2 mb-2">
                <input type="text" value={material.name} placeholder="Material Name" readOnly className={`w-full p-1 text-slate-700 font-semibold border-b-2 border-transparent focus:outline-none bg-transparent`} />
            </div>
            <div className="grid grid-cols-3 gap-4">
                <div>
                    <label className="text-xs text-slate-500">Quantity</label>
                    <input type="number" value={material.quantity} readOnly placeholder="0" className="w-full p-2 text-center border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
                </div>
                 <div>
                    <label className="text-xs text-slate-500">Price/Unit ($)</label>
                    <input 
                        type="number" 
                        value={material.price} 
                        onChange={(e) => onPriceChange(material.id, e.target.value)}
                        placeholder="0.00" 
                        className="w-full p-2 text-center border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" 
                    />
                </div>
                <div>
                    <label className="text-xs text-slate-500">Total</label>
                     <p className="w-full p-2 text-center font-semibold text-slate-800">${((parseFloat(material.quantity) || 0) * (parseFloat(material.price) || 0)).toFixed(2)}</p>
                </div>
            </div>
        </div>
    );

    return (
        <div className="space-y-6">
            <div className="flex justify-between items-center mb-3">
                <h2 className="text-2xl font-bold text-slate-800">Materials</h2>
                <p className="font-bold text-blue-600 text-lg">${total.toFixed(2)}</p>
            </div>
            
            <div className="space-y-4">
                {Object.entries(groupedMaterials).map(([category, materials]) => {
                    if (materials.length === 0) return null;
                    return (
                        <CollapsibleCard key={category} title={`${category} Materials`} subtitle={`${materials.length} items`}>
                            <div className="space-y-2">
                                {materials.map(m => renderMaterialItem(m))}
                            </div>
                        </CollapsibleCard>
                    );
                })}


                <CollapsibleCard title="Design Materials" subtitle={`${designMaterials.length} items`} defaultOpen={true}>
                    <div className="space-y-2">
                        {designMaterials.map(m => (
                             <div key={m.id} className="p-4 bg-white rounded-lg border border-slate-300">
                                <div className="flex items-center gap-2 mb-2">
                                    <input type="text" value={m.name} onChange={(e) => handleDesignMaterialChange(m.id, 'name', e.target.value)} placeholder="Material Name" className={`w-full p-1 text-slate-700 font-semibold border-b-2 border-slate-200 focus:border-blue-500 focus:outline-none bg-transparent`} />
                                    <button onClick={() => handleDeleteDesignMaterial(m.id)} className="text-red-500 hover:text-red-700 p-1">
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                    </button>
                                </div>
                                <div className="grid grid-cols-3 gap-4">
                                    <div>
                                        <label className="text-xs text-slate-500">Quantity</label>
                                        <input type="number" value={m.quantity} onChange={(e) => handleDesignMaterialChange(m.id, 'quantity', e.target.value)} placeholder="0" className="w-full p-2 text-center border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                    </div>
                                    <div>
                                        <label className="text-xs text-slate-500">Price/Unit ($)</label>
                                        <input type="number" value={m.price} onChange={(e) => handleDesignMaterialChange(m.id, 'price', e.target.value)} placeholder="0.00" className="w-full p-2 text-center border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                    </div>
                                    <div>
                                        <label className="text-xs text-slate-500">Total</label>
                                        <p className="w-full p-2 text-center font-semibold text-slate-800">${((parseFloat(m.quantity) || 0) * (parseFloat(m.price) || 0)).toFixed(2)}</p>
                                    </div>
                                </div>
                            </div>
                        ))}
                        <button onClick={handleAddDesignMaterial} className="w-full mt-2 flex items-center justify-center gap-2 py-2.5 px-4 bg-green-100 hover:bg-green-200 text-green-800 font-semibold rounded-lg transition-colors border border-green-200">
                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                            Add Design Material
                        </button>
                    </div>
                </CollapsibleCard>
            </div>
        </div>
    );
};

const LaborView = ({ laborItems, handleAddLaborItem, handleLaborItemChange, handleDeleteLaborItem }) => {
    const total = laborItems.reduce((sum, item) => sum + (parseFloat(item.hours) || 0) * (parseFloat(item.rate) || 0), 0);

    const groupedLabor = laborItems.reduce((acc, item) => {
        const category = item.category || 'Custom';
        if (!acc[category]) acc[category] = [];
        acc[category].push(item);
        return acc;
    }, {});

    const renderLaborItem = (item) => {
        const isCustom = !item.category;
        return (
            <div key={item.id} className="p-4 bg-white rounded-lg border border-slate-300">
                <div className="flex items-center gap-2 mb-2">
                     <input 
                        type="text" 
                        value={item.name} 
                        readOnly={!isCustom}
                        onChange={isCustom ? (e) => handleLaborItemChange(item.id, 'name', e.target.value) : undefined}
                        placeholder="Custom Task Name"
                        className={`w-full p-1 text-slate-700 font-semibold border-b-2 ${isCustom ? 'border-slate-200 focus:border-blue-500' : 'border-transparent'} focus:outline-none bg-transparent`}
                     />
                    <button onClick={() => handleDeleteLaborItem(item.id)} className="p-1 text-red-500 hover:text-red-700">
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    </button>
                </div>
                <div className="grid grid-cols-3 gap-4">
                    <div>
                        <label className="text-xs text-slate-500">Hours</label>
                        <input 
                            type="number" 
                            value={item.hours} 
                            readOnly={!isCustom}
                            onChange={isCustom ? (e) => handleLaborItemChange(item.id, 'hours', e.target.value) : undefined}
                            placeholder="0" 
                            className="w-full p-2 text-center border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" 
                        />
                    </div>
                     <div>
                        <label className="text-xs text-slate-500">Rate ($/hr)</label>
                        <input type="number" value={item.rate} onChange={(e) => handleLaborItemChange(item.id, 'rate', e.target.value)} placeholder="0" className="w-full p-2 text-center border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    </div>
                    <div>
                        <label className="text-xs text-slate-500">Total</label>
                         <p className="w-full p-2 text-center font-semibold text-slate-800">${((parseFloat(item.hours) || 0) * (parseFloat(item.rate) || 0)).toFixed(2)}</p>
                    </div>
                </div>
            </div>
        );
    };

    return (
        <div className="space-y-6">
            <div className="flex justify-between items-center mb-3">
                 <h2 className="text-2xl font-bold text-slate-800">Labor</h2>
                 <p className="font-bold text-blue-600 text-lg">${total.toFixed(2)}</p>
            </div>
            
            <div className="space-y-4">
                 {Object.entries(groupedLabor).map(([category, labor]) => {
                    if (labor.length === 0) return null;
                    const title = category === 'Custom' ? "Custom Labor" : `${category} Labor`;
                    const isCustomCategory = category === 'Custom';
                    return (
                        <CollapsibleCard key={category} title={title} subtitle={`${labor.length} tasks`} defaultOpen={isCustomCategory}>
                            <div className="space-y-3">
                                {labor.map(renderLaborItem)}
                                {isCustomCategory && (
                                    <button onClick={handleAddLaborItem} className="w-full mt-2 flex items-center justify-center gap-2 py-2.5 px-4 bg-purple-100 hover:bg-purple-200 text-purple-800 font-semibold rounded-lg transition-colors border border-purple-200">
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                        Add Custom Labor Task
                                    </button>
                                )}
                            </div>
                        </CollapsibleCard>
                    )
                 })}
            </div>
        </div>
    );
};

const EstimateView = ({ laborItems, constructionMaterials, designMaterials, tradeItems }) => {
    // --- Calculations ---
    const constructionTotal = constructionMaterials.reduce((sum, item) => sum + (parseFloat(item.quantity) || 0) * (parseFloat(item.price) || 0), 0);
    const designTotal = designMaterials.reduce((sum, item) => sum + (parseFloat(item.quantity) || 0) * (parseFloat(item.price) || 0), 0);
    const materialsTotal = constructionTotal + designTotal;

    const laborTotal = laborItems.reduce((sum, item) => sum + (parseFloat(item.hours) || 0) * (parseFloat(item.rate) || 0), 0);
    const tradeTotal = tradeItems.reduce((sum, item) => sum + (parseFloat(item.cost) || 0), 0);

    const grandTotal = materialsTotal + laborTotal + tradeTotal;

    // --- Helper to render line items ---
    const renderLineItem = (label, value, isBold = false) => (
        <div className={`flex justify-between items-center py-2 ${isBold ? 'font-bold' : ''}`}>
            <span className={isBold ? 'text-slate-800' : 'text-slate-600'}>{label}</span>
            <span className={isBold ? 'text-slate-900' : 'text-slate-700'}>${value.toFixed(2)}</span>
        </div>
    );

    return (
        <div className="space-y-6">
            <div className="text-center">
                 <h2 className="text-3xl font-bold text-slate-800">Project Estimate</h2>
                 <p className="text-slate-500 mt-1">A detailed breakdown of all project costs.</p>
            </div>

            <div className="p-6 bg-white rounded-xl border border-slate-200 shadow-sm space-y-4">
                <h3 className="text-lg font-semibold text-slate-800 border-b pb-2">Cost Summary</h3>
                <div className="space-y-1 text-sm">
                    {renderLineItem("Construction Materials", constructionTotal)}
                    {renderLineItem("Design Materials", designTotal)}
                    <div className="border-t pt-2 mt-1">
                        {renderLineItem("Total Materials", materialsTotal, true)}
                    </div>
                </div>
                 <div className="space-y-1 text-sm pt-2">
                    {renderLineItem("My Labor", laborTotal, true)}
                    {renderLineItem("Trade Costs", tradeTotal, true)}
                </div>
                 <div className="border-t-2 border-slate-300 pt-3 mt-3">
                    <div className="flex justify-between items-center text-lg font-bold">
                        <span className="text-slate-900">Grand Total</span>
                        <span className="text-blue-600">${grandTotal.toFixed(2)}</span>
                    </div>
                </div>
            </div>

             <div className="text-center print-hide">
                <button
                    onClick={() => window.print()}
                    className="mt-4 px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition-colors"
                >
                    Print Estimate
                </button>
            </div>
        </div>
    );
};


const ProjectActionsView = ({
    projectNotes,
    setProjectNotes,
    materialsTotal,
    laborTotal,
    tradeTotal,
    grandTotal,
}) => {
    return (
        <div className="space-y-6">
            <CollapsibleCard title="Project Summary" subtitle="Cost Breakdown" defaultOpen={true}>
                <div className="space-y-2 text-sm">
                    <div className="flex justify-between"><span className="text-slate-600">Materials Total:</span> <span className="font-medium">${materialsTotal.toFixed(2)}</span></div>
                    <div className="flex justify-between"><span className="text-slate-600">My Labor Total:</span> <span className="font-medium">${laborTotal.toFixed(2)}</span></div>
                    <div className="flex justify-between"><span className="text-slate-600">Trade Total:</span> <span className="font-medium">${tradeTotal.toFixed(2)}</span></div>
                    <div className="flex justify-between font-bold pt-2 border-t mt-2"><span className="text-slate-800">Grand Total:</span> <span>${grandTotal.toFixed(2)}</span></div>
                </div>
            </CollapsibleCard>

            <CollapsibleCard title="Project Notes" subtitle="All notes in one place">
                 <div className="space-y-4">
                         <div>
                            <textarea 
                                value={projectNotes} 
                                onChange={(e) => setProjectNotes(e.target.value)} 
                                placeholder="Add general project notes here..." 
                                className="w-full p-2.5 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                rows="4"
                            ></textarea>
                        </div>
                 </div>
            </CollapsibleCard>
        </div>
    );
};

const TradeView = ({ tradeItems, onAddItem, onItemChange, onDeleteItem }) => {
    const total = tradeItems.reduce((sum, item) => sum + (parseFloat(item.cost) || 0), 0);

    return (
        <div className="space-y-6">
            <CollapsibleCard title="Subcontractor Costs" subtitle={`Total: $${total.toFixed(2)}`} defaultOpen={true}>
                <div className="space-y-3">
                    {tradeItems.map(item => (
                        <div key={item.id} className="p-4 bg-slate-50 rounded-lg border border-slate-200">
                            <div className="flex items-center gap-2 mb-3">
                                <input 
                                    type="text" 
                                    value={item.name} 
                                    onChange={(e) => onItemChange(item.id, 'name', e.target.value)}
                                    placeholder="Trade Service (e.g., Plumber)" 
                                    className="w-full p-1 text-slate-800 font-semibold border-b-2 border-slate-200 focus:border-blue-500 focus:outline-none bg-transparent"
                                />
                                <button onClick={() => onDeleteItem(item.id)} className="text-red-500 hover:text-red-700 p-1 flex-shrink-0">
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                </button>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="text-xs text-slate-500">Cost ($)</label>
                                    <input 
                                        type="number" 
                                        value={item.cost} 
                                        onChange={(e) => onItemChange(item.id, 'cost', e.target.value)}
                                        placeholder="0.00" 
                                        className="w-full p-2 text-center border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    />
                                </div>
                                <div className="flex items-end">
                                    <p className="w-full p-2 text-center font-semibold text-slate-800">${(parseFloat(item.cost) || 0).toFixed(2)}</p>
                                </div>
                            </div>
                        </div>
                    ))}
                    <button 
                        onClick={onAddItem} 
                        className="w-full mt-2 flex items-center justify-center gap-2 py-2.5 px-4 bg-indigo-100 hover:bg-indigo-200 text-indigo-800 font-semibold rounded-lg transition-colors border border-indigo-200"
                    >
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        Add Trade Cost
                    </button>
                </div>
            </CollapsibleCard>
        </div>
    );
};


const TopNavBar = ({ activeCategory, setActiveCategory }) => {
    const navItems = [
        { id: 'demolition', label: 'Demolition', icon: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6 mb-1.5"><path d="m15 12-9.373 9.373a1 1 0 0 1-3.001-3L12 9"/><path d="m18 15 4-4"/><path d="m21.5 11.5-1.914-1.914A2 2 0 0 1 19 8.172v-.344a2 2 0 0 0-.586-1.414l-1.657-1.657A6 6 0 0 0 12.516 3H9l1.243 1.243A6 6 0 0 1 12 8.485V10l2 2h1.172a2 2 0 0 1 1.414.586L18.5 14.5"/></svg> },
        { id: 'shower-walls', label: 'Shower Walls', icon: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6 mb-1.5"><path d="m4 4 2.5 2.5"/><path d="M13.5 6.5a4.95 4.95 0 0 0-7 7"/><path d="M15 5 5 15"/><path d="M14 17v.01"/><path d="M10 16v.01"/><path d="M13 13v.01"/><path d="M16 10v.01"/><path d="M11 20v.01"/><path d="M17 14v.01"/><path d="M20 11v.01"/></svg> },
        { id: 'shower-base', label: 'Shower Base', icon: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6 mb-1.5"><rect width="18" height="18" x="3" y="3" rx="2"/><circle cx="12" cy="12" r="1"/></svg> },
        { id: 'floors', label: 'Floors', icon: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6 mb-1.5"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg> },
        { id: 'finishings', label: 'Finishings', icon: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6 mb-1.5"><path d="m14.622 17.897-10.68-2.913"/><path d="M18.376 2.622a1 1 0 1 1 3.002 3.002L17.36 9.643a.5.5 0 0 0 0 .707l.944.944a2.41 2.41 0 0 1 0 3.408l-.944.944a.5.5 0 0 1-.707 0L8.354 7.348a.5.5 0 0 1 0-.707l.944-.944a2.41 2.41 0 0 1 3.408 0l.944.944a.5.5 0 0 0 .707 0z"/><path d="M9 8c-1.804 2.71-3.97 3.46-6.583 3.948a.507.507 0 0 0-.302.819l7.32 8.883a1 1 0 0 0 1.185.204C12.735 20.405 16 16.792 16 15"/></svg> },
        { id: 'structural', label: 'Structural/Other', icon: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6 mb-1.5"><path d="M2 9a3 3 0 0 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 0 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/><path d="M9 12h6"/></svg> },
        { id: 'trade', label: 'Trade', icon: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6 mb-1.5"><path d="M10 10V5a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v5"/><path d="M14 6a6 6 0 0 1 6 6v3"/><path d="M4 15v-3a6 6 0 0 1 6-6"/><rect x="2" y="15" width="20" height="4" rx="1"/></svg> },
    ];

    const activeClasses = "flex flex-col items-center justify-center w-24 h-20 rounded-xl bg-white text-blue-600 shadow-md border-2 border-blue-500";
    const defaultClasses = "flex flex-col items-center justify-center w-24 h-20 rounded-xl bg-slate-100 text-slate-500 hover:bg-slate-200 transition-colors";

    return (
        <div className="fixed top-0 left-0 right-0 z-20 bg-white/80 backdrop-blur-sm shadow-sm px-4 sm:px-6 print-hide">
            <div className="max-w-xl mx-auto">
                <div className="tab-scrollbar flex space-x-4 overflow-x-auto py-3">
                    {navItems.map(item => (
                        <button key={item.id} onClick={() => setActiveCategory(item.id)} className="flex-shrink-0">
                            <div className={activeCategory === item.id ? activeClasses : defaultClasses}>
                                {item.icon}
                                <span className="text-xs font-medium">{item.label}</span>
                            </div>
                        </button>
                    ))}
                </div>
            </div>
        </div>
    );
};

const BottomNavBar = ({ activeView, setActiveView, onMenuClick }) => {
    const navItems = [
        { id: 'design', label: 'Design', icon: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6 mb-1"><path d="M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z"/></svg> },
        { id: 'labor', label: 'Labor', icon: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6 mb-1"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg> },
        { id: 'materials', label: 'Materials', icon: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6 mb-1"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg> },
        { id: 'estimate', label: 'Estimate', icon: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6 mb-1"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg> },
        { id: 'menu', label: 'Menu', icon: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6 mb-1"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg> },
    ];

    return (
        <div className="fixed bottom-0 left-0 right-0 z-20 bg-white/95 backdrop-blur-sm border-t border-slate-200 safe-area-padding print-hide">
            <div className="max-w-xl mx-auto">
                <div className="flex justify-evenly py-2">
                    {navItems.map(item => {
                        const isActive = activeView === item.id;
                        const buttonClasses = isActive
                            ? "flex flex-col items-center justify-center w-20 h-16 rounded-xl transition-colors group text-blue-600 bg-blue-100"
                            : "flex flex-col items-center justify-center w-20 h-16 rounded-xl hover:bg-slate-100 transition-colors group text-slate-600";

                        return (
                            <button
                                key={item.id}
                                onClick={() => item.id === 'menu' ? onMenuClick() : setActiveView(item.id)}
                                className={buttonClasses}
                            >
                                {item.icon}
                                <span className="text-xs font-semibold">{item.label}</span>
                            </button>
                        );
                    })}
                </div>
            </div>
        </div>
    );
};


// --- Main App Component ---
const App = () => {
  const [activeView, setActiveView] = useState('design');
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [activeCategory, setActiveCategory] = useState('finishings');
  
  // --- STATE ---
  const [designChoices, setDesignChoices] = useState({
    dimensions: { width: '60', length: '96', height: '96' },
  });
  
  const [finishingsScope, setFinishingsScope] = useState({
      fixWalls: { selected: true },
      priming: { selected: true },
      paintWalls: { selected: true },
      paintCeiling: { selected: true },
      paintTrim: { selected: false },
      paintDoor: { selected: false },
      installBaseboard: { selected: false },
      installVanity: { selected: true, sinks: 1 },
      installLights: { selected: true, quantity: 2 },
      installAccessories: { selected: false },
      installMirror: { selected: true },
      installDoor: { selected: false },
      installToilet: { selected: true },
      installFan: { selected: true },
      installSinkFaucet: { selected: true, quantity: 1 },
      installShowerFaucet: { selected: false },
      installShowerDoor: { selected: false },
      installTubDrain: { selected: false },
      installShowerDrain: { selected: false },
      plumbingPerformedBy: 'me',
      electricalPerformedBy: 'me',
  });

  const [accentWalls, setAccentWalls] = useState([
    { id: `aw-${Date.now()}`, dimensions: { width: '60', height: '96' }, finishType: 'tile' }
  ]);
  
  const [materialPriceOverrides, setMaterialPriceOverrides] = useState({});

  const [laborItems, setLaborItems] = useState([]);
  const [constructionMaterials, setConstructionMaterials] = useState([]);
  const [designMaterials, setDesignMaterials] = useState([
    { id: 'custom-1', name: "Vanity", unit: "each", price: "450", quantity: "1" },
    { id: 'custom-2', name: "Toilet", unit: "each", price: "250", quantity: "1" },
    { id: 'custom-3', name: "Light Fixture", unit: "each", price: "75", quantity: "2" },
  ]);
  const [tradeItems, setTradeItems] = useState([
      { id: 'trade-1', name: 'Plumbing Rough-in', cost: '1200' },
      { id: 'trade-2', name: 'Electrical Rough-in', cost: '950' },
  ]);
  const [projectNotes, setProjectNotes] = useState('');

  // --- Handlers ---
  const handleConstructionMaterialPriceChange = (id, newPrice) => {
    setMaterialPriceOverrides(prev => ({
        ...prev,
        [id]: newPrice,
    }));
  };
  
  // --- Trade Handlers ---
  const handleAddTradeItem = () => {
    setTradeItems(prev => [...prev, { id: `trade-custom-${Date.now()}`, name: '', cost: '' }]);
  };

  const handleDeleteTradeItem = (id) => {
      setTradeItems(prev => prev.filter(item => item.id !== id));
  };

  const handleTradeItemChange = (id, field, value) => {
      setTradeItems(prev => prev.map(item => item.id === id ? { ...item, [field]: value } : item));
  };

  // --- EFFECT: Recalculate everything when dependencies change ---
  useEffect(() => {
    // --- Basic Dimensions ---
    const { width, length, height } = designChoices.dimensions;
    const w = parseFloat(width) || 0;
    const l = parseFloat(length) || 0;
    const h = parseFloat(height) || 0;
    
    let wallArea = 0;
    let ceilingArea = 0;
    let perimeter = 0;
    
    if (w > 0 && l > 0 && h > 0) {
        wallArea = (2 * (w + l) * h) / 144;
        ceilingArea = (w * l) / 144;
        perimeter = (2 * (w + l)) / 12;
    }
    
    // --- AUTO-GENERATED LABOR ---
    const autoLabor = [];
    if (finishingsScope.fixWalls.selected) autoLabor.push({ id: 'lab-fix-walls', name: 'Drywall Repairs', hours: '4', category: 'Painting' });
    if (finishingsScope.priming.selected) autoLabor.push({ id: 'lab-priming', name: 'Priming', hours: '3', category: 'Painting' });
    if (finishingsScope.paintWalls.selected) autoLabor.push({ id: 'lab-paint-walls', name: 'Paint Walls', hours: '2', category: 'Painting' });
    if (finishingsScope.paintCeiling.selected) autoLabor.push({ id: 'lab-paint-ceiling', name: 'Paint Ceiling', hours: '2', category: 'Painting' });
    if (finishingsScope.paintTrim.selected) autoLabor.push({ id: 'lab-paint-trim', name: 'Paint Trim', hours: '1.5', category: 'Painting' });
    if (finishingsScope.paintDoor.selected) autoLabor.push({ id: 'lab-paint-door', name: 'Paint Door', hours: '1', category: 'Painting' });
    if (finishingsScope.installBaseboard.selected) autoLabor.push({ id: 'lab-baseboard', name: 'Install Baseboard', hours: '1.5', category: 'Installation' });
    if (finishingsScope.installVanity.selected && finishingsScope.plumbingPerformedBy === 'me') autoLabor.push({ id: 'lab-vanity', name: 'Install Vanity', hours: CONFIG.VANITY_BASE_HOURS + ((finishingsScope.installVanity.sinks -1) * CONFIG.VANITY_SINK_ADDON_HOURS), category: 'Installation' });
    if (finishingsScope.installSinkFaucet.selected && finishingsScope.plumbingPerformedBy === 'me') autoLabor.push({ id: 'lab-sink-faucet', name: 'Install Sink Faucet(s)', hours: CONFIG.FAUCET_INSTALL_HOURS * finishingsScope.installSinkFaucet.quantity, category: 'Installation' });
    if (finishingsScope.installLights.selected && finishingsScope.electricalPerformedBy === 'me') autoLabor.push({ id: 'lab-lights', name: 'Install Light Fixtures', hours: finishingsScope.installLights.quantity * CONFIG.LIGHT_FIXTURE_INSTALL_HOURS, category: 'Installation' });
    if (finishingsScope.installAccessories.selected) autoLabor.push({ id: 'lab-accessories', name: 'Install Bathroom Accessories', rate: CONFIG.SPECIALTY_LABOR_RATE, hours: '1.5', category: 'Installation' });
    if (finishingsScope.installMirror.selected) autoLabor.push({ id: 'lab-mirror', name: 'Install Mirror', rate: CONFIG.SPECIALTY_LABOR_RATE, hours: '1', category: 'Installation' });
    if (finishingsScope.installDoor.selected) autoLabor.push({ id: 'lab-door', name: 'Install Door', hours: '2', category: 'Installation' });
    if (finishingsScope.installShowerDoor.selected) autoLabor.push({ id: 'lab-shower-door', name: 'Install Shower Door', hours: '3', category: 'Installation' });
    if (finishingsScope.installToilet.selected && finishingsScope.plumbingPerformedBy === 'me') autoLabor.push({ id: 'lab-toilet', name: 'Install Toilet', hours: '1.5', category: 'Installation' });
    if (finishingsScope.installFan.selected && finishingsScope.electricalPerformedBy === 'me') autoLabor.push({ id: 'lab-fan', name: 'Install Exhaust Fan', hours: '4', category: 'Installation' });

    // --- AUTO-GENERATED CONSTRUCTION MATERIALS ---
    let autoMaterials = [];
    if (finishingsScope.fixWalls.selected) {
        autoMaterials.push({ id: 'mat-drywall-compound', name: 'Drywall Compound', quantity: 1, unit: 'bucket', price: '25.00', category: 'Painting' });
        autoMaterials.push({ id: 'mat-drywall-tape', name: 'Drywall Tape', quantity: 1, unit: 'roll', price: '11.00', category: 'Painting' });
    }
    if (finishingsScope.priming.selected && wallArea > 0) autoMaterials.push({ id: 'mat-primer', name: 'Wall & Ceiling Primer', quantity: Math.ceil((wallArea + ceilingArea) / CONFIG.PAINT_COVERAGE_SQFT_PER_GALLON), unit: 'gallon', price: '45.00', category: 'Painting' });
    if (finishingsScope.paintWalls.selected && wallArea > 0) autoMaterials.push({ id: 'mat-wall-paint', name: 'Wall Paint', quantity: Math.ceil(wallArea / CONFIG.PAINT_COVERAGE_SQFT_PER_GALLON), unit: 'gallon', price: '50.00', category: 'Painting' });
    if (finishingsScope.paintCeiling.selected && ceilingArea > 0) autoMaterials.push({ id: 'mat-ceiling-paint', name: 'Ceiling Paint', quantity: Math.ceil(ceilingArea / CONFIG.PAINT_COVERAGE_SQFT_PER_GALLON), unit: 'gallon', price: '40.00', category: 'Painting' });
    if (finishingsScope.paintTrim.selected) autoMaterials.push({ id: 'mat-trim-paint', name: 'Trim Paint', quantity: 1, unit: 'quart', price: '25.00', category: 'Painting' });
    if (finishingsScope.paintDoor.selected) autoMaterials.push({ id: 'mat-door-paint', name: 'Door Paint', quantity: 1, unit: 'quart', price: '25.00', category: 'Painting' });
    if (finishingsScope.installBaseboard.selected && perimeter > 0) autoMaterials.push({ id: 'mat-baseboard', name: 'Baseboard', quantity: Math.ceil(perimeter * CONFIG.BASEBOARD_WASTE_FACTOR), unit: 'linear ft', price: '1.50', category: 'Installation' });

    // --- ACCENT WALLS ---
    accentWalls.forEach((wall, index) => {
        const wallW = parseFloat(wall.dimensions.width) || 0;
        const wallH = parseFloat(wall.dimensions.height) || 0;
        if (wallW > 0 && wallH > 0) {
            const area = (wallW * wallH) / 144; // sq ft
            const category = `Accent Wall ${index + 1}`;

            if (wall.finishType === 'tile') {
                autoMaterials.push({ id: `mat-tile-${wall.id}`, name: 'Wall Tile', quantity: Math.ceil(area * CONFIG.TILE_WASTE_FACTOR), unit: 'sq ft', price: '8.00', category });
                autoMaterials.push({ id: `mat-thinset-${wall.id}`, name: 'Thinset Mortar', quantity: Math.ceil(area / CONFIG.THINSET_COVERAGE_SQFT_PER_BAG), unit: 'bag', price: '22.00', category });
                autoMaterials.push({ id: `mat-grout-${wall.id}`, name: 'Grout', quantity: Math.ceil(area / CONFIG.GROUT_COVERAGE_SQFT_PER_BOX), unit: 'box', price: '17.00', category });
                autoLabor.push({ id: `lab-tile-${wall.id}`, name: 'Install Tile', hours: (area / CONFIG.TILE_LABOR_SQFT_PER_HOUR).toFixed(2), rate: CONFIG.SPECIALTY_LABOR_RATE, category });
            }
            if (wall.finishType === 'wainscot') {
                autoMaterials.push({ id: `mat-wainscot-${wall.id}`, name: 'Wainscoting Panels', quantity: Math.ceil(area), unit: 'sq ft', price: '4.00', category });
                autoMaterials.push({ id: `mat-adhesive-${wall.id}`, name: 'Construction Adhesive', quantity: Math.ceil(area / 30), unit: 'tube', price: '8.00', category });
                autoLabor.push({ id: `lab-wainscot-${wall.id}`, name: 'Install Wainscoting', hours: (area / CONFIG.WAINSCOTING_LABOR_SQFT_PER_HOUR).toFixed(2), rate: CONFIG.DEFAULT_LABOR_RATE, category });
            }
            if (wall.finishType === 'paint') {
                autoMaterials.push({ id: `mat-accent-paint-${wall.id}`, name: 'Accent Wall Paint', quantity: Math.ceil(area / CONFIG.PAINT_COVERAGE_SQFT_PER_GALLON), unit: 'gallon', price: '75.00', category });
                autoLabor.push({ id: `lab-accent-paint-${wall.id}`, name: 'Paint Accent Wall', hours: (area / 150).toFixed(2), rate: CONFIG.DEFAULT_LABOR_RATE, category });
            }
        }
    });
    
    // Apply price overrides
    const finalAutoMaterials = autoMaterials.map(mat => ({
        ...mat,
        price: materialPriceOverrides[mat.id] !== undefined ? materialPriceOverrides[mat.id] : mat.price
    }));

    // --- MERGE & UPDATE STATE ---
    setLaborItems(prev => {
        const customItems = prev.filter(item => !item.category);
        return [...customItems, ...autoLabor.map(item => ({ ...item, rate: item.rate || CONFIG.DEFAULT_LABOR_RATE }))];
    });

    setConstructionMaterials(finalAutoMaterials);

  }, [finishingsScope, designChoices.dimensions, accentWalls, materialPriceOverrides]);
  
  // --- Labor Handlers ---
  const handleAddLaborItem = () => {
    setLaborItems(prev => [...prev, { id: `lab-custom-${Date.now()}`, name: '', hours: '', rate: CONFIG.DEFAULT_LABOR_RATE }]);
  };

  const handleDeleteLaborItem = (id) => {
      setLaborItems(prev => prev.filter(item => item.id !== id));
  };

  const handleLaborItemChange = (id, field, value) => {
      setLaborItems(prev => prev.map(item => item.id === id ? { ...item, [field]: value } : item));
  };

  // --- Centralized Calculations for Totals ---
  const constructionTotal = constructionMaterials.reduce((sum, item) => sum + (parseFloat(item.quantity) || 0) * (parseFloat(item.price) || 0), 0);
  const designTotal = designMaterials.reduce((sum, item) => sum + (parseFloat(item.quantity) || 0) * (parseFloat(item.price) || 0), 0);
  const materialsTotal = constructionTotal + designTotal;
  const laborTotal = laborItems.reduce((sum, item) => sum + (parseFloat(item.hours) || 0) * (parseFloat(item.rate) || 0), 0);
  const tradeTotal = tradeItems.reduce((sum, item) => sum + (parseFloat(item.cost) || 0), 0);
  const grandTotal = materialsTotal + laborTotal + tradeTotal;
  
  // --- View Renderer ---
  const renderActiveView = () => {
      switch(activeView) {
          case 'design':
              return <DesignView 
                designChoices={designChoices}
                setDesignChoices={setDesignChoices}
                finishingsScope={finishingsScope}
                setFinishingsScope={setFinishingsScope}
                accentWalls={accentWalls}
                setAccentWalls={setAccentWalls}
              />;
          case 'labor':
              return <LaborView 
                laborItems={laborItems}
                handleAddLaborItem={handleAddLaborItem}
                handleLaborItemChange={handleLaborItemChange}
                handleDeleteLaborItem={handleDeleteLaborItem}
              />;
          case 'materials':
              return <MaterialsView 
                constructionMaterials={constructionMaterials}
                designMaterials={designMaterials}
                setDesignMaterials={setDesignMaterials}
                onPriceChange={handleConstructionMaterialPriceChange}
              />;
          case 'estimate':
              return <EstimateView 
                laborItems={laborItems}
                constructionMaterials={constructionMaterials}
                designMaterials={designMaterials}
                tradeItems={tradeItems}
              />;
          default:
              return <DesignView 
                designChoices={designChoices}
                setDesignChoices={setDesignChoices}
                finishingsScope={finishingsScope}
                setFinishingsScope={setFinishingsScope}
                accentWalls={accentWalls}
                setAccentWalls={setAccentWalls}
              />;
      }
  }

  const renderActiveCategory = () => {
    const categoryMap = {
      finishings: { title: "Finishings", description: "Select and configure all finishings." },
      trade: { title: "Trade Costs", description: "Manage costs for subcontractors like plumbers and electricians." },
    };
    const currentCategory = categoryMap[activeCategory] || { title: "Coming Soon", description: "This category is under construction." };

    return (
      <>
        <header className="text-left pt-2 pb-6 print-hide">
            <h1 className="text-4xl font-bold text-slate-900">{currentCategory.title}</h1>
            <p className="text-slate-500 mt-1">{currentCategory.description}</p>
        </header>
        {(() => {
            switch (activeCategory) {
                case 'finishings':
                    return <div className="space-y-4">{renderActiveView()}</div>;
                case 'trade':
                    return <TradeView 
                              tradeItems={tradeItems}
                              onAddItem={handleAddTradeItem}
                              onItemChange={handleTradeItemChange}
                              onDeleteItem={handleDeleteTradeItem}
                            />;
                default:
                    return (
                        <div className="text-center py-20 bg-white rounded-xl shadow-sm border border-slate-200">
                            <h2 className="text-2xl font-bold text-slate-700">Coming Soon!</h2>
                            <p className="text-slate-500 mt-2">The "{activeCategory}" category is under construction.</p>
                        </div>
                    );
            }
        })()}
      </>
    );
  }

  return (
    <div className="min-h-screen bg-slate-100 font-sans pb-40">
       <TopNavBar activeCategory={activeCategory} setActiveCategory={setActiveCategory} />
      <div className="w-full max-w-lg mx-auto px-4 pt-32 print-container">
        {renderActiveCategory()}
        
        <footer className="text-center mt-10 text-sm text-slate-400 print-hide">
            <p>Powered by Gemini</p>
        </footer>
      </div>
      {activeCategory === 'finishings' && 
        <BottomNavBar
            activeView={activeView}
            setActiveView={setActiveView}
            onMenuClick={() => setIsModalOpen(true)}
        />
      }
      <Modal 
        isOpen={isModalOpen} 
        onClose={() => setIsModalOpen(false)} 
        title="Project Actions"
      >
        <ProjectActionsView 
            projectNotes={projectNotes}
            setProjectNotes={setProjectNotes}
            materialsTotal={materialsTotal}
            laborTotal={laborTotal}
            tradeTotal={tradeTotal}
            grandTotal={grandTotal}
        />
      </Modal>
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
        }
        
        .safe-area-padding {
            padding-bottom: env(safe-area-inset-bottom);
        }

        .tab-scrollbar::-webkit-scrollbar {
            height: 4px;
        }
        .tab-scrollbar::-webkit-scrollbar-thumb {
            background-color: #e2e8f0; /* slate-200 */
            border-radius: 10px;
        }
        .tab-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        .animate-fade-in-fast {
            animation: fadeIn 0.15s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        /* Hide number input arrows */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
          -webkit-appearance: none; 
          margin: 0; 
        }
        input[type=number] {
          -moz-appearance: textfield;
        }
        @media print {
            body {
                background-color: #fff;
            }
            .print-hide {
                display: none;
            }
            .print-container {
                max-width: 100%;
                padding: 0;
                margin: 0;
                padding-top: 0 !important;
            }
            .bg-white {
                box-shadow: none;
                border: 1px solid #e2e8f0;
            }
        }
      `}</style>
    </div>
  );
};

export default App;



