import React, { useState, useEffect, useRef, useMemo } from 'react';
import { initializeApp } from "firebase/app";
import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "firebase/auth";
import { getFirestore, doc, onSnapshot, setDoc, setLogLevel } from "firebase/firestore";


// --- Reusable Helper Components ---

/**
 * A generic dropdown component.
 * @param {object} props - The component props.
 * @param {string} props.label - The label for the dropdown.
 * @param {Array<object>} props.options - The options for the dropdown.
 * @param {string} props.selectedOption - The currently selected option's value.
 * @param {Function} props.onSelect - The function to call when an option is selected.
 */
const Dropdown = ({ label, options, selectedOption, onSelect }) => (
    <div>
        <label className="block text-sm font-semibold text-slate-700 mb-1.5">{label}</label>
        <div className="relative">
            <select
                value={selectedOption}
                onChange={(e) => onSelect(e.target.value)}
                className="block appearance-none w-full bg-slate-50 border border-blue-300 text-slate-700 py-2.5 px-4 pr-8 rounded-lg focus:bg-white focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
                {options.map((option) => (
                    <option key={option.value} value={option.value}>{option.label}</option>
                ))}
            </select>
            <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-blue-500">
                <svg className="fill-current h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" /></svg>
            </div>
        </div>
    </div>
);

/**
 * A toggle switch for enabling/disabling an option.
 * @param {object} props - The component props.
 * @param {string} props.label - The label for the toggle.
 * @param {boolean} props.isEnabled - Whether the toggle is enabled.
 * @param {Function} props.onToggle - The function to call when the toggle is clicked.
 */
const OptionToggle = ({ label, isEnabled, onToggle }) => (
    <label className="flex items-center justify-between cursor-pointer p-4 bg-white rounded-lg border border-slate-300">
        <span className="text-sm font-semibold text-slate-700">{label}</span>
        <div className="relative inline-flex items-center">
            <div className="relative">
                <input type="checkbox" checked={isEnabled} onChange={onToggle} className="sr-only peer" />
                <div className="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-2 peer-focus:ring-blue-300 border border-blue-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-700 peer-checked:border-blue-700"></div>
            </div>
        </div>
    </label>
);

/**
 * A Yes/No toggle button group with a pill shape.
 * @param {object} props - The component props.
 * @param {string} props.label - The label for the toggle group.
 * @param {boolean} props.isSelected - Whether the "Yes" option is selected.
 * @param {Function} props.onToggle - The function to call with the new boolean value.
 */
const PillToggleButton = ({ label, isSelected, onToggle }) => (
    <div className="flex items-center justify-between p-4 bg-white rounded-lg border border-slate-300">
        <span className="text-sm font-semibold text-slate-700">{label}</span>
        <div className="flex items-center gap-2">
            <button
                onClick={() => onToggle(false)}
                className={`rounded-full px-4 py-1.5 text-sm font-semibold transition-colors ${
                    !isSelected
                        ? 'bg-blue-600 text-white'
                        : 'bg-slate-200 text-slate-700 hover:bg-slate-300'
                }`}
            >
                No
            </button>
            <button
                onClick={() => onToggle(true)}
                className={`rounded-full px-4 py-1.5 text-sm font-semibold transition-colors ${
                    isSelected
                        ? 'bg-blue-600 text-white'
                        : 'bg-slate-200 text-slate-700 hover:bg-slate-300'
                }`}
            >
                Yes
            </button>
        </div>
    </div>
);


/**
 * A reusable collapsible card component.
 * @param {object} props - The component props.
 * @param {string} props.title - The title of the card.
 * @param {boolean} props.isOpen - Whether the card is open.
 * @param {Function} props.onToggle - The function to call when the header is clicked.
 * @param {React.ReactNode} props.headerContent - Optional content to display in the header.
 * @param {React.ReactNode} props.children - The content of the card.
 */
const CollapsibleCard = ({ title, isOpen, onToggle, headerContent, children }) => (
    <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
        <div
            onClick={onToggle}
            onKeyDown={(e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); onToggle(); } }}
            role="button"
            tabIndex={0}
            aria-expanded={isOpen}
            className="w-full flex justify-between items-center p-6 text-left gap-4 cursor-pointer"
        >
            <div className="flex items-center gap-3 flex-grow">
                <h2 className="text-xl font-bold text-slate-800 flex-shrink-0">{title}</h2>
                {headerContent}
            </div>
            <svg className={`w-6 h-6 text-blue-500 transition-transform ${isOpen ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7" /></svg>
        </div>
        {isOpen && (
            <div className="p-6 pt-0 animate-fade-in">
                {children}
            </div>
        )}
    </div>
);

// --- View Components ---

const DesignView = ({ floorChoices, setFloorChoices, totalSqFt, clientSuppliesTiles, setClientSuppliesTiles, selectedPrepTasks, setSelectedPrepTasks, plywoodThickness, setPlywoodThickness, isHeatedFloor, setIsHeatedFloor, heatedFloorType, setHeatedFloorType, customHeatedFloorName, setCustomHeatedFloorName }) => {
    
    const notesRef = useRef(null);
    const constructionNotesRef = useRef(null);
    const [openSections, setOpenSections] = useState({
        measurements: true,
        design: true,
        heatedFloor: true,
        construction: true,
        designNotes: false,
        constructionNotes: false,
    });

    const toggleSection = (section) => {
        setOpenSections(prev => ({ ...prev, [section]: !prev[section] }));
    };

    // --- HANDLERS ---
    const handleDimensionChange = (field, value) => {
        setFloorChoices(prev => ({ ...prev, dimensions: { ...prev.dimensions, [field]: value } }));
    };

    const handleTileSizeChange = (field, value) => {
        setFloorChoices(prev => ({ ...prev, tileSize: { ...prev.tileSize, [field]: value } }));
    };
    
    const handleTileSizeOptionChange = (value) => {
        if (value === 'select_option') {
            setFloorChoices(prev => ({ ...prev, selectedTileSizeOption: 'select_option', tileSize: { width: '', length: '' } }));
        } else if (value !== 'custom') {
            const [width, length] = value.split('x');
            setFloorChoices(prev => ({ ...prev, selectedTileSizeOption: value, tileSize: { width, length } }));
        } else {
             setFloorChoices(prev => ({ ...prev, selectedTileSizeOption: 'custom', tileSize: { width: '', length: '' } }));
        }
    };

    const handleInputChange = (field, value) => {
        setFloorChoices(prev => ({ ...prev, [field]: value }));
    };
    
    const handleAddSide = () => {
        setFloorChoices(prev => ({
            ...prev,
            extraMeasurements: [...prev.extraMeasurements, { id: Date.now(), label: '', width: '', length: '' }]
        }));
    };

    const handleExtraMeasurementChange = (id, field, value) => {
        setFloorChoices(prev => ({ ...prev, extraMeasurements: prev.extraMeasurements.map(m => m.id === id ? { ...m, [field]: value } : m) }));
    };

    const handleDeleteMeasurement = (id) => {
        setFloorChoices(prev => ({ ...prev, extraMeasurements: prev.extraMeasurements.filter(m => m.id !== id) }));
    };
    
    const handlePrepTaskToggle = (task) => {
        setSelectedPrepTasks(prev => 
            prev.includes(task) 
                ? prev.filter(item => item !== task)
                : [...prev, task]
        );
    };
    
    const handleNoteHelperClick = (label) => {
        const currentNotes = floorChoices.notes;
        const newNote = `${label}: `;
        const updatedNotes = currentNotes ? `${currentNotes}\n${newNote}` : newNote;
        setFloorChoices(prev => ({ ...prev, notes: updatedNotes }));
        notesRef.current.focus();
    };

    // --- OPTIONS (Memoized for performance) ---
    const { tilePatternOptions, tileSizeOptions, prepAndStructuralOptions, plywoodThicknessOptions, heatedFloorOptions, noteHelpers } = useMemo(() => ({
        tilePatternOptions: [
            { value: 'select_option', label: 'Select a Pattern...' }, { value: 'stacked', label: 'Stacked' },
            { value: '1/2_offset', label: '1/2 Offset' }, { value: '1/3_offset', label: '1/3 Offset' },
            { value: 'herringbone', label: 'Herringbone' }, { value: 'other', label: 'Other...' },
        ],
        tileSizeOptions: [
            { value: 'select_option', label: 'Select a Tile Size...' }, { value: '12x24', label: '12" x 24"' },
            { value: '12x12', label: '12" x 12"' }, { value: '6x24', label: '6" x 24"' },
            { value: '24x24', label: '24" x 24"' }, { value: '6x6', label: '6" x 6"' },
            { value: 'custom', label: 'Custom Size...' },
        ],
        prepAndStructuralOptions: [
            { value: 'self_leveling', label: 'Self-Leveling' }, { value: 'ditra', label: 'Install Ditra Membrane' },
            { value: 'ditra_xl', label: 'Install Ditra XL Membrane' }, { value: 'add_plywood', label: 'Add Plywood for Subfloor support' },
            { value: 'repair_subfloor', label: 'Repair portion of subfloor' }, { value: 'repair_joist', label: 'Repair Floor Joist' },
        ],
        plywoodThicknessOptions: [
            { value: '1/2', label: '1/2"' }, { value: '5/8', label: '5/8"' }, { value: '3/4', label: '3/4"' },
        ],
        heatedFloorOptions: [
            { value: 'schluter', label: 'Schluter-DITRA-HEAT' }, { value: 'nuheat', label: 'Nuheat Cable System' },
            { value: 'custom', label: 'Custom...' },
        ],
        noteHelpers: ['Tile Direction Horizontal / vertical', 'Heated Floor', 'Tile Transition Leveling', 'Tiled baseboard', 'grout color'],
    }), []);

    return (
        <div className="space-y-6">
            <div className="pt-2">
                <h1 className="text-4xl font-bold text-slate-800 text-left">Floor</h1>
            </div>
            
            <CollapsibleCard
                title="Floor Measurements"
                isOpen={openSections.measurements}
                onToggle={() => toggleSection('measurements')}
                headerContent={
                    <div className="flex items-center justify-end w-full">
                        <span className="text-xl font-bold text-blue-600">
                            {totalSqFt.toFixed(2)} sq/ft
                        </span>
                    </div>
                }
            >
                <div className="flex items-start gap-3 -mt-4 mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-slate-400 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                        <path strokeLinecap="round" strokeLinejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <p className="text-xs text-slate-500">
                        Enter the main room dimensions to calculate materials and labor
                    </p>
                </div>
                <div className="space-y-4">
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm font-semibold text-slate-700 mb-1.5">Width (in)</label>
                            <input type="number" value={floorChoices.dimensions.width} onChange={(e) => handleDimensionChange('width', e.target.value)} placeholder="e.g., 60" className="w-full p-2.5 bg-slate-50 border border-blue-300 rounded-lg focus:bg-white focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                        </div>
                        <div>
                            <label className="block text-sm font-semibold text-slate-700 mb-1.5">Length (in)</label>
                            <input type="number" value={floorChoices.dimensions.length} onChange={(e) => handleDimensionChange('length', e.target.value)} placeholder="e.g., 96" className="w-full p-2.5 bg-slate-50 border border-blue-300 rounded-lg focus:bg-white focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                        </div>
                    </div>
                    
                    <div className="pt-4 border-t border-slate-200 space-y-3">
                        <div className="flex justify-end items-center">
                            <button onClick={handleAddSide} className="inline-flex items-center justify-center gap-1 py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold rounded-md transition-colors">
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                ADD SIDE
                            </button>
                        </div>
                        {floorChoices.extraMeasurements.map((m, index) => (
                            <div key={m.id} className="p-3 bg-slate-50 rounded-lg border border-slate-300 animate-fade-in">
                                <div className="flex justify-between items-center mb-2">
                                     <input
                                        type="text"
                                        value={m.label}
                                        placeholder="e.g., Closet"
                                        onChange={(e) => handleExtraMeasurementChange(m.id, 'label', e.target.value)}
                                        className="w-full p-1 text-slate-800 font-semibold border-b-2 border-transparent focus:border-blue-500 focus:outline-none bg-transparent"
                                    />
                                    <button onClick={() => handleDeleteMeasurement(m.id)} className="p-1 text-red-400 hover:text-red-600 hover:bg-red-100 rounded-full transition-colors">
                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" /></svg>
                                    </button>
                                </div>
                                <div className="grid grid-cols-2 gap-2 pt-2">
                                    <input type="number" value={m.width} onChange={(e) => handleExtraMeasurementChange(m.id, 'width', e.target.value)} placeholder="Width (in)" className="w-full p-2 bg-slate-50 border border-blue-300 rounded-lg focus:bg-white focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500 text-center" />
                                    <input type="number" value={m.length} onChange={(e) => handleExtraMeasurementChange(m.id, 'length', e.target.value)} placeholder="Length (in)" className="w-full p-2 bg-slate-50 border border-blue-300 rounded-lg focus:bg-white focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500 text-center" />
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            </CollapsibleCard>

            <CollapsibleCard
                title="Design"
                isOpen={openSections.design}
                onToggle={() => toggleSection('design')}
            >
                <div className="space-y-4">
                    <PillToggleButton
                        label="Will the client supply the tiles?"
                        isSelected={clientSuppliesTiles}
                        onToggle={setClientSuppliesTiles}
                    />
                    {clientSuppliesTiles && (
                        <div className="pb-4 border-b border-slate-200">
                            <p className="text-xs text-slate-500 px-1">Client-supplied tiles. Still enter tile size and pattern for grout and thinset calculation.</p>
                        </div>
                    )}
                    <Dropdown label="Tile Size" options={tileSizeOptions} selectedOption={floorChoices.selectedTileSizeOption} onSelect={handleTileSizeOptionChange} />
                     {floorChoices.selectedTileSizeOption === 'custom' && (
                        <div className="grid grid-cols-2 gap-4 pt-2 animate-fade-in">
                            <div>
                                <label className="block text-sm font-semibold text-slate-700 mb-1.5">Tile Width (in)</label>
                                <input type="number" value={floorChoices.tileSize.width} onChange={(e) => handleTileSizeChange('width', e.target.value)} placeholder="e.g., 8" className="w-full p-2.5 bg-slate-50 border border-blue-300 rounded-lg focus:bg-white focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                            </div>
                            <div>
                                <label className="block text-sm font-semibold text-slate-700 mb-1.5">Tile Length (in)</label>
                                <input type="number" value={floorChoices.tileSize.length} onChange={(e) => handleTileSizeChange('length', e.target.value)} placeholder="e.g., 8" className="w-full p-2.5 bg-slate-50 border border-blue-300 rounded-lg focus:bg-white focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                            </div>
                        </div>
                    )}
                    <Dropdown label="Tile Pattern" options={tilePatternOptions} selectedOption={floorChoices.tilePattern} onSelect={(v) => handleInputChange('tilePattern', v)} />
                    {floorChoices.tilePattern === 'stacked' && (
                        <div className="mt-2 text-red-600 text-xs animate-fade-in">
                            Note: A <strong>10% waste factor</strong> has been applied for this pattern and added to the materials list.
                        </div>
                    )}
                    {(floorChoices.tilePattern === '1/2_offset' || floorChoices.tilePattern === '1/3_offset') && (
                        <div className="mt-2 text-red-600 text-xs animate-fade-in">
                            Note: A <strong>20% waste factor</strong> has been applied for this pattern and added to the materials list.
                        </div>
                    )}
                    {floorChoices.tilePattern === 'herringbone' && (
                        <div className="mt-2 text-red-600 text-xs animate-fade-in">
                            Note: A <strong>25% waste factor</strong> has been applied for this pattern and added to the materials list.
                        </div>
                    )}
                    {floorChoices.tilePattern === 'other' && (
                        <div className="pt-2 animate-fade-in">
                            <input type="text" value={floorChoices.customPattern} onChange={(e) => handleInputChange('customPattern', e.target.value)} placeholder="Specify custom pattern..." className="w-full p-2.5 bg-slate-50 border border-blue-300 rounded-lg focus:bg-white focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                        </div>
                    )}
                    <div className="pt-4 border-t border-slate-200">
                        <button onClick={() => toggleSection('designNotes')} className="w-full flex justify-between items-center py-2">
                            <h3 className="text-lg font-bold text-blue-700">Notes</h3>
                            <svg className={`w-5 h-5 text-slate-500 transition-transform ${openSections.designNotes ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7" /></svg>
                        </button>
                        {openSections.designNotes && (
                            <div className="mt-2 animate-fade-in">
                                <textarea 
                                    ref={notesRef}
                                    value={floorChoices.notes} 
                                    onChange={(e) => handleInputChange('notes', e.target.value)} 
                                    placeholder="Add design notes..." 
                                    className="w-full p-2.5 bg-slate-50 border border-blue-300 rounded-lg focus:bg-white focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                    rows="3"
                                ></textarea>
                                <div className="flex flex-wrap gap-2 mt-2">
                                    {noteHelpers.map(helper => (
                                        <button 
                                            key={helper}
                                            onClick={() => handleNoteHelperClick(helper)}
                                            className="rounded-full px-3 py-1 text-sm font-medium bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors"
                                        >
                                            + {helper}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            </CollapsibleCard>

            <CollapsibleCard
                title="Heated Floors"
                isOpen={openSections.heatedFloor}
                onToggle={() => toggleSection('heatedFloor')}
            >
                <div className="space-y-4">
                    <OptionToggle 
                        label="Install Heated Floor System"
                        isEnabled={isHeatedFloor}
                        onToggle={() => setIsHeatedFloor(!isHeatedFloor)}
                    />
                    {isHeatedFloor && (
                        <div className="pt-3 pl-4 animate-fade-in space-y-4">
                            <p className="text-sm text-amber-800 bg-amber-100 p-3 rounded-lg">
                                <b>Important:</b> Heated floor calculations are derived from the dimensions entered in the <b>Floor Measurements</b> card. Please ensure these are accurate for the area to be heated.
                            </p>
                            <Dropdown 
                                label="System Type" 
                                options={heatedFloorOptions} 
                                selectedOption={heatedFloorType}
                                onSelect={setHeatedFloorType}
                            />
                            {heatedFloorType === 'schluter' && (
                                <p className="text-xs text-slate-500 px-1">
                                    <b>Note:</b> Costs are estimated based on standard DITRA-HEAT kits. Please verify the final price and labor hours in the Materials & Labor tabs.
                                </p>
                            )}
                            {heatedFloorType === 'nuheat' && (
                                <p className="text-xs text-slate-500 px-1">
                                    <b>Note:</b> Costs are estimated based on standard Nuheat kits. Please verify the final price and labor hours in the Materials & Labor tabs.
                                </p>
                            )}
                            {heatedFloorType === 'custom' && (
                                <div className="pt-2">
                                    <input
                                        type="text"
                                        value={customHeatedFloorName}
                                        onChange={(e) => setCustomHeatedFloorName(e.target.value)}
                                        placeholder="Enter system name..."
                                        className="w-full p-2.5 bg-slate-50 border border-blue-300 rounded-lg focus:bg-white focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    />
                                    <p className="text-xs text-slate-500 mt-2 px-1">
                                        Remember to update material costs and labor hours for this custom system.
                                    </p>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            </CollapsibleCard>

            <CollapsibleCard
                title="Construction"
                isOpen={openSections.construction}
                onToggle={() => toggleSection('construction')}
            >
                <div className="space-y-4">
                    {prepAndStructuralOptions.map(task => (
                        <div key={task.value}>
                            <OptionToggle 
                                label={task.label}
                                isEnabled={selectedPrepTasks.includes(task.value)}
                                onToggle={() => handlePrepTaskToggle(task.value)}
                            />
                            {task.value === 'add_plywood' && selectedPrepTasks.includes('add_plywood') && (
                                <div className="pt-3 pl-4 animate-fade-in">
                                    <Dropdown label="Plywood Thickness" options={plywoodThicknessOptions} selectedOption={plywoodThickness} onSelect={setPlywoodThickness} />
                                </div>
                            )}
                        </div>
                    ))}
                    <div className="pt-4 border-t border-slate-200">
                        <button onClick={() => toggleSection('constructionNotes')} className="w-full flex justify-between items-center py-2">
                            <h3 className="text-lg font-bold text-blue-700">Notes</h3>
                            <svg className={`w-5 h-5 text-slate-500 transition-transform ${openSections.constructionNotes ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7" /></svg>
                        </button>
                        {openSections.constructionNotes && (
                            <div className="mt-2 animate-fade-in">
                                <textarea 
                                    ref={constructionNotesRef}
                                    value={floorChoices.constructionNotes} 
                                    onChange={(e) => handleInputChange('constructionNotes', e.target.value)} 
                                    placeholder="Add construction notes..." 
                                    className="w-full p-2.5 bg-slate-50 border border-blue-300 rounded-lg focus:bg-white focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                    rows="3"
                                ></textarea>
                            </div>
                        )}
                    </div>
                </div>
            </CollapsibleCard>
        </div>
    );
};


const MaterialsView = ({ constructionMaterials, setConstructionMaterials, designMaterials, setDesignMaterials, structuralMaterials, setStructuralMaterials, notes, setNotes, heatedFloorMaterials, setHeatedFloorMaterials, materialsTotal }) => {
    const [showNotes, setShowNotes] = useState(false);
    const [isConstructionOpen, setIsConstructionOpen] = useState(true);
    const [isDesignOpen, setIsDesignOpen] = useState(true);
    const [isStructuralOpen, setIsStructuralOpen] = useState(true);
    const [isHeatedFloorOpen, setIsHeatedFloorOpen] = useState(true);
    
    const handleAddDesignMaterial = () => {
      setDesignMaterials(prev => [...prev, { id: `custom-${Date.now()}`, name: "", unit: "each", price: "", quantity: "1" }]);
    };

    const handleDesignMaterialChange = (id, field, value) => {
        setDesignMaterials(prev => prev.map(mat => mat.id === id ? { ...mat, [field]: value } : mat));
    };

    const handleConstructionMaterialChange = (id, field, value) => {
        setConstructionMaterials(prev => prev.map(mat => mat.id === id ? { ...mat, [field]: value } : mat));
    };

    const handleStructuralMaterialChange = (id, field, value) => {
        setStructuralMaterials(prev => prev.map(mat => mat.id === id ? { ...mat, [field]: value } : mat));
    };

    const handleHeatedFloorMaterialChange = (id, field, value) => {
        setHeatedFloorMaterials(prev => prev.map(mat => mat.id === id ? { ...mat, [field]: value } : mat));
    };
    
    const handleDeleteDesignMaterial = (id) => {
      setDesignMaterials(prev => prev.filter(mat => mat.id !== id));
    };

    const constructionTotal = constructionMaterials.reduce((sum, item) => sum + (parseFloat(item.quantity) || 0) * (parseFloat(item.price) || 0), 0);
    const designTotal = designMaterials.reduce((sum, item) => sum + (parseFloat(item.quantity) || 0) * (parseFloat(item.price) || 0), 0);
    const structuralTotal = structuralMaterials.reduce((sum, item) => sum + (parseFloat(item.quantity) || 0) * (parseFloat(item.price) || 0), 0);
    const heatedFloorTotal = heatedFloorMaterials.reduce((sum, item) => sum + (parseFloat(item.quantity) || 0) * (parseFloat(item.price) || 0), 0);
    
    const renderMaterialItem = (material, handler, deleter) => {
        const isAuto = material.id.startsWith('mat-');
        return (
             <div key={material.id} className="p-4 bg-white rounded-lg border border-slate-300">
                <div className="flex items-center gap-2 mb-2">
                    <input 
                        type="text" 
                        value={material.name} 
                        onChange={(e) => !isAuto && handler(material.id, 'name', e.target.value)} 
                        placeholder="Material Name" 
                        className={`w-full p-1 text-slate-700 font-semibold border-b-2 bg-transparent ${!isAuto ? 'border-slate-200 focus:border-blue-500' : 'border-transparent'}`}
                        readOnly={isAuto}
                    />
                    {!isAuto && deleter && <button onClick={() => deleter(material.id)} className="text-red-500 hover:text-red-700 p-1">
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    </button>}
                </div>
                <div className="grid grid-cols-3 gap-4">
                    <div>
                        <label className="text-xs text-slate-500">Quantity</label>
                        <input type="number" value={material.quantity} onChange={(e) => !isAuto && handler(material.id, 'quantity', e.target.value)} placeholder="0" className="w-full p-2 text-center bg-slate-50 border border-blue-300 rounded-lg focus:bg-white focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" readOnly={isAuto} />
                    </div>
                    <div>
                        <label className="text-xs text-slate-500">Price/Unit ($)</label>
                        <input type="number" value={material.price} onChange={(e) => handler(material.id, 'price', e.target.value)} placeholder="0.00" className="w-full p-2 text-center bg-slate-50 border border-blue-300 rounded-lg focus:bg-white focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    </div>
                    <div>
                        <label className="text-xs text-slate-500">Total</label>
                         <p className="w-full p-2 text-center font-semibold text-slate-800">${((parseFloat(material.quantity) || 0) * (parseFloat(material.price) || 0)).toFixed(2)}</p>
                    </div>
                </div>
            </div>
        );
    }

    return (
        <div className="space-y-6">
            <div className="flex justify-between items-center mb-3">
                <h2 className="text-2xl font-bold text-slate-800">Materials</h2>
                <p className="font-bold text-blue-600 text-lg">${materialsTotal.toFixed(2)}</p>
            </div>
            
            <div className="space-y-4">
                <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                     <button onClick={() => setIsDesignOpen(!isDesignOpen)} className="w-full flex justify-between items-center p-4">
                        <h3 className="text-lg font-bold text-slate-800 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" /></svg>
                            <span>Design Materials</span>
                        </h3>
                        <div className="flex items-center gap-2">
                            <span className="font-semibold text-blue-600">${designTotal.toFixed(2)}</span>
                            <svg className={`w-5 h-5 text-blue-500 transition-transform ${isDesignOpen ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7" /></svg>
                        </div>
                    </button>
                    {isDesignOpen && <div className="p-4 pt-0 space-y-2">
                        {designMaterials.map(m => renderMaterialItem(m, handleDesignMaterialChange, m.id.startsWith('mat-') ? null : handleDeleteDesignMaterial))}
                        <button onClick={handleAddDesignMaterial} className="w-full mt-2 flex items-center justify-center gap-2 py-2.5 px-4 bg-blue-100 hover:bg-blue-200 text-blue-800 font-semibold rounded-lg transition-colors border border-blue-200">
                           <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                            Add Custom Design Material
                        </button>
                    </div>}
                </div>
                <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                    <button onClick={() => setIsConstructionOpen(!isConstructionOpen)} className="w-full flex justify-between items-center p-4">
                        <h3 className="text-lg font-bold text-slate-800 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                            <span>Construction Materials</span>
                        </h3>
                        <div className="flex items-center gap-2">
                            <span className="font-semibold text-slate-600">${constructionTotal.toFixed(2)}</span>
                            <svg className={`w-5 h-5 text-slate-500 transition-transform ${isConstructionOpen ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7" /></svg>
                        </div>
                    </button>
                    {isConstructionOpen && <div className="p-4 pt-0 space-y-2">
                        {constructionMaterials.length > 0 ? constructionMaterials.map(m => renderMaterialItem(m, handleConstructionMaterialChange, null)) : <p className="text-sm text-slate-500 text-center py-4">No construction materials needed.</p>}
                    </div>}
                </div>
                 {heatedFloorMaterials.length > 0 && (
                    <div className="bg-orange-50 rounded-xl">
                        <button onClick={() => setIsHeatedFloorOpen(!isHeatedFloorOpen)} className="w-full flex justify-between items-center p-4">
                            <h3 className="text-lg font-bold text-amber-800 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-amber-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7.014A8.003 8.003 0 0112 3c1.398 0 2.743.57 3.714 1.543C18.5 6.5 19 9 19 11c2 1 2.657 2.657 2.657 2.657a8 8 0 01-4.001 5z" /></svg>
                                <span>Heated Floor Materials</span>
                            </h3>
                            <div className="flex items-center gap-2">
                                <span className="font-semibold text-amber-600">${heatedFloorTotal.toFixed(2)}</span>
                                <svg className={`w-5 h-5 text-amber-500 transition-transform ${isHeatedFloorOpen ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7" /></svg>
                            </div>
                        </button>
                        {isHeatedFloorOpen && <div className="p-4 pt-0 space-y-2">
                            {heatedFloorMaterials.map(m => renderMaterialItem(m, handleHeatedFloorMaterialChange, null))}
                        </div>}
                    </div>
                )}
                {structuralMaterials.length > 0 && (
                    <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                        <button onClick={() => setIsStructuralOpen(!isStructuralOpen)} className="w-full flex justify-between items-center p-4">
                            <h3 className="text-lg font-bold text-slate-800 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>
                                <span>Structural Work Materials</span>
                            </h3>
                            <div className="flex items-center gap-2">
                                <span className="font-semibold text-orange-600">${structuralTotal.toFixed(2)}</span>
                                <svg className={`w-5 h-5 text-orange-500 transition-transform ${isStructuralOpen ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7" /></svg>
                            </div>
                        </button>
                        {isStructuralOpen && <div className="p-4 pt-0 space-y-2">
                            {structuralMaterials.map(m => renderMaterialItem(m, handleStructuralMaterialChange, null))}
                        </div>}
                    </div>
                )}

                <div className="pt-4 border-t border-slate-200">
                    <button onClick={() => setShowNotes(!showNotes)} className="w-full flex justify-between items-center py-2">
                        <h3 className="text-lg font-bold text-blue-700">Notes</h3>
                        <svg className={`w-5 h-5 text-slate-500 transition-transform ${showNotes ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7" /></svg>
                    </button>
                    {showNotes && (
                        <div className="mt-2 animate-fade-in">
                            <textarea value={notes} onChange={(e) => setNotes(e.target.value)} placeholder="Add notes for materials..." className="w-full p-2.5 bg-slate-50 border border-blue-300 rounded-lg focus:bg-white focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" rows="2"></textarea>
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
};

const LaborView = ({ laborItems, setLaborItems, notes, setNotes, laborTotal }) => {
    const [showNotes, setShowNotes] = useState(false);
    const [isPrepOpen, setIsPrepOpen] = useState(true);
    const [isTilingOpen, setIsTilingOpen] = useState(true);
    const [isHeatedFloorOpen, setIsHeatedFloorOpen] = useState(true);

    const prepTasks = laborItems.filter(item => item.id.startsWith('lab-prep-') && item.id !== 'lab-prep-heated_floor');
    const tilingTasks = laborItems.filter(item => !item.id.startsWith('lab-prep-'));
    const heatedFloorTask = laborItems.find(item => item.id === 'lab-prep-heated_floor');

    const prepTotal = prepTasks.reduce((sum, item) => sum + (parseFloat(item.hours) || 0) * (parseFloat(item.rate) || 0), 0);
    const tilingTotal = tilingTasks.reduce((sum, item) => sum + (parseFloat(item.hours) || 0) * (parseFloat(item.rate) || 0), 0);
    const heatedFloorTotal = heatedFloorTask ? (parseFloat(heatedFloorTask.hours) || 0) * (parseFloat(heatedFloorTask.rate) || 0) : 0;
    
    const handleAddLaborItem = () => {
      setLaborItems(prev => [...prev, { id: `custom-${Date.now()}`, name: '', hours: '', rate: '95' }]);
    };
    
    const handleDeleteLaborItem = (id) => {
        setLaborItems(prev => prev.filter(item => item.id !== id));
    };

    const handleLaborItemChange = (id, field, value) => {
        setLaborItems(prev => prev.map(item => item.id === id ? { ...item, [field]: value } : item));
    };

    const renderLaborItem = (item) => {
        if (!item) return null;
        const isAuto = item.id.startsWith('lab-');
        return (
            <div key={item.id} className="p-4 bg-white rounded-lg border border-slate-300">
                <div className="flex items-center gap-2 mb-2">
                    <input type="text" value={item.name} onChange={(e) => handleLaborItemChange(item.id, 'name', e.target.value)} placeholder="Labor Task" className="w-full p-1 text-slate-700 font-semibold border-b-2 border-slate-200 focus:border-blue-500 focus:outline-none bg-transparent" readOnly={isAuto} />
                    {!isAuto && <button onClick={() => handleDeleteLaborItem(item.id)} className="text-red-500 hover:text-red-700 p-1">
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    </button>}
                </div>
                <div className="grid grid-cols-2 gap-4">
                    <div>
                        <label className="text-xs text-slate-500">Hours</label>
                        <input type="number" value={item.hours} onChange={(e) => handleLaborItemChange(item.id, 'hours', e.target.value)} placeholder="0" className="w-full p-2 text-center bg-slate-50 border border-blue-300 rounded-lg focus:bg-white focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    </div>
                    <div>
                        <label className="text-xs text-slate-500">Rate ($/hr)</label>
                        <input type="number" value={item.rate} onChange={(e) => handleLaborItemChange(item.id, 'rate', e.target.value)} placeholder="0" className="w-full p-2 text-center bg-slate-50 border border-blue-300 rounded-lg focus:bg-white focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    </div>
                </div>
            </div>
        );
    }

    return (
        <div className="space-y-6">
            <div className="flex justify-between items-baseline mb-3">
                <h2 className="text-2xl font-bold text-slate-800">Labor</h2>
                <p className="font-bold text-blue-600 text-lg">${laborTotal.toFixed(2)}</p>
            </div>
            
            <div className="space-y-4">
                <div className="space-y-3">
                     <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                         <button onClick={() => setIsTilingOpen(!isTilingOpen)} className="w-full flex justify-between items-center p-4">
                            <h3 className="text-lg font-bold text-slate-800 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                                <span>Tiling Labor</span>
                            </h3>
                            <div className="flex items-center gap-2">
                                <span className="font-semibold text-slate-600">${tilingTotal.toFixed(2)}</span>
                                <svg className={`w-5 h-5 text-slate-500 transition-transform ${isTilingOpen ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7" /></svg>
                            </div>
                        </button>
                        {isTilingOpen && <div className="p-4 pt-0 space-y-2">{tilingTasks.map(renderLaborItem)}</div>}
                    </div>
                    {heatedFloorTask && (
                        <div className="bg-orange-50 rounded-xl">
                            <button onClick={() => setIsHeatedFloorOpen(!isHeatedFloorOpen)} className="w-full flex justify-between items-center p-4">
                                <h3 className="text-lg font-bold text-amber-800 flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-amber-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7.014A8.003 8.003 0 0112 3c1.398 0 2.743.57 3.714 1.543C18.5 6.5 19 9 19 11c2 1 2.657 2.657 2.657 2.657a8 8 0 01-4.001 5z" /></svg>
                                    <span>Heated Floor Labor</span>
                                </h3>
                                <div className="flex items-center gap-2">
                                    <span className="font-semibold text-amber-600">${heatedFloorTotal.toFixed(2)}</span>
                                    <svg className={`w-5 h-5 text-amber-500 transition-transform ${isHeatedFloorOpen ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7" /></svg>
                                </div>
                            </button>
                            {isHeatedFloorOpen && <div className="p-4 pt-0 space-y-2">{renderLaborItem(heatedFloorTask)}</div>}
                        </div>
                    )}
                    {prepTasks.length > 0 && (
                        <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                            <button onClick={() => setIsPrepOpen(!isPrepOpen)} className="w-full flex justify-between items-center p-4">
                                <h3 className="text-lg font-bold text-slate-800 flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>
                                    <span>Structural & Prep Work</span>
                                </h3>
                                <div className="flex items-center gap-2">
                                    <span className="font-semibold text-orange-600">${prepTotal.toFixed(2)}</span>
                                    <svg className={`w-5 h-5 text-orange-500 transition-transform ${isPrepOpen ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7" /></svg>
                                </div>
                            </button>
                            {isPrepOpen && <div className="p-4 pt-0 space-y-2">{prepTasks.map(renderLaborItem)}</div>}
                        </div>
                    )}
                    
                    <button onClick={handleAddLaborItem} className="w-full mt-2 flex items-center justify-center gap-2 py-2.5 px-4 bg-blue-100 hover:bg-blue-200 text-blue-800 font-semibold rounded-lg transition-colors border border-blue-200">
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        Add Custom Labor Task
                    </button>
                    <div className="pt-2 border-t border-slate-200">
                        <button onClick={() => setShowNotes(!showNotes)} className="w-full flex justify-between items-center py-2">
                            <h3 className="text-lg font-bold text-blue-700">Notes</h3>
                            <svg className={`w-5 h-5 text-slate-500 transition-transform ${showNotes ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7" /></svg>
                        </button>
                        {showNotes && (
                            <div className="mt-2 animate-fade-in">
                                <textarea value={notes} onChange={(e) => setNotes(e.target.value)} placeholder="Add notes for labor..." className="w-full p-2.5 bg-slate-50 border border-blue-300 rounded-lg focus:bg-white focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" rows="2"></textarea>
                            </div>
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
};

const SummaryView = ({ materialsTotal, laborTotal, taxRate, setTaxRate }) => {
    const subtotal = materialsTotal + laborTotal;
    const taxAmount = subtotal * (parseFloat(taxRate) || 0);
    const grandTotal = subtotal + taxAmount;

    return (
        <div className="space-y-6 animate-fade-in">
            <div className="text-center">
                <h2 className="text-2xl font-bold text-slate-800">Project Summary</h2>
                <p className="text-slate-500 mt-1">A complete breakdown of the estimated costs.</p>
            </div>
            <div className="p-6 bg-slate-50 rounded-xl border border-slate-200 space-y-4">
                <div className="flex justify-between items-center">
                    <span className="font-semibold text-slate-600">Materials Total</span>
                    <span className="font-medium text-slate-800">${materialsTotal.toFixed(2)}</span>
                </div>
                <div className="flex justify-between items-center">
                    <span className="font-semibold text-slate-600">Labor Total</span>
                    <span className="font-medium text-slate-800">${laborTotal.toFixed(2)}</span>
                </div>
                <div className="pt-4 border-t border-slate-200 flex justify-between items-center">
                    <span className="font-bold text-slate-700">Subtotal</span>
                    <span className="font-bold text-slate-900">${subtotal.toFixed(2)}</span>
                </div>
                <div className="flex justify-between items-center text-sm">
                    <span className="font-semibold text-slate-600">Tax</span>
                    <div className="flex items-center gap-2">
                         <input 
                            type="number" 
                            value={(taxRate * 100).toFixed(1)} 
                            onChange={(e) => setTaxRate(parseFloat(e.target.value) / 100 || 0)}
                            className="w-16 p-1 text-right bg-white border border-slate-300 rounded-md focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                            step="0.1"
                        />
                        <span className="font-semibold text-slate-600">%</span>
                        <span className="font-medium text-slate-800 w-20 text-right">${taxAmount.toFixed(2)}</span>
                    </div>
                </div>
            </div>
            <div className="p-6 bg-blue-600 text-white rounded-xl shadow-lg shadow-blue-500/30 flex justify-between items-center">
                <span className="text-xl font-bold">Grand Total</span>
                <span className="text-2xl font-extrabold">${grandTotal.toFixed(2)}</span>
            </div>
        </div>
    );
};


// --- Initial Data Structure ---
const initialProjectData = {
    floorChoices: {
        dimensions: { width: '', length: '' },
        extraMeasurements: [],
        tilePattern: 'select_option',
        customPattern: '',
        selectedTileSizeOption: 'select_option',
        tileSize: { width: '', length: '' },
        notes: '',
        constructionNotes: '',
    },
    clientSuppliesTiles: false,
    selectedPrepTasks: [],
    plywoodThickness: '3/4',
    isHeatedFloor: false,
    heatedFloorType: 'schluter',
    customHeatedFloorName: '',
    laborItems: [
        { id: 'lab-tile', name: 'Tile', hours: '0', rate: '95' },
        { id: 'lab-grout', name: 'Grout', hours: '0', rate: '95' },
    ],
    constructionMaterials: [],
    designMaterials: [],
    structuralMaterials: [],
    heatedFloorMaterials: [],
    laborNotes: '',
    materialsNotes: '',
    taxRate: 0.13,
};

// --- Main App Component ---
const App = () => {
  // --- UI State ---
  const [activeView, setActiveView] = useState('design');
  const [activeModule, setActiveModule] = useState('floors');
  const [syncStatus, setSyncStatus] = useState('Initializing...');

  // --- Firebase State ---
  const [db, setDb] = useState(null);
  const [userId, setUserId] = useState(null);

  // --- Project Data State ---
  const [projectData, setProjectData] = useState(initialProjectData);
  
  const isInitialLoad = useRef(true);
  const saveTimeoutRef = useRef(null);

  // --- FIREBASE INITIALIZATION & AUTH ---
  useEffect(() => {
    try {
        const firebaseConfigStr = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
        if (!firebaseConfigStr) {
            console.error("Firebase config not found.");
            setSyncStatus("Config Error");
            return;
        }
        const firebaseConfig = JSON.parse(firebaseConfigStr);
        const app = initializeApp(firebaseConfig);
        const authInstance = getAuth(app);
        const dbInstance = getFirestore(app);
        setLogLevel('debug');

        setDb(dbInstance);

        onAuthStateChanged(authInstance, async (user) => {
            if (user) {
                setUserId(user.uid);
            } else {
                try {
                    const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    if (authToken) {
                        await signInWithCustomToken(authInstance, authToken);
                    } else {
                        await signInAnonymously(authInstance);
                    }
                } catch (error) {
                    console.error("Authentication failed:", error);
                    setSyncStatus("Auth Error");
                }
            }
        });
    } catch (error) {
        console.error("Firebase initialization failed:", error);
        setSyncStatus("Init Error");
    }
  }, []);

  // --- DATA LOADING from FIRESTORE ---
  useEffect(() => {
    if (!db || !userId) return;

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const docRef = doc(db, `artifacts/${appId}/users/${userId}/floor_estimates/main`);

    const unsubscribe = onSnapshot(docRef, (docSnap) => {
        if (docSnap.exists()) {
            const remoteData = docSnap.data();
            // Merge remote data with initial state to handle schema changes gracefully
            const mergedData = { ...initialProjectData, ...remoteData };
            isInitialLoad.current = true; // Prevent this loaded data from being immediately re-saved
            setProjectData(mergedData);
        } else {
            console.log("No existing document, using initial project data.");
        }
        setSyncStatus('Synced');
    }, (error) => {
        console.error("Error listening to document:", error);
        setSyncStatus('Load Error');
    });

    return () => unsubscribe(); // Cleanup subscription on unmount
  }, [db, userId]);

  // --- DATA SAVING to FIRESTORE (DEBOUNCED) ---
  useEffect(() => {
    if (!db || !userId || isInitialLoad.current) {
        if (isInitialLoad.current) {
            isInitialLoad.current = false; // Unset flag after initial load
        }
        return;
    }

    setSyncStatus('Saving...');
    clearTimeout(saveTimeoutRef.current);

    saveTimeoutRef.current = setTimeout(() => {
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const docRef = doc(db, `artifacts/${appId}/users/${userId}/floor_estimates/main`);
        
        setDoc(docRef, projectData, { merge: true })
            .then(() => {
                setSyncStatus('Synced');
            })
            .catch(error => {
                console.error("Error saving document:", error);
                setSyncStatus('Save Error');
            });
    }, 1500); // Debounce saves by 1.5 seconds

  }, [projectData, db, userId]);

  // Destructure project data for passing as props
  const {
    floorChoices, clientSuppliesTiles, selectedPrepTasks, plywoodThickness,
    isHeatedFloor, heatedFloorType, customHeatedFloorName, laborItems,
    constructionMaterials, designMaterials, structuralMaterials, heatedFloorMaterials,
    laborNotes, materialsNotes, taxRate
  } = projectData;

  // --- STATE SETTER FACTORY ---
  // Creates setter functions that update the main projectData state object
  const createSetter = (key) => (value) => {
    setProjectData(prev => {
        const newValue = typeof value === 'function' ? value(prev[key]) : value;
        return { ...prev, [key]: newValue };
    });
  };
  
  // Create individual setters to pass as props
  const setFloorChoices = createSetter('floorChoices');
  const setClientSuppliesTiles = createSetter('clientSuppliesTiles');
  const setSelectedPrepTasks = createSetter('selectedPrepTasks');
  const setPlywoodThickness = createSetter('plywoodThickness');
  const setIsHeatedFloor = createSetter('isHeatedFloor');
  const setHeatedFloorType = createSetter('heatedFloorType');
  const setCustomHeatedFloorName = createSetter('customHeatedFloorName');
  const setLaborItems = createSetter('laborItems');
  const setConstructionMaterials = createSetter('constructionMaterials');
  const setDesignMaterials = createSetter('designMaterials');
  const setStructuralMaterials = createSetter('structuralMaterials');
  const setHeatedFloorMaterials = createSetter('heatedFloorMaterials');
  const setLaborNotes = createSetter('laborNotes');
  const setMaterialsNotes = createSetter('materialsNotes');
  const setTaxRate = createSetter('taxRate');

  // --- DERIVED STATE & CALCULATIONS ---
  // These are calculated on each render based on the current projectData
  const [totalSqFt, setTotalSqFt] = useState(0);
  const [wasteFactor, setWasteFactor] = useState(1.10);

  const laborTotal = laborItems.reduce((sum, item) => sum + (parseFloat(item.hours) || 0) * (parseFloat(item.rate) || 0), 0);
  
  const materialsTotal = [
    ...constructionMaterials,
    ...designMaterials,
    ...structuralMaterials,
    ...heatedFloorMaterials
  ].reduce((sum, item) => sum + (parseFloat(item.quantity) || 0) * (parseFloat(item.price) || 0), 0);
  
  // --- EFFECT: Calculate Total Square Footage ---
  useEffect(() => {
    const { dimensions, extraMeasurements } = floorChoices;
    let totalArea = 0;
    const mainWidth = parseFloat(dimensions.width) || 0;
    const mainLength = parseFloat(dimensions.length) || 0;

    if (mainWidth > 0 && mainLength > 0) {
        totalArea += (mainWidth * mainLength) / 144;
    }

    (extraMeasurements || []).forEach(m => {
        const sideWidth = parseFloat(m.width) || 0;
        const sideLength = parseFloat(m.length) || 0;
        if (sideWidth > 0 && sideLength > 0) {
            totalArea += (sideWidth * sideLength) / 144;
        }
    });
    setTotalSqFt(totalArea);
  }, [floorChoices.dimensions, floorChoices.extraMeasurements]);

    // --- EFFECT: DYNAMICALLY UPDATE LABOR HOURS ---
    useEffect(() => {
        if (totalSqFt > 0) {
            setLaborItems(currentItems => {
                const updatedItems = currentItems.map(item => {
                    if (item.id === 'lab-tile') {
                        // Estimate: 1 hour per 3 sq/ft, based on GTA/Ottawa market research.
                        const hours = Math.max(1, totalSqFt / 3).toFixed(2);
                        return { ...item, hours };
                    }
                    if (item.id === 'lab-grout') {
                        // Estimate: 1 hour per 30 sq/ft for a professional.
                        const hours = Math.max(1, totalSqFt / 30).toFixed(2);
                        return { ...item, hours };
                    }
                    return item;
                });
                return updatedItems;
            });
        }
    }, [totalSqFt]);


  // --- EFFECT: Manage conditional labor items ---
  useEffect(() => {
    setLaborItems(currentItems => {
        let newItems = currentItems.filter(item => {
            if (!item.id.startsWith('lab-prep-')) return true;
            const taskKey = item.id.replace('lab-prep-', '');
            return selectedPrepTasks.includes(taskKey);
        });

        selectedPrepTasks.forEach(taskKey => {
            if (!newItems.some(item => item.id === `lab-prep-${taskKey}`)) {
                // Localized estimates for GTA/Ottawa regions
                const prepTaskMap = {
                    'self_leveling': { name: 'Self-Leveling', hours: Math.max(1, totalSqFt / 75).toFixed(2) }, // 1 hr per 75 sqft
                    'repair_subfloor': { name: 'Repair portion of subfloor', hours: '3' }, // Increased to 3 hours
                    'repair_joist': { name: 'Repair Floor Joist', hours: '4' }, // Standard 4 hours
                    'add_plywood': { name: `Install ${plywoodThickness}" Plywood`, hours: Math.max(1, totalSqFt / 50).toFixed(2) }, // 1 hr per 50 sqft
                    'ditra': { name: 'Lay Ditra', hours: Math.max(1, totalSqFt / 100).toFixed(2) }, // 1 hr per 100 sqft
                    'ditra_xl': { name: 'Lay Ditra XL', hours: Math.max(1, totalSqFt / 100).toFixed(2) }, // Same as regular Ditra
                };
                const task = prepTaskMap[taskKey];
                if (task) {
                    newItems.unshift({ id: `lab-prep-${taskKey}`, name: task.name, hours: task.hours, rate: '95' });
                }
            }
        });

        const heatedFloorTaskExists = newItems.some(item => item.id === 'lab-prep-heated_floor');
        const heatedFloorHours = (2 + (totalSqFt / 20)).toFixed(2); // 2hr base + 1hr/20sqft

        if (isHeatedFloor && !heatedFloorTaskExists) {
            newItems.unshift({ id: 'lab-prep-heated_floor', name: 'Install Heated Floor System', hours: heatedFloorHours, rate: '95' });
        } else if (!isHeatedFloor && heatedFloorTaskExists) {
            newItems = newItems.filter(item => item.id !== 'lab-prep-heated_floor');
        }
        
        const plywoodTaskIndex = newItems.findIndex(item => item.id === 'lab-prep-add_plywood');
        if (plywoodTaskIndex > -1) {
            newItems[plywoodTaskIndex].name = `Install ${plywoodThickness}" Plywood`;
        }

        return newItems;
    });
  }, [selectedPrepTasks, plywoodThickness, isHeatedFloor, totalSqFt]);

  // --- EFFECT: Set waste factor based on pattern ---
  useEffect(() => {
    let newWasteFactor = 1.10; // Default for Stacked
    switch (floorChoices.tilePattern) {
        case 'herringbone':
            newWasteFactor = 1.25; // 25%
            break;
        case '1/2_offset':
        case '1/3_offset':
            newWasteFactor = 1.20; // 20%
            break;
        default:
            newWasteFactor = 1.10;
            break;
    }
    setWasteFactor(newWasteFactor);
  }, [floorChoices.tilePattern]);

  // --- EFFECT: Auto-calculate materials based on design and labor ---
  useEffect(() => {
    const mergeAndPreservePrices = (prevMaterials, newCalculatedMaterials) => {
        const updatedMaterials = newCalculatedMaterials.map(newMat => {
            const existingMat = prevMaterials.find(prevMat => prevMat.id === newMat.id);
            if (existingMat) {
                return { ...newMat, price: existingMat.price };
            }
            return newMat;
        });
        return updatedMaterials;
    };

    if (totalSqFt > 0) {
        const newConstruction = [];
        const newDesign = [];
        const newStructural = [];
        const newHeatedFloor = [];
        const plywoodPriceMap = { '1/2': '70.00', '5/8': '86.00', '3/4': '103.00' };

        if (floorChoices.selectedTileSizeOption !== 'select_option' && !clientSuppliesTiles) {
            const tileSqFt = totalSqFt * wasteFactor;
            newDesign.push({ id: 'mat-tile', name: `Floor Tile (${floorChoices.tileSize.width}"x${floorChoices.tileSize.length}")`, quantity: tileSqFt.toFixed(2), price: '5.00', unit: 'sq/ft' });
        }
        
        const groutBags = Math.ceil(totalSqFt / 125);
        if (groutBags > 0) newConstruction.push({ id: 'mat-grout', name: 'Sanded Grout (25lb bag)', quantity: groutBags, price: '30.00', unit: 'bag' });
        
        let thinsetForTiles = Math.ceil(totalSqFt / 45);
        let thinsetForDitra = 0;
        
        if (selectedPrepTasks.includes('ditra') || selectedPrepTasks.includes('ditra_xl')) {
            const isDitraXL = selectedPrepTasks.includes('ditra_xl');
            const membraneName = isDitraXL ? 'Ditra XL' : 'Ditra';
            const rollCoverage = isDitraXL ? 175 : 54;
            const price = isDitraXL ? 462.00 : 165.00;
            const membraneId = isDitraXL ? 'mat-ditra_xl' : 'mat-ditra';
            
            newConstruction.push({ id: membraneId, name: `${membraneName} Uncoupling Membrane`, quantity: Math.ceil(totalSqFt / rollCoverage), price: price.toFixed(2), unit: 'roll' });
            thinsetForDitra = Math.ceil(totalSqFt / 175);
        }

        const totalThinset = thinsetForTiles + thinsetForDitra;
        if(totalThinset > 0) newConstruction.push({ id: 'mat-thinset', name: 'Thinset Mortar (50lb bag)', quantity: totalThinset, price: '30.00', unit: 'bag' });
        
        if (isHeatedFloor) {
            const heatedFloorSystemQty = Math.ceil(totalSqFt / 40);
            let systemName, systemPrice;
            if (heatedFloorType === 'custom') {
                systemName = customHeatedFloorName || 'Custom Heated Floor System';
                systemPrice = '0.00';
            } else if (heatedFloorType === 'nuheat') {
                systemName = 'Nuheat Cable System';
                systemPrice = '350.00';
            } else {
                systemName = 'Schluter-DITRA-HEAT Kit';
                systemPrice = '400.00';
            }
            newHeatedFloor.push({ id: 'mat-heated-floor', name: systemName, quantity: heatedFloorSystemQty, price: systemPrice, unit: 'kit' });
            newHeatedFloor.push({ id: 'mat-thermostat', name: 'Heated Floor Thermostat', quantity: 1, price: '220.00', unit: 'each' });
        }

        if (selectedPrepTasks.includes('self_leveling')) {
            const levelerBags = Math.ceil(totalSqFt / 50);
            newStructural.push({ id: 'mat-leveler', name: 'Self-Leveling Compound (50lb bag)', quantity: levelerBags, price: '45.00', unit: 'bag' });
        }

        if (selectedPrepTasks.includes('add_plywood')) {
            const plywoodSheets = Math.ceil(totalSqFt / 32);
            const price = plywoodPriceMap[plywoodThickness] || '70.00';
            newStructural.push({ id: 'mat-plywood', name: `${plywoodThickness}" Plywood`, quantity: plywoodSheets, price: price, unit: 'sheet' });
            newStructural.push({ id: 'mat-screws', name: 'Floor Screws', quantity: 1, price: '18.00', unit: 'box' });
        }
        
        setConstructionMaterials(prev => mergeAndPreservePrices(prev, newConstruction));
        setStructuralMaterials(prev => mergeAndPreservePrices(prev, newStructural));
        setHeatedFloorMaterials(prev => mergeAndPreservePrices(prev, newHeatedFloor));
        
        setDesignMaterials(prev => {
            const customMaterials = prev.filter(m => !m.id.startsWith('mat-'));
            const autoMaterials = prev.filter(m => m.id.startsWith('mat-'));
            const updatedAutoMaterials = mergeAndPreservePrices(autoMaterials, newDesign);
            return [...updatedAutoMaterials, ...customMaterials];
        });

    } else {
        setConstructionMaterials([]);
        setDesignMaterials(prev => prev.filter(m => !m.id.startsWith('mat-')));
        setStructuralMaterials([]);
        setHeatedFloorMaterials([]);
    }
  }, [totalSqFt, floorChoices.selectedTileSizeOption, floorChoices.tileSize, selectedPrepTasks, clientSuppliesTiles, wasteFactor, plywoodThickness, isHeatedFloor, heatedFloorType, customHeatedFloorName]);
  
  // --- View Renderer ---
  const renderActiveView = () => {
      switch(activeView) {
          case 'design':
              return <DesignView 
                  floorChoices={floorChoices}
                  setFloorChoices={setFloorChoices}
                  totalSqFt={totalSqFt}
                  clientSuppliesTiles={clientSuppliesTiles}
                  setClientSuppliesTiles={setClientSuppliesTiles}
                  selectedPrepTasks={selectedPrepTasks}
                  setSelectedPrepTasks={setSelectedPrepTasks}
                  plywoodThickness={plywoodThickness}
                  setPlywoodThickness={setPlywoodThickness}
                  isHeatedFloor={isHeatedFloor}
                  setIsHeatedFloor={setIsHeatedFloor}
                  heatedFloorType={heatedFloorType}
                  setHeatedFloorType={setHeatedFloorType}
                  customHeatedFloorName={customHeatedFloorName}
                  setCustomHeatedFloorName={setCustomHeatedFloorName}
              />;
          case 'labor':
              return <LaborView 
                  laborItems={laborItems} 
                  setLaborItems={setLaborItems}
                  notes={laborNotes}
                  setNotes={setLaborNotes}
                  laborTotal={laborTotal}
              />;
          case 'materials':
              return <MaterialsView 
                  constructionMaterials={constructionMaterials}
                  setConstructionMaterials={setConstructionMaterials}
                  designMaterials={designMaterials}
                  setDesignMaterials={setDesignMaterials}
                  structuralMaterials={structuralMaterials}
                  setStructuralMaterials={setStructuralMaterials}
                  heatedFloorMaterials={heatedFloorMaterials}
                  setHeatedFloorMaterials={setHeatedFloorMaterials}
                  notes={materialsNotes}
                  setNotes={setMaterialsNotes}
                  materialsTotal={materialsTotal}
              />;
          case 'summary':
              return <SummaryView
                  materialsTotal={materialsTotal}
                  laborTotal={laborTotal}
                  taxRate={taxRate}
                  setTaxRate={setTaxRate}
              />;
          default:
              return <DesignView 
                  floorChoices={floorChoices}
                  setFloorChoices={setFloorChoices}
                  totalSqFt={totalSqFt}
                  clientSuppliesTiles={clientSuppliesTiles}
                  setClientSuppliesTiles={setClientSuppliesTiles}
                  selectedPrepTasks={selectedPrepTasks}
                  setSelectedPrepTasks={setSelectedPrepTasks}
                  plywoodThickness={plywoodThickness}
                  setPlywoodThickness={setPlywoodThickness}
                  isHeatedFloor={isHeatedFloor}
                  setIsHeatedFloor={setIsHeatedFloor}
                  heatedFloorType={heatedFloorType}
                  setHeatedFloorType={setHeatedFloorType}
                  customHeatedFloorName={customHeatedFloorName}
                  setCustomHeatedFloorName={setCustomHeatedFloorName}
              />;
      }
  }

  return (
    <div className="min-h-screen bg-slate-50 font-sans">
      <TopNavBar activeModule={activeModule} setActiveModule={setActiveModule} />
      <div className="pt-32 pb-28 px-4">
        <div className="w-full max-w-lg mx-auto">
          
          <div className="p-6 sm:p-8">
              {renderActiveView()}
          </div>
          
          <footer className="text-center mt-10 text-sm text-slate-400">
              <p>Powered by Gemini</p>
          </footer>
        </div>
      </div>
      <BottomNavBar activeView={activeView} setActiveView={setActiveView} syncStatus={syncStatus} />
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        .animate-slide-up {
            animation: slideUp 0.3s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        /* Hide number input arrows */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
          -webkit-appearance: none; 
          margin: 0; 
        }
        input[type=number] {
          -moz-appearance: textfield;
        }
        .tab-scrollbar::-webkit-scrollbar {
            height: 4px;
        }
        .tab-scrollbar::-webkit-scrollbar-thumb {
            background-color: #e2e8f0; /* slate-200 */
            border-radius: 10px;
        }
        .tab-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .safe-area-padding {
            padding-bottom: env(safe-area-inset-bottom);
        }
      `}</style>
    </div>
  );
};

const TopNavBar = ({ activeModule, setActiveModule }) => {
    const navModules = [
        { id: 'demolition', label: 'Demolition', icon: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6 mb-1.5"><path d="m15 12-9.373 9.373a1 1 0 0 1-3.001-3L12 9"/><path d="m18 15 4-4"/><path d="m21.5 11.5-1.914-1.914A2 2 0 0 1 19 8.172v-.344a2 2 0 0 0-.586-1.414l-1.657-1.657A6 6 0 0 0 12.516 3H9l1.243 1.243A6 6 0 0 1 12 8.485V10l2 2h1.172a2 2 0 0 1 1.414.586L18.5 14.5"/></svg> },
        { id: 'shower-walls', label: 'Shower Walls', icon: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6 mb-1.5"><path d="m4 4 2.5 2.5"/><path d="M13.5 6.5a4.95 4.95 0 0 0-7 7"/><path d="M15 5 5 15"/><path d="M14 17v.01"/><path d="M10 16v.01"/><path d="M13 13v.01"/><path d="M16 10v.01"/><path d="M11 20v.01"/><path d="M17 14v.01"/><path d="M20 11v.01"/></svg> },
        { id: 'shower-base', label: 'Shower Base', icon: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6 mb-1.5"><rect width="18" height="18" x="3" y="3" rx="2"/><circle cx="12" cy="12" r="1"/></svg> },
        { id: 'floors', label: 'Floors', icon: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6 mb-1.5"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg> },
        { id: 'finishings', label: 'Finishings', icon: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6 mb-1.5"><path d="m14.622 17.897-10.68-2.913"/><path d="M18.376 2.622a1 1 0 1 1 3.002 3.002L17.36 9.643a.5.5 0 0 0 0 .707l.944.944a2.41 2.41 0 0 1 0 3.408l-.944.944a.5.5 0 0 1-.707 0L8.354 7.348a.5.5 0 0 1 0-.707l.944-.944a2.41 2.41 0 0 1 3.408 0l.944.944a.5.5 0 0 0 .707 0z"/><path d="M9 8c-1.804 2.71-3.97 3.46-6.583 3.948a.507.507 0 0 0-.302.819l7.32 8.883a1 1 0 0 0 1.185.204C12.735 20.405 16 16.792 16 15"/></svg> },
        { id: 'structural-other', label: 'Structural/Other', icon: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-ticket-minus-icon lucide-ticket-minus w-6 h-6 mb-1.5"><path d="M2 9a3 3 0 0 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 0 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/><path d="M9 12h6"/></svg> },
        { id: 'trade', label: 'Trade', icon: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-hard-hat-icon lucide-hard-hat w-6 h-6 mb-1.5"><path d="M10 10V5a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v5"/><path d="M14 6a6 6 0 0 1 6 6v3"/><path d="M4 15v-3a6 6 0 0 1 6-6"/><rect x="2" y="15" width="20" height="4" rx="1"/></svg> },
    ];

    return (
        <div className="fixed top-0 left-0 right-0 z-20 bg-white/80 backdrop-blur-sm shadow-sm px-4 sm:px-6">
            <div className="max-w-xl mx-auto py-3">
                <div className="tab-scrollbar flex space-x-4 overflow-x-auto">
                    {navModules.map(module => {
                        const isActive = activeModule === module.id;
                        const itemClass = isActive 
                            ? "flex flex-col items-center justify-center w-24 h-20 rounded-xl bg-white text-blue-600 shadow-md border-2 border-blue-500"
                            : "flex flex-col items-center justify-center w-24 h-20 rounded-xl bg-slate-100 text-slate-500 hover:bg-slate-200 transition-colors";
                        
                        return (
                            <button key={module.id} onClick={() => setActiveModule(module.id)} className="flex-shrink-0">
                                <div className={itemClass}>
                                    {module.icon}
                                    <span className="text-xs font-medium text-center px-1">{module.label}</span>
                                </div>
                            </button>
                        );
                    })}
                </div>
            </div>
        </div>
    );
};


const BottomNavBar = ({ activeView, setActiveView, syncStatus }) => {
    const [isMenuOpen, setIsMenuOpen] = useState(false);
    const menuRef = useRef(null);

    // Close menu when clicking outside
    useEffect(() => {
        const handleClickOutside = (event) => {
            if (menuRef.current && !menuRef.current.contains(event.target)) {
                setIsMenuOpen(false);
            }
        };
        document.addEventListener("mousedown", handleClickOutside);
        return () => {
            document.removeEventListener("mousedown", handleClickOutside);
        };
    }, [menuRef]);

    const navItems = [
        { id: 'design', label: 'Design', icon: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6 mb-1"><path d="M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z"/></svg> },
        { id: 'labor', label: 'Labor', icon: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6 mb-1"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg> },
        { id: 'materials', label: 'Materials', icon: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6 mb-1"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg> },
        { id: 'summary', label: 'Estimate', icon: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6 mb-1"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg> },
    ];
    
    const menuItems = [
        { id: 'pictures', label: 'Pictures', icon: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-5 h-5 text-slate-500"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg> },
        { id: 'notes', label: 'Notes', icon: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-5 h-5 text-slate-500"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg> },
        { id: 'send', label: 'Send Estimate', icon: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-5 h-5 text-slate-500"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg> },
        { id: 'insights', label: 'Insights', icon: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-5 h-5 text-slate-500"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg> },
        { id: 'settings', label: 'Settings', icon: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-5 h-5 text-slate-500"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg> },
    ];

    const handleMenuClick = (id) => {
        if (id === 'summary') {
            setActiveView('summary');
        }
        // Add logic for other menu items here in the future
        setIsMenuOpen(false); // Close menu after any item is clicked
    };

    const SyncIcon = () => {
        switch(syncStatus) {
            case 'Saving...':
                return <svg className="w-4 h-4 text-slate-500 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>;
            case 'Synced':
                return <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M5 13l4 4L19 7" /></svg>;
            default:
                 return <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;
        }
    };

    return (
        <div className="fixed bottom-0 left-0 right-0 z-20 bg-white/95 backdrop-blur-sm border-t border-slate-200 safe-area-padding">
            <div className="max-w-xl mx-auto">
                <div className="flex justify-center items-center pt-2 pb-1 text-xs text-slate-500 font-medium">
                    <SyncIcon />
                    <span className="ml-1.5">{syncStatus}</span>
                </div>
                <div className="flex justify-evenly py-2 border-t border-slate-100">
                    {navItems.map(item => {
                        const isActive = activeView === item.id;
                        const itemClass = isActive
                            ? "flex flex-col items-center justify-center w-20 h-16 rounded-xl transition-colors group text-blue-600 bg-blue-100"
                            : "flex flex-col items-center justify-center w-20 h-16 rounded-xl hover:bg-slate-100 transition-colors group text-slate-600";
                        
                        return (
                            <button
                                key={item.id}
                                onClick={() => setActiveView(item.id)}
                                className={itemClass}
                            >
                                {item.icon}
                                <span className="text-xs font-semibold">{item.label}</span>
                            </button>
                        );
                    })}
                    {/* Menu Item with Dropdown */}
                    <div className="relative" ref={menuRef}>
                        <button onClick={() => setIsMenuOpen(!isMenuOpen)} className="flex flex-col items-center justify-center w-20 h-16 rounded-xl hover:bg-slate-100 transition-colors group text-slate-600">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6 mb-1"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                            <span className="text-xs font-semibold">Menu</span>
                        </button>

                        {isMenuOpen && (
                            <div className="absolute right-0 bottom-full mb-3 w-56 bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden z-30 animate-fade-in">
                                {menuItems.map(item => (
                                    <a key={item.id} href="#" onClick={(e) => { e.preventDefault(); handleMenuClick(item.id); }} className="flex items-center gap-3 px-4 py-3 text-sm text-slate-700 hover:bg-slate-50 transition-colors">
                                        {item.icon}
                                        <span>{item.label}</span>
                                    </a>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
};

export default App;
