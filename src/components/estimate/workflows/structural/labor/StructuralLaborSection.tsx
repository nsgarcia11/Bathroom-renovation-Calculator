'use client';

import React, {
  useState,
  useEffect,
  useCallback,
  useMemo,
  useRef,
} from 'react';
import { Card, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { useEstimateWorkflowContext } from '@/contexts/EstimateWorkflowContext';
import { useContractorContext } from '@/contexts/ContractorContext';
import { Plus, Trash2, ChevronDown, ChevronRight } from 'lucide-react';

interface LaborItem {
  id: string;
  name: string;
  hours: string;
  rate: string;
  scope?: string;
  category?: 'design' | 'construction' | 'general';
  isAutoGenerated?: boolean;
  color?: string;
}

interface FlatFeeItem {
  id: string;
  name: string;
  unitPrice: string;
  description?: string;
  scope?: string;
  category?: 'design' | 'construction' | 'general';
  isAutoGenerated?: boolean;
  color?: string;
}

interface StructuralDesignData {
  // Wall Modifications
  frameNewWall: boolean;
  relocateWall: boolean;
  relocateWallLength: string;
  relocateWallHeight: string;
  removeNonLoadBearingWall: boolean;
  installBlocking: boolean;
  frameShowerNiche: boolean;
  addInsulation: boolean;

  // Floors
  repairSisterFloorJoists: boolean;
  levelFloor: boolean;
  installNewPlywoodSubfloor: boolean;
  plywoodThickness: '1/2' | '5/8' | '3/4';
  replaceRottenSubfloor: boolean;

  // Window & Door Openings
  addNewWindow: boolean;
  enlargeExistingWindow: boolean;
  changeDoorwayOpening: boolean;
  closeOffWindow: boolean;
}

export default function StructuralLaborSection() {
  const {
    getDesignData,
    getLaborItems,
    getFlatFeeItems,
    setLaborItems,
    setFlatFeeItems,
    isReloading,
  } = useEstimateWorkflowContext();

  const { hourlyRate: contractorHourlyRate } = useContractorContext();

  const designData = getDesignData('structural') as StructuralDesignData | null;
  const design = useMemo(
    () =>
      designData || {
        // Wall Modifications
        frameNewWall: false,
        relocateWall: false,
        relocateWallLength: '10',
        relocateWallHeight: '8',
        removeNonLoadBearingWall: false,
        installBlocking: false,
        frameShowerNiche: false,
        addInsulation: false,

        // Floors
        repairSisterFloorJoists: false,
        levelFloor: false,
        installNewPlywoodSubfloor: false,
        plywoodThickness: '3/4' as const,
        replaceRottenSubfloor: false,

        // Window & Door Openings
        addNewWindow: false,
        enlargeExistingWindow: false,
        changeDoorwayOpening: false,
        closeOffWindow: false,
      },
    [designData]
  );

  const [localLaborItems, setLocalLaborItems] = useState<LaborItem[]>([]);
  const [localFlatFeeItems, setLocalFlatFeeItems] = useState<FlatFeeItem[]>([]);
  const [isWallWorkOpen, setIsWallWorkOpen] = useState(true);
  const [isFloorsOpen, setIsFloorsOpen] = useState(true);
  const [isWindowDoorOpen, setIsWindowDoorOpen] = useState(true);

  // Refs to track user actions
  const userActionRef = useRef(false);
  const processedChoicesRef = useRef<string>('');

  // Get current items from context
  const contextLaborItems = getLaborItems('structural');
  const contextFlatFeeItems = getFlatFeeItems('structural');

  // Note: studCount is calculated in materials section for material quantities

  // Auto-populate labor items based on selected tasks
  useEffect(() => {
    if (isReloading || userActionRef.current) {
      userActionRef.current = false;
      return;
    }

    const newLaborItems: LaborItem[] = [];
    const newFlatFeeItems: FlatFeeItem[] = [];

    // Wall Modifications
    if (design.frameNewWall) {
      newLaborItems.push({
        id: 'frame-new-wall',
        name: 'Frame new wall(s)',
        hours: '6',
        rate: contractorHourlyRate.toString(),
        category: 'construction',
        isAutoGenerated: true,
        color: 'blue',
      });
    }

    if (design.relocateWall) {
      newLaborItems.push({
        id: 'relocate-wall',
        name: 'Relocate wall',
        hours: '10',
        rate: contractorHourlyRate.toString(),
        category: 'construction',
        isAutoGenerated: true,
        color: 'blue',
      });
    }

    if (design.removeNonLoadBearingWall) {
      newLaborItems.push({
        id: 'remove-wall',
        name: 'Remove non-load bearing wall',
        hours: '6',
        rate: contractorHourlyRate.toString(),
        category: 'construction',
        isAutoGenerated: true,
        color: 'blue',
      });
    }

    if (design.installBlocking) {
      newLaborItems.push({
        id: 'install-blocking',
        name: 'Install blocking',
        hours: '2',
        rate: contractorHourlyRate.toString(),
        category: 'construction',
        isAutoGenerated: true,
        color: 'blue',
      });
    }

    if (design.frameShowerNiche) {
      newLaborItems.push({
        id: 'frame-shower-niche',
        name: 'Frame shower niche',
        hours: '2.5',
        rate: contractorHourlyRate.toString(),
        category: 'construction',
        isAutoGenerated: true,
        color: 'blue',
      });
    }

    if (design.addInsulation) {
      newLaborItems.push({
        id: 'add-insulation',
        name: 'Add insulation',
        hours: '2',
        rate: contractorHourlyRate.toString(),
        category: 'construction',
        isAutoGenerated: true,
        color: 'blue',
      });
    }

    // Floors
    if (design.repairSisterFloorJoists) {
      newLaborItems.push({
        id: 'repair-floor-joists',
        name: 'Repair / sister floor joists',
        hours: '5',
        rate: contractorHourlyRate.toString(),
        category: 'construction',
        isAutoGenerated: true,
        color: 'green',
      });
    }

    if (design.levelFloor) {
      newLaborItems.push({
        id: 'level-floor',
        name: 'Level floor',
        hours: '3',
        rate: contractorHourlyRate.toString(),
        category: 'construction',
        isAutoGenerated: true,
        color: 'green',
      });
    }

    if (design.installNewPlywoodSubfloor) {
      newLaborItems.push({
        id: 'install-plywood',
        name: 'Install new plywood subfloor',
        hours: '3',
        rate: contractorHourlyRate.toString(),
        category: 'construction',
        isAutoGenerated: true,
        color: 'green',
      });
    }

    if (design.replaceRottenSubfloor) {
      newLaborItems.push({
        id: 'replace-subfloor',
        name: 'Replace rotten subfloor',
        hours: '6',
        rate: contractorHourlyRate.toString(),
        category: 'construction',
        isAutoGenerated: true,
        color: 'green',
      });
    }

    // Window & Door Openings
    if (design.addNewWindow) {
      newLaborItems.push({
        id: 'add-new-window',
        name: 'Add new window',
        hours: '6',
        rate: contractorHourlyRate.toString(),
        category: 'construction',
        isAutoGenerated: true,
        color: 'purple',
      });
    }

    if (design.enlargeExistingWindow) {
      newLaborItems.push({
        id: 'enlarge-window',
        name: 'Enlarge existing window',
        hours: '6',
        rate: contractorHourlyRate.toString(),
        category: 'construction',
        isAutoGenerated: true,
        color: 'purple',
      });
    }

    if (design.changeDoorwayOpening) {
      newLaborItems.push({
        id: 'change-doorway',
        name: 'Change doorway opening',
        hours: '4',
        rate: contractorHourlyRate.toString(),
        category: 'construction',
        isAutoGenerated: true,
        color: 'purple',
      });
    }

    if (design.closeOffWindow) {
      newLaborItems.push({
        id: 'close-window',
        name: 'Close off window',
        hours: '5',
        rate: contractorHourlyRate.toString(),
        category: 'construction',
        isAutoGenerated: true,
        color: 'purple',
      });
    }

    // Update context
    setLaborItems('structural', newLaborItems);
    setFlatFeeItems('structural', newFlatFeeItems);
    setLocalLaborItems(newLaborItems);
    setLocalFlatFeeItems(newFlatFeeItems);

    // Update processed choices
    const choicesString = JSON.stringify(design);
    processedChoicesRef.current = choicesString;
  }, [
    design,
    contractorHourlyRate,
    isReloading,
    setLaborItems,
    setFlatFeeItems,
  ]);

  // Sync with context changes
  useEffect(() => {
    if (!isReloading) {
      setLocalLaborItems(contextLaborItems);
      setLocalFlatFeeItems(contextFlatFeeItems);
    }
  }, [contextLaborItems, contextFlatFeeItems, isReloading]);

  // Handlers
  const handleAddLaborItem = useCallback(() => {
    const newItem: LaborItem = {
      id: `labor-${Date.now()}`,
      name: '',
      hours: '1',
      rate: contractorHourlyRate.toString(),
      category: 'construction',
      isAutoGenerated: false,
      color: 'gray',
    };

    const updatedItems = [...localLaborItems, newItem];
    setLocalLaborItems(updatedItems);
    setLaborItems('structural', updatedItems);
    userActionRef.current = true;
  }, [localLaborItems, contractorHourlyRate, setLaborItems]);

  const handleUpdateLaborItem = useCallback(
    (id: string, field: keyof LaborItem, value: string) => {
      const updatedItems = localLaborItems.map((item) =>
        item.id === id ? { ...item, [field]: value } : item
      );
      setLocalLaborItems(updatedItems);
      setLaborItems('structural', updatedItems);
      userActionRef.current = true;
    },
    [localLaborItems, setLaborItems]
  );

  const handleDeleteLaborItem = useCallback(
    (id: string) => {
      const updatedItems = localLaborItems.filter((item) => item.id !== id);
      setLocalLaborItems(updatedItems);
      setLaborItems('structural', updatedItems);
      userActionRef.current = true;
    },
    [localLaborItems, setLaborItems]
  );

  // Flat fee handlers removed as they're not used in structural workflow

  // Calculate totals
  const laborTotal = useMemo(() => {
    return localLaborItems.reduce((total, item) => {
      const hours = parseFloat(item.hours) || 0;
      const rate = parseFloat(item.rate) || 0;
      return total + hours * rate;
    }, 0);
  }, [localLaborItems]);

  const flatFeeTotal = useMemo(() => {
    return localFlatFeeItems.reduce((total, item) => {
      const price = parseFloat(item.unitPrice) || 0;
      return total + price;
    }, 0);
  }, [localFlatFeeItems]);

  const grandTotal = laborTotal + flatFeeTotal;

  // Group items by category
  const wallWorkItems = localLaborItems.filter((item) => item.color === 'blue');
  const floorsItems = localLaborItems.filter((item) => item.color === 'green');
  const windowDoorItems = localLaborItems.filter(
    (item) => item.color === 'purple'
  );
  const customItems = localLaborItems.filter((item) => item.color === 'gray');

  const renderLaborItem = (item: LaborItem) => (
    <div
      key={item.id}
      className={`p-3 rounded-lg border bg-white border-gray-200`}
    >
      <div className='flex items-center gap-3'>
        <div className='flex-1'>
          <Input
            value={item.name}
            onChange={(e) =>
              handleUpdateLaborItem(item.id, 'name', e.target.value)
            }
            placeholder='Item name'
            className='font-medium'
          />
        </div>
        <div className='w-20'>
          <Input
            type='number'
            value={item.hours}
            onChange={(e) =>
              handleUpdateLaborItem(item.id, 'hours', e.target.value)
            }
            placeholder='Hours'
            className='text-center'
          />
        </div>
        <div className='w-24'>
          <Input
            type='number'
            value={item.rate}
            onChange={(e) =>
              handleUpdateLaborItem(item.id, 'rate', e.target.value)
            }
            placeholder='Rate'
            className='text-center'
          />
        </div>
        <div className='w-24 text-right font-semibold text-gray-700'>
          ${(parseFloat(item.hours) * parseFloat(item.rate)).toFixed(2)}
        </div>
        {!item.isAutoGenerated && (
          <Button
            onClick={() => handleDeleteLaborItem(item.id)}
            variant='ghost'
            size='sm'
            className='p-1 text-red-500 hover:text-red-700'
          >
            <Trash2 size={16} />
          </Button>
        )}
      </div>
    </div>
  );

  return (
    <div className='space-y-6'>
      <div className='pt-2'>
        <div className='flex justify-between items-baseline'>
          <h2 className='text-2xl font-bold text-slate-800'>Labor</h2>
          <div className='text-xl font-bold text-blue-600'>
            ${laborTotal.toFixed(2)}
          </div>
        </div>
      </div>

      {/* Wall Work */}
      <Card>
        <CardContent className='p-0'>
          <div
            className='flex items-center justify-between p-4 cursor-pointer hover:bg-gray-50'
            onClick={() => setIsWallWorkOpen(!isWallWorkOpen)}
          >
            <h3 className='text-lg font-semibold text-gray-900'>Wall Work</h3>
            {isWallWorkOpen ? (
              <ChevronDown className='h-5 w-5 text-gray-500' />
            ) : (
              <ChevronRight className='h-5 w-5 text-gray-500' />
            )}
          </div>
          {isWallWorkOpen && (
            <div className='px-4 pb-4 space-y-3'>
              {wallWorkItems.length > 0 ? (
                wallWorkItems.map(renderLaborItem)
              ) : (
                <div className='text-center py-8 text-gray-500'>
                  No wall work items yet. Select tasks in the Design section to
                  auto-populate items.
                </div>
              )}
            </div>
          )}
        </CardContent>
      </Card>

      {/* Floors */}
      <Card>
        <CardContent className='p-0'>
          <div
            className='flex items-center justify-between p-4 cursor-pointer hover:bg-gray-50'
            onClick={() => setIsFloorsOpen(!isFloorsOpen)}
          >
            <h3 className='text-lg font-semibold text-gray-900'>Floors</h3>
            {isFloorsOpen ? (
              <ChevronDown className='h-5 w-5 text-gray-500' />
            ) : (
              <ChevronRight className='h-5 w-5 text-gray-500' />
            )}
          </div>
          {isFloorsOpen && (
            <div className='px-4 pb-4 space-y-3'>
              {floorsItems.length > 0 ? (
                floorsItems.map(renderLaborItem)
              ) : (
                <div className='text-center py-8 text-gray-500'>
                  No floor work items yet. Select tasks in the Design section to
                  auto-populate items.
                </div>
              )}
            </div>
          )}
        </CardContent>
      </Card>

      {/* Window & Door Openings */}
      <Card>
        <CardContent className='p-0'>
          <div
            className='flex items-center justify-between p-4 cursor-pointer hover:bg-gray-50'
            onClick={() => setIsWindowDoorOpen(!isWindowDoorOpen)}
          >
            <h3 className='text-lg font-semibold text-gray-900'>
              Window & Door Openings
            </h3>
            {isWindowDoorOpen ? (
              <ChevronDown className='h-5 w-5 text-gray-500' />
            ) : (
              <ChevronRight className='h-5 w-5 text-gray-500' />
            )}
          </div>
          {isWindowDoorOpen && (
            <div className='px-4 pb-4 space-y-3'>
              {windowDoorItems.length > 0 ? (
                windowDoorItems.map(renderLaborItem)
              ) : (
                <div className='text-center py-8 text-gray-500'>
                  No window/door work items yet. Select tasks in the Design
                  section to auto-populate items.
                </div>
              )}
            </div>
          )}
        </CardContent>
      </Card>

      {/* Custom Items */}
      <Card>
        <CardContent className='p-0'>
          <div className='flex items-center justify-between p-4'>
            <h3 className='text-lg font-semibold text-gray-900'>
              Custom Items
            </h3>
            <Button
              onClick={handleAddLaborItem}
              variant='outline'
              size='sm'
              className='flex items-center gap-2'
            >
              <Plus size={16} />
              Add Labor Item
            </Button>
          </div>
          <div className='px-4 pb-4 space-y-3'>
            {customItems.length > 0 ? (
              customItems.map(renderLaborItem)
            ) : (
              <div className='text-center py-8 text-gray-500'>
                No custom items yet. Click &quot;Add Labor Item&quot; to create
                one.
              </div>
            )}
          </div>
        </CardContent>
      </Card>

      {/* Totals */}
      <Card>
        <CardContent className='p-4'>
          <div className='space-y-2'>
            <div className='flex justify-between items-center'>
              <span className='text-lg font-medium text-gray-700'>
                Labor Total:
              </span>
              <span className='text-lg font-semibold text-gray-900'>
                ${laborTotal.toFixed(2)}
              </span>
            </div>
            <div className='flex justify-between items-center'>
              <span className='text-lg font-medium text-gray-700'>
                Flat Fee Total:
              </span>
              <span className='text-lg font-semibold text-gray-900'>
                ${flatFeeTotal.toFixed(2)}
              </span>
            </div>
            <div className='border-t pt-2'>
              <div className='flex justify-between items-center'>
                <span className='text-xl font-bold text-gray-900'>
                  Grand Total:
                </span>
                <span className='text-2xl font-bold text-blue-600'>
                  ${grandTotal.toFixed(2)}
                </span>
              </div>
            </div>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}
