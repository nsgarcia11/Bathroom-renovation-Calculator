'use client';

import React, {
  useState,
  useEffect,
  useCallback,
  useMemo,
  useRef,
} from 'react';
import { Card, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { useEstimateWorkflowContext } from '@/contexts/EstimateWorkflowContext';
import { Plus, Trash2, ChevronDown, ChevronRight } from 'lucide-react';

interface MaterialItem {
  id: string;
  name: string;
  quantity: string;
  price: string;
  unit: string;
  scope?: string;
  category?: 'design' | 'construction' | 'general';
  isAutoGenerated?: boolean;
  color?: string;
  source?: string;
}

interface StructuralDesignData {
  // Wall Modifications
  frameNewWall: boolean;
  relocateWall: boolean;
  relocateWallLength: string;
  relocateWallHeight: string;
  removeNonLoadBearingWall: boolean;
  installBlocking: boolean;
  frameShowerNiche: boolean;
  addInsulation: boolean;
  changeDoorwayOpening: boolean;

  // Floors
  repairSisterFloorJoists: boolean;
  levelFloor: boolean;
  installNewPlywoodSubfloor: boolean;
  plywoodThickness: '1/2' | '5/8' | '3/4';
  replaceRottenSubfloor: boolean;
}

interface FloorsDesignData {
  width: string;
  length: string;
  extraMeasurements?: Array<{
    id: number;
    label: string;
    width: string;
    length: string;
  }>;
}

export default function StructuralMaterialsSection() {
  const { getDesignData, getMaterialItems, setMaterialItems, isReloading } =
    useEstimateWorkflowContext();

  const designData = getDesignData('structural') as StructuralDesignData | null;
  const design = useMemo(
    () =>
      designData || {
        // Wall Modifications
        frameNewWall: false,
        relocateWall: false,
        relocateWallLength: '8',
        relocateWallHeight: '8',
        removeNonLoadBearingWall: false,
        installBlocking: false,
        frameShowerNiche: false,
        addInsulation: false,
        changeDoorwayOpening: false,

        // Floors
        repairSisterFloorJoists: false,
        levelFloor: false,
        installNewPlywoodSubfloor: false,
        plywoodThickness: '3/4' as const,
        replaceRottenSubfloor: false,
      },
    [designData]
  );

  // Get floors design data for floor measurements
  const floorsDesignData = getDesignData('floors') as FloorsDesignData | null;

  // Calculate plywood sheet count from floor area (each 4x8 sheet = 32 sq ft)
  const plywoodSheetCount = useMemo(() => {
    let totalArea = 0;
    const mainWidth = parseFloat(floorsDesignData?.width || '0') || 0;
    const mainLength = parseFloat(floorsDesignData?.length || '0') || 0;

    if (mainWidth > 0 && mainLength > 0) {
      totalArea += (mainWidth * mainLength) / 144; // Convert sq inches to sq ft
    }

    // Add extra measurements if any
    if (floorsDesignData?.extraMeasurements && Array.isArray(floorsDesignData.extraMeasurements)) {
      floorsDesignData.extraMeasurements.forEach((m) => {
        const sideWidth = parseFloat(m.width) || 0;
        const sideLength = parseFloat(m.length) || 0;
        if (sideWidth > 0 && sideLength > 0) {
          totalArea += (sideWidth * sideLength) / 144;
        }
      });
    }

    // Calculate sheets: ceil(sqft / 32), minimum 1 sheet
    return totalArea > 0 ? Math.max(1, Math.ceil(totalArea / 32)) : 1;
  }, [floorsDesignData]);

  const [localMaterialItems, setLocalMaterialItems] = useState<MaterialItem[]>(
    []
  );
  const [isWallWorkOpen, setIsWallWorkOpen] = useState(true);
  const [isFloorsOpen, setIsFloorsOpen] = useState(true);
  const [isCustomOpen, setIsCustomOpen] = useState(true);
  const userActionRef = useRef(false);
  const processedChoicesRef = useRef<string>('');

  // Get current items from context
  const contextMaterialItems = getMaterialItems('structural');

  // Calculate stud count for relocate wall
  const studCount = useMemo(() => {
    const length = parseFloat(design.relocateWallLength) || 0;
    return Math.ceil(length * 1.25); // 1.25 studs per foot
  }, [design.relocateWallLength]);

  // Auto-populate material items based on selected tasks
  useEffect(() => {
    if (isReloading || userActionRef.current) {
      userActionRef.current = false;
      return;
    }

    // Create a key based on all design choices to detect changes
    const choicesKey = `${design.frameNewWall}-${design.relocateWall}-${design.relocateWallLength}-${design.relocateWallHeight}-${design.removeNonLoadBearingWall}-${design.installBlocking}-${design.frameShowerNiche}-${design.addInsulation}-${design.changeDoorwayOpening}-${design.repairSisterFloorJoists}-${design.levelFloor}-${design.installNewPlywoodSubfloor}-${design.plywoodThickness}-${design.replaceRottenSubfloor}-${plywoodSheetCount}`;

    // Skip if choices haven't changed
    if (processedChoicesRef.current === choicesKey) return;

    // Preserve custom items (non-auto-generated)
    const contextMaterials = contextMaterialItems || [];
    const customMaterialItems = contextMaterials.filter(
      (item) => item.isAutoGenerated === false
    );

    const newMaterialItems: MaterialItem[] = [];

    // =========================================================================
    // WALL MODIFICATIONS
    // =========================================================================

    // A) Frame new wall(s)
    // Materials: 2x4 studs (qty 15 @ $3.38), PT bottom plate (qty 2 @ $10), framing nails (qty 1 @ $15)
    if (design.frameNewWall) {
      newMaterialItems.push(
        {
          id: 'frame-new-wall-studs',
          name: '2×4 studs (8ft)',
          quantity: '15',
          price: '3.38',
          unit: 'each',
          category: 'construction',
          isAutoGenerated: true,
          color: 'blue',
        },
        {
          id: 'frame-new-wall-plate',
          name: 'PT bottom plate',
          quantity: '2',
          price: '10.00',
          unit: 'each',
          category: 'construction',
          isAutoGenerated: true,
          color: 'blue',
        },
        {
          id: 'frame-new-wall-nails',
          name: 'Framing nails',
          quantity: '1',
          price: '15.00',
          unit: 'box',
          category: 'construction',
          isAutoGenerated: true,
          color: 'blue',
        }
      );
    }

    // B) Relocate wall (dynamic based on length)
    // Stud quantity = ceil(length × 1.25)
    // Materials: studs (dynamic qty @ $3.38), nails (qty 1), garbage bags (qty 1)
    if (design.relocateWall) {
      newMaterialItems.push(
        {
          id: 'relocate-wall-studs',
          name: '2×4 studs (8ft)',
          quantity: studCount.toString(),
          price: '3.38',
          unit: 'each',
          category: 'construction',
          isAutoGenerated: true,
          color: 'blue',
        },
        {
          id: 'relocate-wall-nails',
          name: 'Framing nails',
          quantity: '1',
          price: '15.00',
          unit: 'box',
          category: 'construction',
          isAutoGenerated: true,
          color: 'blue',
        },
        {
          id: 'relocate-wall-garbage',
          name: 'Garbage bags',
          quantity: '1',
          price: '12.00',
          unit: 'box',
          category: 'construction',
          isAutoGenerated: true,
          color: 'blue',
        }
      );
    }

    // C) Remove non-load bearing wall - No materials

    // D) Install blocking for accessories
    // Materials: 2x6 boards (qty 2)
    if (design.installBlocking) {
      newMaterialItems.push({
        id: 'install-blocking-lumber',
        name: '2×6 boards (8ft)',
        quantity: '2',
        price: '8.50',
        unit: 'each',
        category: 'construction',
        isAutoGenerated: true,
        color: 'blue',
      });
    }

    // E) Frame shower niche
    // Materials: 2x4 studs (qty 3)
    if (design.frameShowerNiche) {
      newMaterialItems.push({
        id: 'frame-shower-niche-lumber',
        name: '2×4 studs (8ft)',
        quantity: '3',
        price: '3.38',
        unit: 'each',
        category: 'construction',
        isAutoGenerated: true,
        color: 'blue',
      });
    }

    // F) Add insulation
    // Materials: R-22 batts (qty 1), 6mil poly (qty 1), acoustic sealant (qty 2)
    if (design.addInsulation) {
      newMaterialItems.push(
        {
          id: 'add-insulation-batt',
          name: 'R-22 Batt insulation',
          quantity: '1',
          price: '105.00',
          unit: 'bag',
          category: 'construction',
          isAutoGenerated: true,
          color: 'blue',
        },
        {
          id: 'add-insulation-poly',
          name: '6mil poly vapor barrier',
          quantity: '1',
          price: '35.00',
          unit: 'roll',
          category: 'construction',
          isAutoGenerated: true,
          color: 'blue',
        },
        {
          id: 'add-insulation-sealant',
          name: 'Acoustic sealant',
          quantity: '2',
          price: '8.50',
          unit: 'tube',
          category: 'construction',
          isAutoGenerated: true,
          color: 'blue',
        }
      );
    }

    // G) Change doorway opening (non-load bearing)
    // Materials: 2x4 Lumber (8ft) (qty 6 @ $5.00/stud)
    if (design.changeDoorwayOpening) {
      newMaterialItems.push({
        id: 'change-doorway-lumber',
        name: '2×4 Lumber (8ft)',
        quantity: '6',
        price: '5.00',
        unit: 'stud',
        category: 'construction',
        isAutoGenerated: true,
        color: 'blue',
      });
    }

    // =========================================================================
    // FLOORS
    // =========================================================================

    // A) Repair / sister floor joists
    // Materials: 2x8 lumber (qty 2), structural screws (qty 1), adhesive (qty 2)
    if (design.repairSisterFloorJoists) {
      newMaterialItems.push(
        {
          id: 'repair-joists-lumber',
          name: '2×8 lumber',
          quantity: '2',
          price: '15.00',
          unit: 'each',
          category: 'construction',
          isAutoGenerated: true,
          color: 'green',
        },
        {
          id: 'repair-joists-screws',
          name: 'Structural screws',
          quantity: '1',
          price: '18.00',
          unit: 'box',
          category: 'construction',
          isAutoGenerated: true,
          color: 'green',
        },
        {
          id: 'repair-joists-adhesive',
          name: 'Construction adhesive',
          quantity: '2',
          price: '8.00',
          unit: 'tube',
          category: 'construction',
          isAutoGenerated: true,
          color: 'green',
        }
      );
    }

    // B) Level floor (self-leveling)
    // Materials: self leveler (qty 2), primer (qty 1)
    if (design.levelFloor) {
      newMaterialItems.push(
        {
          id: 'level-floor-compound',
          name: 'Self-leveling compound (50lb)',
          quantity: '2',
          price: '40.00',
          unit: 'bag',
          category: 'construction',
          isAutoGenerated: true,
          color: 'green',
        },
        {
          id: 'level-floor-primer',
          name: 'Self-leveling primer',
          quantity: '1',
          price: '35.00',
          unit: 'gal',
          category: 'construction',
          isAutoGenerated: true,
          color: 'green',
        }
      );
    }

    // C) Install new plywood subfloor (with thickness selector)
    // Materials: plywood (qty = ceil(floorSqFt / 32) sheets), flooring screws (qty 1), subfloor glue (qty 4)
    if (design.installNewPlywoodSubfloor) {
      const thicknessName =
        design.plywoodThickness === '1/2'
          ? '1/2"'
          : design.plywoodThickness === '5/8'
          ? '5/8"'
          : '3/4"';
      const thicknessPrice =
        design.plywoodThickness === '1/2'
          ? '45.00'
          : design.plywoodThickness === '5/8'
          ? '60.00'
          : '70.00';

      newMaterialItems.push(
        {
          id: 'install-plywood-sheets',
          name: `Plywood subfloor ${thicknessName}`,
          quantity: plywoodSheetCount.toString(),
          price: thicknessPrice,
          unit: 'sheet',
          category: 'construction',
          isAutoGenerated: true,
          color: 'green',
        },
        {
          id: 'install-plywood-screws',
          name: 'Flooring screws',
          quantity: '1',
          price: '15.00',
          unit: 'box',
          category: 'construction',
          isAutoGenerated: true,
          color: 'green',
        },
        {
          id: 'install-plywood-glue',
          name: 'Subfloor glue',
          quantity: '4',
          price: '8.00',
          unit: 'tube',
          category: 'construction',
          isAutoGenerated: true,
          color: 'green',
        }
      );
    }

    // D) Replace rotten subfloor
    // Materials: plywood (qty = ceil(floorSqFt / 32) sheets), blocking studs (qty 4)
    if (design.replaceRottenSubfloor) {
      newMaterialItems.push(
        {
          id: 'replace-subfloor-plywood',
          name: '5/8" plywood',
          quantity: plywoodSheetCount.toString(),
          price: '60.00',
          unit: 'sheet',
          category: 'construction',
          isAutoGenerated: true,
          color: 'green',
        },
        {
          id: 'replace-subfloor-studs',
          name: '2×4 blocking studs',
          quantity: '4',
          price: '3.38',
          unit: 'each',
          category: 'construction',
          isAutoGenerated: true,
          color: 'green',
        }
      );
    }

    // Merge custom items with auto-generated items
    const mergedMaterialItems = [...customMaterialItems, ...newMaterialItems];

    // Always update when design changed - use context items for the check
    if (mergedMaterialItems.length > 0 || contextMaterials.length > 0) {
      setMaterialItems('structural', mergedMaterialItems);
      setLocalMaterialItems(mergedMaterialItems);
    }

    // Update processed choices key
    processedChoicesRef.current = choicesKey;
  }, [design, studCount, plywoodSheetCount, isReloading, setMaterialItems, contextMaterialItems]);

  // Sync with context changes
  useEffect(() => {
    if (!isReloading) {
      setLocalMaterialItems(contextMaterialItems);
    }
  }, [contextMaterialItems, isReloading]);

  // Handlers
  const handleAddMaterialItem = useCallback(() => {
    const newItem: MaterialItem = {
      id: `material-${Date.now()}`,
      name: '',
      quantity: '1',
      price: '0',
      unit: '',
      category: 'construction',
      isAutoGenerated: false,
      color: 'gray',
    };

    const updatedItems = [...localMaterialItems, newItem];
    setLocalMaterialItems(updatedItems);
    setMaterialItems('structural', updatedItems);
    userActionRef.current = true;
  }, [localMaterialItems, setMaterialItems]);

  const handleUpdateMaterialItem = useCallback(
    (id: string, field: keyof MaterialItem, value: string) => {
      const updatedItems = localMaterialItems.map((item) =>
        item.id === id ? { ...item, [field]: value } : item
      );
      setLocalMaterialItems(updatedItems);
      setMaterialItems('structural', updatedItems);
      userActionRef.current = true;
    },
    [localMaterialItems, setMaterialItems]
  );

  const handleDeleteMaterialItem = useCallback(
    (id: string) => {
      const updatedItems = localMaterialItems.filter((item) => item.id !== id);
      setLocalMaterialItems(updatedItems);
      setMaterialItems('structural', updatedItems);
      userActionRef.current = true;
    },
    [localMaterialItems, setMaterialItems]
  );

  // Calculate totals
  const materialTotal = useMemo(() => {
    return localMaterialItems.reduce((total, item) => {
      const quantity = parseFloat(item.quantity) || 0;
      const price = parseFloat(item.price) || 0;
      return total + quantity * price;
    }, 0);
  }, [localMaterialItems]);

  // Group items by category
  const wallWorkItems = localMaterialItems.filter(
    (item) => item.color === 'blue'
  );
  const floorsItems = localMaterialItems.filter(
    (item) => item.color === 'green'
  );
  const customItems = localMaterialItems.filter(
    (item) => item.color === 'gray'
  );

  // Calculate totals for each category
  const wallWorkTotal = wallWorkItems.reduce(
    (sum, item) =>
      sum + (parseFloat(item.quantity) || 0) * (parseFloat(item.price) || 0),
    0
  );

  const floorsTotal = floorsItems.reduce(
    (sum, item) =>
      sum + (parseFloat(item.quantity) || 0) * (parseFloat(item.price) || 0),
    0
  );

  const customTotal = customItems.reduce(
    (sum, item) =>
      sum + (parseFloat(item.quantity) || 0) * (parseFloat(item.price) || 0),
    0
  );

  const renderMaterialItem = useCallback(
    (item: MaterialItem) => (
      <div
        key={item.id}
        className='p-3 bg-white rounded-lg border border-slate-200 shadow-sm w-full'
      >
        <div className='flex items-center gap-2 mb-2 w-full'>
          <Input
            type='text'
            value={item.name}
            onChange={(e) =>
              handleUpdateMaterialItem(item.id, 'name', e.target.value)
            }
            placeholder='Material Name'
            className='border-b-2 border-t-0 border-l-0 border-r-0 bg-transparent border-blue-300 focus:border-blue-500 focus:outline-none w-44 sm:w-full'
          />
          <Button
            onClick={() => handleDeleteMaterialItem(item.id)}
            variant='ghost'
            size='sm'
            className='text-red-500 hover:text-red-700 p-1 h-auto flex-shrink-0'
          >
            <Trash2 size={16} />
          </Button>
        </div>
        <div className='grid grid-cols-2 gap-3'>
          <div className='w-full'>
            <label className='text-xs text-slate-500'>Quantity</label>
            <Input
              type='number'
              value={item.quantity}
              onChange={(e) =>
                handleUpdateMaterialItem(item.id, 'quantity', e.target.value)
              }
              placeholder='0'
              className='text-center w-full border-blue-300 focus:border-blue-500'
            />
          </div>
          <div className='w-full'>
            <label className='text-xs text-slate-500'>Price/Unit ($)</label>
            <Input
              type='number'
              value={item.price}
              onChange={(e) =>
                handleUpdateMaterialItem(item.id, 'price', e.target.value)
              }
              placeholder='0.00'
              className='text-center w-full border-blue-300 focus:border-blue-500'
            />
          </div>
          <div className='col-span-2 w-full'>
            <label className='text-xs text-slate-500'>Total</label>
            <div className='w-full p-2 text-center font-semibold text-slate-800 bg-slate-50 rounded-md'>
              $
              {(
                (parseFloat(item.quantity) || 0) * (parseFloat(item.price) || 0)
              ).toFixed(2)}
            </div>
          </div>
        </div>
      </div>
    ),
    [handleUpdateMaterialItem, handleDeleteMaterialItem]
  );

  return (
    <div className='space-y-5'>
      <div className='flex justify-between items-center'>
        <h2 className='text-2xl font-bold text-slate-800'>
          Materials & Supplies
        </h2>
        <div className='text-right'>
          <p className='font-bold text-blue-600 text-lg'>
            ${materialTotal.toFixed(2)}
          </p>
        </div>
      </div>

      <div className='space-y-4'>
        {/* Wall Work */}
        <Card>
          <CardContent className='p-3 space-y-3'>
            <div
              className='flex justify-between items-center cursor-pointer'
              onClick={() => setIsWallWorkOpen(!isWallWorkOpen)}
            >
              <div className='flex items-center gap-2 justify-between w-full'>
                <div className='flex items-center gap-2'>
                  {isWallWorkOpen ? (
                    <ChevronDown className='h-4 w-4 text-slate-600' />
                  ) : (
                    <ChevronRight className='h-4 w-4 text-slate-600' />
                  )}
                  <h3 className='text-lg font-semibold text-slate-700'>
                    Wall Work
                  </h3>
                </div>
                <p className='font-bold text-blue-600 text-sm'>
                  ${wallWorkTotal.toFixed(2)}
                </p>
              </div>
            </div>
            {isWallWorkOpen && (
              <>
                {wallWorkItems.length > 0 ? (
                  <div className='space-y-2'>
                    {wallWorkItems.map(renderMaterialItem)}
                  </div>
                ) : (
                  <p className='text-sm text-slate-500 text-center py-4'>
                    No wall work materials added yet. Select tasks in Design section.
                  </p>
                )}
              </>
            )}
          </CardContent>
        </Card>

        {/* Floors */}
        <Card>
          <CardContent className='p-3 space-y-3'>
            <div
              className='flex justify-between items-center cursor-pointer'
              onClick={() => setIsFloorsOpen(!isFloorsOpen)}
            >
              <div className='flex items-center gap-2 justify-between w-full'>
                <div className='flex items-center gap-2'>
                  {isFloorsOpen ? (
                    <ChevronDown className='h-4 w-4 text-slate-600' />
                  ) : (
                    <ChevronRight className='h-4 w-4 text-slate-600' />
                  )}
                  <h3 className='text-lg font-semibold text-slate-700'>
                    Floors
                  </h3>
                </div>
                <p className='font-bold text-blue-600 text-sm'>
                  ${floorsTotal.toFixed(2)}
                </p>
              </div>
            </div>
            {isFloorsOpen && (
              <>
                {floorsItems.length > 0 ? (
                  <div className='space-y-2'>
                    {floorsItems.map(renderMaterialItem)}
                  </div>
                ) : (
                  <p className='text-sm text-slate-500 text-center py-4'>
                    No floor materials added yet. Select tasks in Design section.
                  </p>
                )}
              </>
            )}
          </CardContent>
        </Card>

        {/* Custom Items */}
        <Card>
          <CardContent className='p-3 space-y-3'>
            <div
              className='flex justify-between items-center cursor-pointer'
              onClick={() => setIsCustomOpen(!isCustomOpen)}
            >
              <div className='flex items-center gap-2 justify-between w-full'>
                <div className='flex items-center gap-2'>
                  {isCustomOpen ? (
                    <ChevronDown className='h-4 w-4 text-slate-600' />
                  ) : (
                    <ChevronRight className='h-4 w-4 text-slate-600' />
                  )}
                  <h3 className='text-lg font-semibold text-slate-700'>
                    Custom Items
                  </h3>
                </div>
                <p className='font-bold text-blue-600 text-sm'>
                  ${customTotal.toFixed(2)}
                </p>
              </div>
            </div>
            {isCustomOpen && (
              <>
                {customItems.length > 0 ? (
                  <div className='space-y-2'>
                    {customItems.map(renderMaterialItem)}
                  </div>
                ) : (
                  <p className='text-sm text-slate-500 text-center py-4'>
                    No custom materials added yet.
                  </p>
                )}
                <div className='flex justify-center'>
                  <Button
                    onClick={handleAddMaterialItem}
                    variant='default'
                    className='w-auto mt-2 flex items-center justify-center gap-2 py-2.5 px-4 text-white font-semibold border-blue-200'
                  >
                    <Plus size={16} />
                    Add Item
                  </Button>
                </div>
              </>
            )}
          </CardContent>
        </Card>
      </div>
    </div>
  );
}
