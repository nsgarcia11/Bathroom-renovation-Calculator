'use client';

import React, {
  useMemo,
  useCallback,
  useState,
  useEffect,
  useRef,
} from 'react';
import { Card, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Plus, Trash2, ChevronDown, ChevronRight } from 'lucide-react';
import { useEstimateWorkflowContext } from '@/contexts/EstimateWorkflowContext';
import { useContractorContext } from '@/contexts/ContractorContext';
import {
  FINISHINGS_LABOR_ITEMS,
  PAINTING_CONFIG,
  DRYWALL_REPAIR_LEVELS,
} from '@/lib/constants';
import {
  LaborItem as ContextLaborItem,
  FlatFeeItem as ContextFlatFeeItem,
} from '@/types/estimate';

type LaborItem = ContextLaborItem & {
  source?: string;
  isAutoGenerated?: boolean;
};
type FlatFeeItem = ContextFlatFeeItem & {
  source?: string;
  isAutoGenerated?: boolean;
};

interface FinishingsDesignData {
  width: string;
  length: string;
  height: string;
  fixWalls: boolean;
  drywallRepairsLevel: 'LIGHT' | 'MEDIUM' | 'HEAVY';
  priming: boolean;
  paintWalls: boolean;
  paintCeiling: boolean;
  paintTrim: boolean;
  paintDoor: boolean;
  // Carpentry options
  installBaseboard: boolean;
  installDoorCasing: boolean;
  installShoeQuarterRound: boolean;
  installDoorHardware: boolean;
  // Accessory options
  installMirror: boolean;
  installTowelBar: boolean;
  towelBarQuantity: number;
  installTPHolder: boolean;
  tpHolderQuantity: number;
  installRobeHook: boolean;
  robeHookQuantity: number;
  installTowelRing: boolean;
  towelRingQuantity: number;
  installShowerRod: boolean;
  showerRodQuantity: number;
  installWallShelf: boolean;
  wallShelfQuantity: number;
  accentWalls: Array<{
    id: string;
    width: string;
    height: string;
    finishType: 'tile' | 'wainscot' | 'paint';
  }>;
  [key: string]: unknown;
}

// Helper function to clamp a value between min and max
const clamp = (value: number, min: number, max: number): number => {
  return Math.max(min, Math.min(max, value));
};

// Helper function to parse number with default
const parseNum = (value: string | number | undefined, defaultVal = 0): number => {
  if (value === undefined || value === null || value === '') return defaultVal;
  const parsed = parseFloat(String(value));
  return isNaN(parsed) ? defaultVal : Math.max(0, parsed);
};

export default function FinishingsLaborSection() {
  const {
    getDesignData,
    getLaborItems,
    getFlatFeeItems,
    setLaborItems,
    isReloading,
  } = useEstimateWorkflowContext();

  const designData = getDesignData('finishings') as FinishingsDesignData | null;
  const design = useMemo(
    () =>
      designData || {
        width: '60',
        length: '96',
        height: '96',
        fixWalls: true,
        drywallRepairsLevel: 'LIGHT' as const,
        priming: true,
        paintWalls: true,
        paintCeiling: true,
        paintTrim: false,
        paintDoor: false,
        installBaseboard: false,
        installDoorCasing: false,
        installShoeQuarterRound: false,
        installDoorHardware: false,
        installMirror: false,
        installTowelBar: false,
        towelBarQuantity: 1,
        installTPHolder: false,
        tpHolderQuantity: 1,
        installRobeHook: false,
        robeHookQuantity: 1,
        installTowelRing: false,
        towelRingQuantity: 1,
        installShowerRod: false,
        showerRodQuantity: 1,
        installWallShelf: false,
        wallShelfQuantity: 1,
        accentWalls: [],
      },
    [designData]
  );

  const { hourlyRate: contractorHourlyRate } = useContractorContext();

  const contextLaborItems = getLaborItems('finishings');
  const contextFlatFeeItems = getFlatFeeItems('finishings');

  const [localLaborItems, setLocalLaborItems] = useState<LaborItem[]>([]);
  const [localFlatFeeItems, setLocalFlatFeeItems] = useState<FlatFeeItem[]>([]);
  const [isPaintingOpen, setIsPaintingOpen] = useState(true);
  const [isCarpentryOpen, setIsCarpentryOpen] = useState(true);
  const [isAccessoriesOpen, setIsAccessoriesOpen] = useState(true);

  const isUserActionRef = useRef(false);
  const processedChoicesRef = useRef<string>('');

  useEffect(() => {
    setLocalLaborItems(contextLaborItems);
    setLocalFlatFeeItems(contextFlatFeeItems);
  }, [contextLaborItems, contextFlatFeeItems]);

  // ============================================================================
  // DERIVED GEOMETRY CALCULATIONS (per spec Section 2)
  // ============================================================================
  const geometry = useMemo(() => {
    // Parse dimensions (inches to feet)
    const widthIn = parseNum(design.width);
    const lengthIn = parseNum(design.length);
    const heightIn = parseNum(design.height);

    const widthFt = widthIn / 12;
    const lengthFt = lengthIn / 12;
    const heightFt = heightIn / 12;

    // Compute areas
    const floorAreaSqFt = widthFt * lengthFt;
    const ceilingAreaSqFt = floorAreaSqFt;
    const perimeterFt = 2 * (widthFt + lengthFt);
    const wallAreaSqFt = perimeterFt * heightFt;

    // Paintable wall area (all wall area is paintable by default)
    const paintableWallArea = wallAreaSqFt;

    // Paint surface = paintable walls + ceiling
    const paintSurfaceSqFt = paintableWallArea + ceilingAreaSqFt;

    // Baseboard paint LF calculation
    const coveredBaseboardLfRaw = perimeterFt * PAINTING_CONFIG.BASEBOARD.COVERED_RATIO;
    const coveredBaseboardLf = clamp(
      coveredBaseboardLfRaw,
      PAINTING_CONFIG.BASEBOARD.COVERED_MIN,
      PAINTING_CONFIG.BASEBOARD.COVERED_MAX
    );
    const baseboardPaintLf = Math.max(0, perimeterFt - coveredBaseboardLf);

    // Number of doors (default 1)
    const numDoors = 1;

    return {
      widthFt,
      lengthFt,
      heightFt,
      floorAreaSqFt,
      ceilingAreaSqFt,
      perimeterFt,
      wallAreaSqFt,
      paintableWallArea,
      paintSurfaceSqFt,
      coveredBaseboardLf,
      baseboardPaintLf,
      numDoors,
    };
  }, [design.width, design.length, design.height]);

  // ============================================================================
  // HIDDEN PREP/CLEANUP HOURS (per spec Section 4)
  // ============================================================================
  const prepCleanupHours = useMemo(() => {
    const { priming, paintWalls, paintCeiling, paintTrim } = design;
    const hasPaintingTask = priming || paintWalls || paintCeiling || paintTrim;

    if (!hasPaintingTask) {
      return { total: 0, priming: 0, walls: 0, ceiling: 0, trim: 0 };
    }

    // Calculate raw hours
    const rawHours =
      PAINTING_CONFIG.PREP_CLEANUP.BASE +
      PAINTING_CONFIG.PREP_CLEANUP.RATE_PER_SQFT * geometry.paintSurfaceSqFt;

    // Clamp between min and max
    const totalHours = clamp(
      rawHours,
      PAINTING_CONFIG.PREP_CLEANUP.MIN,
      PAINTING_CONFIG.PREP_CLEANUP.MAX
    );

    // Calculate weights for enabled tasks
    const weights = {
      priming: priming ? PAINTING_CONFIG.PREP_WEIGHTS.PRIMING : 0,
      walls: paintWalls ? PAINTING_CONFIG.PREP_WEIGHTS.WALLS : 0,
      ceiling: paintCeiling ? PAINTING_CONFIG.PREP_WEIGHTS.CEILING : 0,
      trim: paintTrim ? PAINTING_CONFIG.PREP_WEIGHTS.TRIM : 0,
    };
    const totalWeight = weights.priming + weights.walls + weights.ceiling + weights.trim;

    if (totalWeight === 0) {
      return { total: 0, priming: 0, walls: 0, ceiling: 0, trim: 0 };
    }

    // Distribute prep hours by weight
    return {
      total: totalHours,
      priming: totalHours * (weights.priming / totalWeight),
      walls: totalHours * (weights.walls / totalWeight),
      ceiling: totalHours * (weights.ceiling / totalWeight),
      trim: totalHours * (weights.trim / totalWeight),
    };
  }, [design.priming, design.paintWalls, design.paintCeiling, design.paintTrim, geometry.paintSurfaceSqFt]);

  // ============================================================================
  // LABOR GENERATION (per spec Section 5)
  // ============================================================================
  const generateLaborItems = useCallback(() => {
    const laborItems: LaborItem[] = [];
    const flatFeeItems: FlatFeeItem[] = [];
    const laborItemsMap = FINISHINGS_LABOR_ITEMS(contractorHourlyRate);
    const P = PAINTING_CONFIG.PRODUCTIVITY;
    const C = PAINTING_CONFIG.COATS;

    // -------------------------------------------------------------------------
    // A) Drywall Repairs (per spec Section 5A)
    // -------------------------------------------------------------------------
    if (design.fixWalls) {
      const level = DRYWALL_REPAIR_LEVELS[design.drywallRepairsLevel || 'LIGHT'];

      // Spot prime allowance only if Priming is OFF
      const spotPrimeAllowance = design.priming ? 0 : level.spotPrimeAllowance;

      // Calculate hours
      const rawHours = level.base + level.rate * geometry.paintSurfaceSqFt + spotPrimeAllowance;
      const drywallHours = clamp(rawHours, 0, level.cap);

      laborItems.push({
        ...laborItemsMap.paintWalls,
        id: `lab-finish-drywall-repairs-${Date.now()}`,
        name: `Drywall Repairs (${design.drywallRepairsLevel})`,
        hours: drywallHours.toFixed(2),
        scope: 'painting',
        isAutoGenerated: true,
      });
    }

    // -------------------------------------------------------------------------
    // B) Priming (per spec Section 5B)
    // -------------------------------------------------------------------------
    if (design.priming) {
      // Prime area based on selected surfaces
      const primeAreaSqFt =
        (design.paintWalls ? geometry.paintableWallArea : 0) +
        (design.paintCeiling ? geometry.ceilingAreaSqFt : 0);

      if (primeAreaSqFt > 0) {
        // Labor: (area * coats) / productivity + prep share
        const primeHours =
          (primeAreaSqFt * C.PRIMER) / P.PRIME + prepCleanupHours.priming;

        laborItems.push({
          ...laborItemsMap.paintWalls,
          id: `lab-finish-priming-${Date.now()}`,
          name: 'Priming',
          hours: primeHours.toFixed(2),
          scope: 'painting',
          isAutoGenerated: true,
        });
      }
    }

    // -------------------------------------------------------------------------
    // C) Paint Walls (per spec Section 5C)
    // -------------------------------------------------------------------------
    if (design.paintWalls && geometry.paintableWallArea > 0) {
      // Roll hours
      const wallRollHrs = (geometry.paintableWallArea * C.WALLS) / P.WALL_ROLL;

      // Cut-in LF calculation
      const cutLf =
        geometry.perimeterFt +
        geometry.baseboardPaintLf +
        4 * geometry.heightFt +
        P.EXTRA_CUT_LF_PER_COAT;
      const wallCutHrs = (cutLf * C.WALLS) / P.WALL_CUT_IN;

      // Total hours with prep share
      const wallHours = wallRollHrs + wallCutHrs + prepCleanupHours.walls;

      laborItems.push({
        ...laborItemsMap.paintWalls,
        id: `lab-finish-paint-walls-${Date.now()}`,
        name: 'Paint Walls',
        hours: wallHours.toFixed(2),
        scope: 'painting',
        isAutoGenerated: true,
      });
    }

    // -------------------------------------------------------------------------
    // D) Paint Ceiling (per spec Section 5D)
    // -------------------------------------------------------------------------
    if (design.paintCeiling && geometry.ceilingAreaSqFt > 0) {
      // Cut-in hours
      const ceilCutHrs = (geometry.perimeterFt * C.CEILING) / P.CEILING_CUT_IN;
      // Roll hours
      const ceilRollHrs = (geometry.ceilingAreaSqFt * C.CEILING) / P.CEILING_ROLL;

      // Total hours with prep share
      const ceilingHours = ceilCutHrs + ceilRollHrs + prepCleanupHours.ceiling;

      laborItems.push({
        ...laborItemsMap.paintCeiling,
        id: `lab-finish-paint-ceiling-${Date.now()}`,
        name: 'Paint Ceiling',
        hours: ceilingHours.toFixed(2),
        scope: 'painting',
        isAutoGenerated: true,
      });
    }

    // -------------------------------------------------------------------------
    // E) Paint Trim (per spec Section 5E)
    // -------------------------------------------------------------------------
    if (design.paintTrim) {
      // Baseboard paint hours
      const baseboardHrs = (geometry.baseboardPaintLf * C.TRIM) / P.TRIM_BASEBOARD;
      // Casing allowance
      const casingAllowance = geometry.numDoors * P.CASING_ALLOWANCE_PER_DOOR;

      // Total hours with prep share
      const trimHours = baseboardHrs + casingAllowance + prepCleanupHours.trim;

      laborItems.push({
        ...laborItemsMap.paintTrim,
        id: `lab-finish-paint-trim-${Date.now()}`,
        name: 'Paint Trim & Baseboards',
        hours: trimHours.toFixed(2),
        scope: 'painting',
        isAutoGenerated: true,
      });
    }

    // -------------------------------------------------------------------------
    // F) Paint Door (per spec Section 5F)
    // -------------------------------------------------------------------------
    if (design.paintDoor && geometry.numDoors > 0) {
      // Labor: numDoors * 1.0 hr/door (no prep share for doors)
      const doorHours = geometry.numDoors * P.DOOR_PAINT_LABOR;

      laborItems.push({
        ...laborItemsMap.paintTrim,
        id: `lab-finish-paint-door-${Date.now()}`,
        name: 'Paint Door(s)',
        hours: doorHours.toFixed(2),
        scope: 'painting',
        isAutoGenerated: true,
      });
    }

    // -------------------------------------------------------------------------
    // Carpentry Labor (Trim & Doors per spec)
    // -------------------------------------------------------------------------
    const hasCarpentryTask =
      design.installBaseboard ||
      design.installDoorCasing ||
      design.installShoeQuarterRound ||
      design.installDoorHardware;

    // One-time setup labor (if ANY carpentry toggle is ON)
    if (hasCarpentryTask) {
      const setupHours = (20 / 60).toFixed(2); // 20 minutes = 0.33 hrs
      laborItems.push({
        id: `lab-finish-trim-setup-${Date.now()}`,
        name: 'Trim & Door Setup/Layout',
        hours: setupHours,
        rate: contractorHourlyRate.toString(),
        scope: 'carpentry',
        isAutoGenerated: true,
      });
    }

    // 1) Baseboard - Labor: (perimeterFt * 3.0 minutes) / 60
    if (design.installBaseboard && geometry.perimeterFt > 0) {
      const baseboardMinutes = geometry.perimeterFt * 3.0;
      const baseboardHours = (baseboardMinutes / 60).toFixed(2);
      laborItems.push({
        ...laborItemsMap.installBaseboards,
        id: `lab-finish-baseboards-${Date.now()}`,
        name: `Install Baseboard (${Math.round(geometry.perimeterFt)}lf)`,
        hours: baseboardHours,
        scope: 'carpentry',
        isAutoGenerated: true,
      });
    }

    // 2) Door Casing - Labor: (numDoors * 50 minutes) / 60
    if (design.installDoorCasing && geometry.numDoors > 0) {
      const casingMinutes = geometry.numDoors * 50;
      const casingHours = (casingMinutes / 60).toFixed(2);
      laborItems.push({
        id: `lab-finish-door-casing-${Date.now()}`,
        name: `Install Door Casing (${geometry.numDoors})`,
        hours: casingHours,
        rate: contractorHourlyRate.toString(),
        scope: 'carpentry',
        isAutoGenerated: true,
      });
    }

    // 3) Shoe / Quarter Round - Labor: (perimeterFt * 1.5 minutes) / 60
    if (design.installShoeQuarterRound && geometry.perimeterFt > 0) {
      const shoeMinutes = geometry.perimeterFt * 1.5;
      const shoeHours = (shoeMinutes / 60).toFixed(2);
      laborItems.push({
        id: `lab-finish-shoe-quarter-${Date.now()}`,
        name: `Install Shoe/Quarter Round (${Math.round(geometry.perimeterFt)}lf)`,
        hours: shoeHours,
        rate: contractorHourlyRate.toString(),
        scope: 'carpentry',
        isAutoGenerated: true,
      });
    }

    // 4) Door Hardware - Labor: (numDoors * 40 minutes) / 60
    if (design.installDoorHardware && geometry.numDoors > 0) {
      const hardwareMinutes = geometry.numDoors * 40;
      const hardwareHours = (hardwareMinutes / 60).toFixed(2);
      laborItems.push({
        id: `lab-finish-door-hardware-${Date.now()}`,
        name: `Door Hardware & Adjust (${geometry.numDoors})`,
        hours: hardwareHours,
        rate: contractorHourlyRate.toString(),
        scope: 'carpentry',
        isAutoGenerated: true,
      });
    }

    // -------------------------------------------------------------------------
    // Accessory Labor
    // -------------------------------------------------------------------------
    if (design.installTowelBar) {
      const qty = design.towelBarQuantity || 1;
      const totalHours = (qty * 0.75).toFixed(2); // 45 min per item
      laborItems.push({
        ...laborItemsMap.installTowelBar,
        id: `lab-finish-towel-bar-${Date.now()}`,
        name: qty > 1 ? `Install Towel Bar (x${qty})` : 'Install Towel Bar',
        hours: totalHours,
        scope: 'accessories',
        isAutoGenerated: true,
      });
    }

    if (design.installTPHolder) {
      const qty = design.tpHolderQuantity || 1;
      const totalHours = (qty * 0.50).toFixed(2); // 30 min per item
      laborItems.push({
        ...laborItemsMap.installTPHolder,
        id: `lab-finish-tp-holder-${Date.now()}`,
        name: qty > 1 ? `Install Toilet Paper Holder (x${qty})` : 'Install Toilet Paper Holder',
        hours: totalHours,
        scope: 'accessories',
        isAutoGenerated: true,
      });
    }

    if (design.installRobeHook) {
      const qty = design.robeHookQuantity || 1;
      const totalHours = (qty * 0.25).toFixed(2); // 15 min per item
      laborItems.push({
        ...laborItemsMap.installRobeHook,
        id: `lab-finish-robe-hook-${Date.now()}`,
        name: qty > 1 ? `Install Robe Hook (x${qty})` : 'Install Robe Hook',
        hours: totalHours,
        scope: 'accessories',
        isAutoGenerated: true,
      });
    }

    if (design.installTowelRing) {
      const qty = design.towelRingQuantity || 1;
      const totalHours = (qty * 0.33).toFixed(2); // 20 min per item
      laborItems.push({
        ...laborItemsMap.installTowelRing,
        id: `lab-finish-towel-ring-${Date.now()}`,
        name: qty > 1 ? `Install Towel Ring (x${qty})` : 'Install Towel Ring',
        hours: totalHours,
        scope: 'accessories',
        isAutoGenerated: true,
      });
    }

    if (design.installShowerRod) {
      const qty = design.showerRodQuantity || 1;
      const totalHours = (qty * 0.33).toFixed(2); // 20 min per item
      laborItems.push({
        ...laborItemsMap.installShowerRod,
        id: `lab-finish-shower-rod-${Date.now()}`,
        name: qty > 1 ? `Install Shower Rod (x${qty})` : 'Install Shower Rod',
        hours: totalHours,
        scope: 'accessories',
        isAutoGenerated: true,
      });
    }

    if (design.installWallShelf) {
      const qty = design.wallShelfQuantity || 1;
      const totalHours = (qty * 1.00).toFixed(2); // 60 min per item
      laborItems.push({
        ...laborItemsMap.installWallShelf,
        id: `lab-finish-wall-shelf-${Date.now()}`,
        name: qty > 1 ? `Install Accessory Shelf (x${qty})` : 'Install Accessory Shelf',
        hours: totalHours,
        scope: 'accessories',
        isAutoGenerated: true,
      });
    }

    // 7) Mirror - Labor: 60 min = 1.00 hrs
    if (design.installMirror) {
      const mirrorHours = (60 / 60).toFixed(2); // 60 min per item
      laborItems.push({
        ...laborItemsMap.installMirror,
        id: `lab-finish-mirror-${Date.now()}`,
        name: 'Install Mirror',
        hours: mirrorHours,
        scope: 'accessories',
        isAutoGenerated: true,
      });
    }

    return { laborItems, flatFeeItems };
  }, [
    design,
    geometry,
    prepCleanupHours,
    contractorHourlyRate,
  ]);

  useEffect(() => {
    if (isUserActionRef.current || isReloading) return;
    const choicesKey = `${design.width}-${design.length}-${design.height}-${
      design.fixWalls
    }-${design.drywallRepairsLevel}-${design.priming}-${design.paintWalls}-${design.paintCeiling}-${
      design.paintTrim
    }-${design.paintDoor}-${design.installBaseboard}-${design.installDoorCasing}-${
      design.installShoeQuarterRound
    }-${design.installDoorHardware}-${design.installMirror}-${design.installTowelBar}-${design.towelBarQuantity}-${
      design.installTPHolder
    }-${design.tpHolderQuantity}-${design.installRobeHook}-${design.robeHookQuantity}-${
      design.installTowelRing
    }-${design.towelRingQuantity}-${design.installShowerRod}-${design.showerRodQuantity}-${
      design.installWallShelf
    }-${design.wallShelfQuantity}`;
    if (processedChoicesRef.current === choicesKey) return;

    // Preserve custom items, regenerate auto items
    const currentLabor = localLaborItems || [];
    const customItems = currentLabor.filter(
      (item) => item.source === 'custom' || item.isAutoGenerated === false
    );

    const { laborItems: newAutoItems } = generateLaborItems();
    const mergedItems = [...customItems, ...newAutoItems];

    if (mergedItems.length > 0 || currentLabor.length > 0) {
      setLaborItems('finishings', mergedItems);
    }
    processedChoicesRef.current = choicesKey;
  }, [
    design,
    generateLaborItems,
    setLaborItems,
    localLaborItems,
    isReloading,
  ]);

  const handleAddPaintingLaborItem = useCallback(() => {
    const newItem: LaborItem = {
      id: `labor-painting-${Date.now()}-${Math.random()
        .toString(36)
        .substr(2, 9)}`,
      name: '',
      hours: '1',
      rate: contractorHourlyRate.toString(),
      scope: 'painting',
      source: 'custom',
      isAutoGenerated: false,
    };
    isUserActionRef.current = true;
    setLocalLaborItems((prev) => [...prev, newItem]);
    setTimeout(() => {
      setLaborItems('finishings', [...localLaborItems, newItem]);
      isUserActionRef.current = false;
    }, 100);
  }, [localLaborItems, setLaborItems, contractorHourlyRate]);

  const handleAddAccessoriesLaborItem = useCallback(() => {
    const newItem: LaborItem = {
      id: `labor-accessories-${Date.now()}-${Math.random()
        .toString(36)
        .substring(2, 11)}`,
      name: '',
      hours: '1',
      rate: contractorHourlyRate.toString(),
      scope: 'accessories',
      source: 'custom',
      isAutoGenerated: false,
    };
    isUserActionRef.current = true;
    setLocalLaborItems((prev) => [...prev, newItem]);
    setTimeout(() => {
      setLaborItems('finishings', [...localLaborItems, newItem]);
      isUserActionRef.current = false;
    }, 100);
  }, [localLaborItems, setLaborItems, contractorHourlyRate]);

  const handleAddCarpentryLaborItem = useCallback(() => {
    const newItem: LaborItem = {
      id: `labor-carpentry-${Date.now()}-${Math.random()
        .toString(36)
        .substring(2, 11)}`,
      name: '',
      hours: '1',
      rate: contractorHourlyRate.toString(),
      scope: 'carpentry',
      source: 'custom',
      isAutoGenerated: false,
    };
    isUserActionRef.current = true;
    setLocalLaborItems((prev) => [...prev, newItem]);
    setTimeout(() => {
      setLaborItems('finishings', [...localLaborItems, newItem]);
      isUserActionRef.current = false;
    }, 100);
  }, [localLaborItems, setLaborItems, contractorHourlyRate]);

  const handleLaborItemChange = useCallback(
    (id: string, field: keyof LaborItem, value: string) => {
      isUserActionRef.current = true;
      setLocalLaborItems((prev) =>
        prev.map((item) =>
          item.id === id ? { ...item, [field]: value } : item
        )
      );
      setTimeout(() => {
        const updatedItems = localLaborItems.map((item) =>
          item.id === id ? { ...item, [field]: value } : item
        );
        setLaborItems('finishings', updatedItems);
        isUserActionRef.current = false;
      }, 100);
    },
    [localLaborItems, setLaborItems]
  );

  const handleDeleteLaborItem = useCallback(
    (id: string) => {
      isUserActionRef.current = true;
      setLocalLaborItems((prev) => prev.filter((item) => item.id !== id));
      setTimeout(() => {
        const updatedItems = localLaborItems.filter((item) => item.id !== id);
        setLaborItems('finishings', updatedItems);
        isUserActionRef.current = false;
      }, 100);
    },
    [localLaborItems, setLaborItems]
  );

  const handleAddFlatFeeItem = useCallback(() => {
    const newItem: LaborItem = {
      id: `flat-fee-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
      name: '',
      hours: '0',
      rate: '0',
      scope: 'construction',
      source: 'custom',
      isAutoGenerated: false,
    };
    isUserActionRef.current = true;
    setLocalFlatFeeItems((prev) => [
      ...prev,
      newItem as unknown as FlatFeeItem,
    ]);
    setTimeout(() => {
      setLaborItems('finishings', [...localLaborItems, newItem]);
      isUserActionRef.current = false;
    }, 100);
  }, [localLaborItems, setLaborItems]);

  const handleFlatFeeItemChange = useCallback(
    (id: string, field: keyof FlatFeeItem, value: string) => {
      isUserActionRef.current = true;
      setLocalFlatFeeItems((prev) =>
        prev.map((item) =>
          item.id === id ? { ...item, [field]: value } : item
        )
      );
      setTimeout(() => {
        const updatedItems = localLaborItems.map((item) => {
          if (item.id === id) {
            const flatFeeItem = localFlatFeeItems.find((f) => f.id === id);
            if (flatFeeItem) {
              return {
                ...item,
                name: flatFeeItem.name,
                rate: flatFeeItem.unitPrice,
              };
            }
          }
          return item;
        });
        setLaborItems('finishings', updatedItems);
        isUserActionRef.current = false;
      }, 100);
    },
    [localLaborItems, localFlatFeeItems, setLaborItems]
  );

  const handleDeleteFlatFeeItem = useCallback(
    (id: string) => {
      isUserActionRef.current = true;
      setLocalFlatFeeItems((prev) => prev.filter((item) => item.id !== id));
      setTimeout(() => {
        const updatedItems = localLaborItems.filter((item) => item.id !== id);
        setLaborItems('finishings', updatedItems);
        isUserActionRef.current = false;
      }, 100);
    },
    [localLaborItems, setLaborItems]
  );

  const flatFeeItems = localFlatFeeItems;

  // Separate labor items by category
  const paintingLaborItems = useMemo(() => {
    return localLaborItems.filter(
      (item) =>
        item.scope === 'painting' ||
        item.name.toLowerCase().includes('paint') ||
        item.name.toLowerCase().includes('primer') ||
        item.name.toLowerCase().includes('priming') ||
        item.name.toLowerCase().includes('drywall') ||
        item.name.toLowerCase().includes('ceiling')
    );
  }, [localLaborItems]);

  const carpentryLaborItems = useMemo(() => {
    return localLaborItems.filter(
      (item) =>
        item.scope === 'carpentry' ||
        item.name.toLowerCase().includes('baseboard') ||
        item.name.toLowerCase().includes('casing') ||
        item.name.toLowerCase().includes('shoe') ||
        item.name.toLowerCase().includes('quarter round') ||
        item.name.toLowerCase().includes('door hardware')
    );
  }, [localLaborItems]);

  const accessoriesLaborItems = useMemo(() => {
    return localLaborItems.filter(
      (item) =>
        item.scope === 'accessories' ||
        item.name.toLowerCase().includes('towel') ||
        item.name.toLowerCase().includes('toilet paper') ||
        item.name.toLowerCase().includes('robe hook') ||
        item.name.toLowerCase().includes('shower rod') ||
        item.name.toLowerCase().includes('shelf') ||
        item.name.toLowerCase().includes('mirror')
    );
  }, [localLaborItems]);

  // Calculate totals for each category
  const paintingTotalHours = paintingLaborItems.reduce(
    (sum, item) => sum + (parseFloat(item.hours) || 0),
    0
  );
  const paintingLaborTotal = paintingLaborItems.reduce(
    (sum, item) =>
      sum + (parseFloat(item.hours) || 0) * (parseFloat(item.rate) || 0),
    0
  );

  const carpentryTotalHours = carpentryLaborItems.reduce(
    (sum, item) => sum + (parseFloat(item.hours) || 0),
    0
  );
  const carpentryLaborTotal = carpentryLaborItems.reduce(
    (sum, item) =>
      sum + (parseFloat(item.hours) || 0) * (parseFloat(item.rate) || 0),
    0
  );

  const accessoriesTotalHours = accessoriesLaborItems.reduce(
    (sum, item) => sum + (parseFloat(item.hours) || 0),
    0
  );
  const accessoriesLaborTotal = accessoriesLaborItems.reduce(
    (sum, item) =>
      sum + (parseFloat(item.hours) || 0) * (parseFloat(item.rate) || 0),
    0
  );

  const renderLaborItem = useCallback(
    (item: LaborItem) => {
      return (
        <div
          key={item.id}
          className={`p-3 rounded-lg border bg-white border-slate-200 shadow-sm w-full`}
        >
          <div className='flex items-center gap-2 mb-2 w-full'>
            <Input
              type='text'
              value={item.name}
              onChange={(e) =>
                handleLaborItemChange(item.id, 'name', e.target.value)
              }
              placeholder='Labor Task'
              className={`border-b-2 border-t-0 border-l-0 border-r-0 bg-transparent border-blue-300 focus:border-blue-500 focus:outline-none w-44 sm:w-full`}
            />
            <Button
              onClick={() => handleDeleteLaborItem(item.id)}
              variant='ghost'
              size='sm'
              className='text-red-500 hover:text-red-700 p-1 h-auto flex-shrink-0'
            >
              <Trash2 size={16} />
            </Button>
          </div>
          <div className='grid grid-cols-2 gap-3'>
            <div className='w-full'>
              <label className='text-xs text-slate-500'>Hours</label>
              <Input
                type='number'
                value={item.hours}
                onChange={(e) =>
                  handleLaborItemChange(item.id, 'hours', e.target.value)
                }
                placeholder='0'
                className='text-center w-full border-blue-300 focus:border-blue-500'
              />
            </div>
            <div className='w-full'>
              <label className='text-xs text-slate-500'>Rate ($/hr)</label>
              <Input
                type='number'
                value={item.rate}
                onChange={(e) =>
                  handleLaborItemChange(item.id, 'rate', e.target.value)
                }
                placeholder='0'
                className='text-center w-full border-blue-300 focus:border-blue-500'
              />
            </div>
            <div className='col-span-2 w-full'>
              <label className='text-xs text-slate-500'>Total</label>
              <div className='w-full p-2 text-center font-semibold text-slate-800 bg-slate-50 rounded-md'>
                $
                {(
                  (parseFloat(item.hours) || 0) * (parseFloat(item.rate) || 0)
                ).toFixed(2)}
              </div>
            </div>
          </div>
        </div>
      );
    },
    [handleLaborItemChange, handleDeleteLaborItem]
  );

  const renderFlatFeeItem = useCallback(
    (item: FlatFeeItem) => {
      return (
        <div
          key={item.id}
          className={`p-3 rounded-lg border shadow-sm w-full bg-white border-slate-200`}
        >
          <div className='flex items-center gap-2 mb-2 w-full'>
            <Input
              type='text'
              value={item.name}
              onChange={(e) =>
                handleFlatFeeItemChange(item.id, 'name', e.target.value)
              }
              placeholder='Flat Fee Task'
              className={`border-b-2 border-t-0 border-l-0 border-r-0 bg-transparent border-blue-300 focus:border-blue-500 focus:outline-none w-44 sm:w-full`}
            />
            <Button
              onClick={() => handleDeleteFlatFeeItem(item.id)}
              variant='ghost'
              size='sm'
              className='text-red-500 hover:text-red-700 p-1 h-auto flex-shrink-0'
            >
              <Trash2 size={16} />
            </Button>
          </div>
          <div className='w-full'>
            <label className='text-xs text-slate-500'>Total ($)</label>
            <Input
              type='number'
              value={item.unitPrice}
              onChange={(e) =>
                handleFlatFeeItemChange(item.id, 'unitPrice', e.target.value)
              }
              placeholder='0.00'
              className='text-center w-full border-b-2 border-t-0 border-l-0 border-r-0 border-blue-500 focus:border-blue-500'
            />
          </div>
        </div>
      );
    },
    [handleFlatFeeItemChange, handleDeleteFlatFeeItem]
  );

  const flatFeeTotal = flatFeeItems.reduce(
    (sum, item) => sum + (parseFloat(item.unitPrice) || 0),
    0
  );

  // Calculate total hours
  const totalHours = useMemo(() => {
    return localLaborItems.reduce(
      (sum, item) => sum + (parseFloat(item.hours) || 0),
      0
    );
  }, [localLaborItems]);

  // Calculate total amount
  const totalAmount = useMemo(() => {
    return (
      paintingLaborTotal +
      carpentryLaborTotal +
      accessoriesLaborTotal +
      flatFeeTotal
    );
  }, [paintingLaborTotal, carpentryLaborTotal, accessoriesLaborTotal, flatFeeTotal]);

  return (
    <div className='space-y-5'>
      <div className='flex justify-between items-baseline'>
        <h2 className='text-2xl font-bold text-slate-800'>Labor</h2>
        {totalHours > 0 && (
          <div className='flex items-center gap-2 text-sm text-slate-600'>
            <span className='font-semibold text-xl text-slate-800'>
              {totalHours.toFixed(1)} hrs
            </span>
          </div>
        )}
        <div className='flex items-center gap-2 text-sm text-slate-600'>
          <span className='font-semibold text-xl text-blue-600'>
            ${totalAmount.toFixed(2)}
          </span>
        </div>
      </div>

      <div className='space-y-4'>
        {/* Painting Labor Section */}
        <Card>
          <CardContent className='p-3 space-y-3'>
            <div
              className='flex justify-between items-center cursor-pointer'
              onClick={() => setIsPaintingOpen(!isPaintingOpen)}
            >
              <div className='flex items-center gap-2 justify-between w-full'>
                <div className='flex items-center gap-2'>
                  {isPaintingOpen ? (
                    <ChevronDown className='h-4 w-4 text-slate-600' />
                  ) : (
                    <ChevronRight className='h-4 w-4 text-slate-600' />
                  )}
                  <h3 className='text-lg font-semibold text-slate-700'>
                    Painting
                  </h3>
                </div>
                <span className='text-sm text-slate-500'>
                  {paintingTotalHours.toFixed(1)} hrs
                </span>
                <p className='font-bold text-blue-600 text-sm'>
                  ${paintingLaborTotal.toFixed(2)}
                </p>
              </div>
            </div>
            {isPaintingOpen && (
              <>
                {paintingLaborItems.length > 0 ? (
                  <div className='space-y-2'>
                    {paintingLaborItems.map(renderLaborItem)}
                  </div>
                ) : (
                  <p className='text-sm text-slate-500 text-center py-4'>
                    No painting labor items added yet.
                  </p>
                )}
                <div className='flex justify-center'>
                  <Button
                    onClick={handleAddPaintingLaborItem}
                    variant='default'
                    className='w-auto mt-2 flex items-center justify-center gap-2 py-2.5 px-4 text-white font-semibold border-blue-200'
                  >
                    <Plus size={16} />
                    Add Item
                  </Button>
                </div>
              </>
            )}
          </CardContent>
        </Card>

        {/* Carpentry Labor Section */}
        <Card>
          <CardContent className='p-3 space-y-3'>
            <div
              className='flex justify-between items-center cursor-pointer'
              onClick={() => setIsCarpentryOpen(!isCarpentryOpen)}
            >
              <div className='flex items-center gap-2 justify-between w-full'>
                <div className='flex items-center gap-2'>
                  {isCarpentryOpen ? (
                    <ChevronDown className='h-4 w-4 text-slate-600' />
                  ) : (
                    <ChevronRight className='h-4 w-4 text-slate-600' />
                  )}
                  <h3 className='text-lg font-semibold text-slate-700'>
                    Carpentry
                  </h3>
                </div>
                <span className='text-sm text-slate-500'>
                  {carpentryTotalHours.toFixed(1)} hrs
                </span>
                <p className='font-bold text-blue-600 text-sm'>
                  ${carpentryLaborTotal.toFixed(2)}
                </p>
              </div>
            </div>
            {isCarpentryOpen && (
              <>
                {carpentryLaborItems.length > 0 ? (
                  <div className='space-y-2'>
                    {carpentryLaborItems.map(renderLaborItem)}
                  </div>
                ) : (
                  <p className='text-sm text-slate-500 text-center py-4'>
                    No carpentry labor items added yet.
                  </p>
                )}
                <div className='flex justify-center'>
                  <Button
                    onClick={handleAddCarpentryLaborItem}
                    variant='default'
                    className='w-auto mt-2 flex items-center justify-center gap-2 py-2.5 px-4 text-white font-semibold border-blue-200'
                  >
                    <Plus size={16} />
                    Add Item
                  </Button>
                </div>
              </>
            )}
          </CardContent>
        </Card>

        {/* Accessories Labor Section */}
        <Card>
          <CardContent className='p-3 space-y-3'>
            <div
              className='flex justify-between items-center cursor-pointer'
              onClick={() => setIsAccessoriesOpen(!isAccessoriesOpen)}
            >
              <div className='flex items-center gap-2 justify-between w-full'>
                <div className='flex items-center gap-2'>
                  {isAccessoriesOpen ? (
                    <ChevronDown className='h-4 w-4 text-slate-600' />
                  ) : (
                    <ChevronRight className='h-4 w-4 text-slate-600' />
                  )}
                  <div>
                    <h3 className='text-lg font-semibold text-slate-700'>
                      Accessories
                    </h3>
                    <p className='text-xs text-slate-500'>Hardware Installation</p>
                  </div>
                </div>
                <span className='text-sm text-slate-500'>
                  {accessoriesTotalHours.toFixed(1)} hrs
                </span>
                <p className='font-bold text-blue-600 text-sm'>
                  ${accessoriesLaborTotal.toFixed(2)}
                </p>
              </div>
            </div>
            {isAccessoriesOpen && (
              <>
                {accessoriesLaborItems.length > 0 ? (
                  <div className='space-y-2'>
                    {accessoriesLaborItems.map(renderLaborItem)}
                  </div>
                ) : (
                  <p className='text-sm text-slate-500 text-center py-4'>
                    No accessories labor items added yet.
                  </p>
                )}
                <div className='flex justify-center'>
                  <Button
                    onClick={handleAddAccessoriesLaborItem}
                    variant='default'
                    className='w-auto mt-2 flex items-center justify-center gap-2 py-2.5 px-4 text-white font-semibold border-blue-200'
                  >
                    <Plus size={16} />
                    Add Item
                  </Button>
                </div>
              </>
            )}
          </CardContent>
        </Card>

        {/* Flat Fee Section (remains unchanged) */}
        {flatFeeItems.length > 0 && (
          <Card>
            <CardContent className='p-3 space-y-3'>
              <div className='flex justify-between items-center'>
                <h3 className='text-lg font-semibold text-slate-700'>
                  Flat Fee Items
                </h3>
                <p className='font-bold text-blue-600 text-sm'>
                  ${flatFeeTotal.toFixed(2)}
                </p>
              </div>
              <div className='space-y-2'>
                {flatFeeItems.map(renderFlatFeeItem)}
              </div>
              <div className='flex justify-center'>
                <Button
                  onClick={handleAddFlatFeeItem}
                  variant='default'
                  className='w-auto mt-2 flex items-center justify-center gap-2 py-2.5 px-4 text-white font-semibold border-blue-200'
                >
                  <Plus size={16} />
                  Add Item
                </Button>
              </div>
            </CardContent>
          </Card>
        )}
      </div>
    </div>
  );
}
