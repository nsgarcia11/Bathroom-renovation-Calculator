'use client';

import React, {
  useMemo,
  useCallback,
  useState,
  useEffect,
  useRef,
} from 'react';
import { Card, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Plus, Trash2, ChevronDown, ChevronRight, Search } from 'lucide-react';
import { useEstimateWorkflowContext } from '@/contexts/EstimateWorkflowContext';
import { OnlinePricesModal } from '@/components/estimate/shared/OnlinePricesModal';
import { FLOORS_MATERIALS_ITEMS } from '@/lib/constants';
import { MaterialItem as ContextMaterialItem } from '@/types/estimate';

type MaterialItem = ContextMaterialItem & {
  source?: string;
  isAutoGenerated?: boolean;
};

interface FloorsDesignData {
  width: string;
  length: string;
  extraMeasurements: Array<{
    id: number;
    label: string;
    width: string;
    length: string;
  }>;
  clientSuppliesTiles: boolean;
  selectedTileSizeOption: string;
  tileSize: { width: string; length: string };
  tilePattern: string;
  customPattern: string;
  isHeatedFloor: boolean;
  heatedFloorType: string;
  customHeatedFloorName: string;
  selectedPrepTasks: string[];
  plywoodThickness: string;
  [key: string]: unknown;
}

export default function FloorsMaterialsSection() {
  const { getDesignData, getMaterialItems, setMaterialItems, isReloading } =
    useEstimateWorkflowContext();

  const designData = getDesignData('floors') as FloorsDesignData | null;
  const design = useMemo(
    () =>
      designData || {
        width: '',
        length: '',
        extraMeasurements: [],
        clientSuppliesTiles: false,
        selectedTileSizeOption: 'select_option',
        tileSize: { width: '', length: '' },
        tilePattern: 'select_option',
        customPattern: '',
        isHeatedFloor: false,
        heatedFloorType: 'schluter',
        customHeatedFloorName: '',
        selectedPrepTasks: [],
        plywoodThickness: '3/4',
      },
    [designData]
  );

  const contextMaterials = getMaterialItems('floors');
  const [localMaterials, setLocalMaterials] = useState<MaterialItem[]>([]);
  const [isDesignOpen, setIsDesignOpen] = useState(true);
  const [isHeatedFloorOpen, setIsHeatedFloorOpen] = useState(true);
  const [isConstructionOpen, setIsConstructionOpen] = useState(true);
  const [onlinePricesModal, setOnlinePricesModal] = useState<{
    isOpen: boolean;
    materialName: string;
    category: string;
    specifications?: string;
  }>({
    isOpen: false,
    materialName: '',
    category: '',
    specifications: '',
  });
  const isUserActionRef = useRef(false);
  const processedChoicesRef = useRef<string>('');

  const totalSqFt = useMemo(() => {
    let totalArea = 0;
    const mainWidth = parseFloat(design.width) || 0;
    const mainLength = parseFloat(design.length) || 0;
    if (mainWidth > 0 && mainLength > 0)
      totalArea += (mainWidth * mainLength) / 144;

    // Add safety check for extraMeasurements
    if (design.extraMeasurements && Array.isArray(design.extraMeasurements)) {
      design.extraMeasurements.forEach((m) => {
        const sideWidth = parseFloat(m.width) || 0;
        const sideLength = parseFloat(m.length) || 0;
        if (sideWidth > 0 && sideLength > 0)
          totalArea += (sideWidth * sideLength) / 144;
      });
    }

    return totalArea;
  }, [design.width, design.length, design.extraMeasurements]);

  const wasteFactor = useMemo(() => {
    switch (design.tilePattern) {
      case 'herringbone':
        return 1.25;
      case '1/2_offset':
      case '1/3_offset':
        return 1.2;
      default:
        return 1.1;
    }
  }, [design.tilePattern]);

  useEffect(() => {
    setLocalMaterials(contextMaterials);
  }, [contextMaterials]);

  const generateMaterials = useCallback(() => {
    const materials: MaterialItem[] = [];
    const materialsMap = FLOORS_MATERIALS_ITEMS;

    if (totalSqFt > 0) {
      // Floor tile (only if client doesn't supply)
      if (
        !design.clientSuppliesTiles &&
        design.selectedTileSizeOption !== 'select_option'
      ) {
        const tileSqFt = totalSqFt * wasteFactor;
        materials.push({
          ...materialsMap.floorTile,
          id: `mat-floor-tile-${Date.now()}`,
          name: `Floor Tile (${design.tileSize.width}"x${design.tileSize.length}")`,
          quantity: tileSqFt.toFixed(2),
          isAutoGenerated: true,
        });
      }

      // Thinset and grout (always needed)
      const groutBags = Math.ceil(totalSqFt / 125);
      if (groutBags > 0) {
        materials.push({
          ...materialsMap.grout,
          id: `mat-floor-grout-${Date.now()}`,
          quantity: groutBags.toString(),
          isAutoGenerated: true,
        });
      }

      const thinsetForTiles = Math.ceil(totalSqFt / 45);
      let thinsetForDitra = 0;

      // Ditra membrane materials
      if (
        design.selectedPrepTasks &&
        design.selectedPrepTasks.includes('ditra')
      ) {
        const ditraRolls = Math.ceil(totalSqFt / 54);
        materials.push({
          ...materialsMap.ditra,
          id: `mat-floor-ditra-${Date.now()}`,
          quantity: ditraRolls.toString(),
          isAutoGenerated: true,
        });
        thinsetForDitra = Math.ceil(totalSqFt / 175);
      }

      if (
        design.selectedPrepTasks &&
        design.selectedPrepTasks.includes('ditra_xl')
      ) {
        const ditraXLRolls = Math.ceil(totalSqFt / 175);
        materials.push({
          ...materialsMap.ditraXL,
          id: `mat-floor-ditra-xl-${Date.now()}`,
          quantity: ditraXLRolls.toString(),
          isAutoGenerated: true,
        });
        thinsetForDitra = Math.ceil(totalSqFt / 175);
      }

      const totalThinset = thinsetForTiles + thinsetForDitra;
      if (totalThinset > 0) {
        materials.push({
          ...materialsMap.thinset,
          id: `mat-floor-thinset-${Date.now()}`,
          quantity: totalThinset.toString(),
          isAutoGenerated: true,
        });
      }

      // Heated floor materials
      if (design.isHeatedFloor) {
        const heatedFloorSystemQty = Math.ceil(totalSqFt / 40);
        let systemName = 'Heated Floor Kit';
        let systemPrice = '400.00';

        if (design.heatedFloorType === 'nuheat') {
          systemName = 'Nuheat Cable System';
          systemPrice = '350.00';
        } else if (
          design.heatedFloorType === 'custom' &&
          design.customHeatedFloorName
        ) {
          systemName = design.customHeatedFloorName;
          systemPrice = '0.00';
        } else if (design.heatedFloorType === 'schluter') {
          systemName = 'Schluter-DITRA-HEAT Kit';
          systemPrice = '400.00';
        }

        materials.push({
          ...materialsMap.heatedFloorKit,
          id: `mat-floor-heated-kit-${Date.now()}`,
          name: systemName,
          quantity: heatedFloorSystemQty.toString(),
          price: systemPrice,
          isAutoGenerated: true,
        });

        materials.push({
          ...materialsMap.heatedFloorThermostat,
          id: `mat-floor-thermostat-${Date.now()}`,
          isAutoGenerated: true,
        });
      }

      // Self-leveling compound
      if (
        design.selectedPrepTasks &&
        design.selectedPrepTasks.includes('self_leveling')
      ) {
        const levelerBags = Math.ceil(totalSqFt / 50);
        materials.push({
          ...materialsMap.selfLevelingCompound,
          id: `mat-floor-leveling-${Date.now()}`,
          quantity: levelerBags.toString(),
          isAutoGenerated: true,
        });
      }

      // Plywood subfloor
      if (
        design.selectedPrepTasks &&
        design.selectedPrepTasks.includes('add_plywood')
      ) {
        const plywoodSheets = Math.ceil(totalSqFt / 32);
        const plywoodPriceMap = {
          '1/2': '70.00',
          '5/8': '86.00',
          '3/4': '103.00',
        };
        const price =
          plywoodPriceMap[
            design.plywoodThickness as keyof typeof plywoodPriceMap
          ] || '70.00';

        materials.push({
          ...materialsMap.plywood,
          id: `mat-floor-plywood-${Date.now()}`,
          name: `${design.plywoodThickness}" Plywood Subfloor`,
          quantity: plywoodSheets.toString(),
          price: price,
          isAutoGenerated: true,
        });

        materials.push({
          ...materialsMap.floorScrews,
          id: `mat-floor-screws-${Date.now()}`,
          isAutoGenerated: true,
        });
      }
    }

    return materials;
  }, [design, totalSqFt, wasteFactor]);

  useEffect(() => {
    if (isUserActionRef.current || isReloading) return;
    const choicesKey = `${design.width}-${design.length}-${
      design.selectedPrepTasks ? design.selectedPrepTasks.join(',') : ''
    }-${design.isHeatedFloor}-${design.heatedFloorType}-${
      design.plywoodThickness
    }-${design.clientSuppliesTiles}-${design.selectedTileSizeOption}`;
    if (processedChoicesRef.current === choicesKey) return;
    if (contextMaterials && contextMaterials.length > 0) return;
    const currentMaterials = localMaterials || [];
    const existingAutoMaterials = currentMaterials.filter(
      (item) => (item as MaterialItem).source === 'auto'
    );
    if (existingAutoMaterials.length > 0) return;
    const materials = generateMaterials();
    if (materials.length > 0) setMaterialItems('floors', materials);
    processedChoicesRef.current = choicesKey;
  }, [
    design,
    generateMaterials,
    setMaterialItems,
    contextMaterials,
    localMaterials,
    isReloading,
  ]);

  const handleAddDesignMaterial = useCallback(() => {
    const newItem: MaterialItem = {
      id: `material-design-${Date.now()}-${Math.random()
        .toString(36)
        .substr(2, 9)}`,
      name: '',
      quantity: '1',
      unit: '',
      price: '0',
      scope: 'design',
      source: 'custom',
      isAutoGenerated: false,
    };
    isUserActionRef.current = true;
    setLocalMaterials((prev) => [...prev, newItem]);
    setTimeout(() => {
      setMaterialItems('floors', [...localMaterials, newItem]);
      isUserActionRef.current = false;
    }, 100);
  }, [localMaterials, setMaterialItems]);

  const handleAddHeatedFloorMaterial = useCallback(() => {
    const newItem: MaterialItem = {
      id: `material-heated-${Date.now()}-${Math.random()
        .toString(36)
        .substr(2, 9)}`,
      name: '',
      quantity: '1',
      unit: '',
      price: '0',
      scope: 'heated_floor',
      source: 'custom',
      isAutoGenerated: false,
    };
    isUserActionRef.current = true;
    setLocalMaterials((prev) => [...prev, newItem]);
    setTimeout(() => {
      setMaterialItems('floors', [...localMaterials, newItem]);
      isUserActionRef.current = false;
    }, 100);
  }, [localMaterials, setMaterialItems]);

  const handleAddConstructionMaterial = useCallback(() => {
    const newItem: MaterialItem = {
      id: `material-construction-${Date.now()}-${Math.random()
        .toString(36)
        .substr(2, 9)}`,
      name: '',
      quantity: '1',
      unit: '',
      price: '0',
      scope: 'construction',
      source: 'custom',
      isAutoGenerated: false,
    };
    isUserActionRef.current = true;
    setLocalMaterials((prev) => [...prev, newItem]);
    setTimeout(() => {
      setMaterialItems('floors', [...localMaterials, newItem]);
      isUserActionRef.current = false;
    }, 100);
  }, [localMaterials, setMaterialItems]);

  const handleMaterialChange = useCallback(
    (id: string, field: keyof MaterialItem, value: string) => {
      isUserActionRef.current = true;
      setLocalMaterials((prev) =>
        prev.map((item) =>
          item.id === id ? { ...item, [field]: value } : item
        )
      );
      setTimeout(() => {
        const updatedMaterials = localMaterials.map((item) =>
          item.id === id ? { ...item, [field]: value } : item
        );
        setMaterialItems('floors', updatedMaterials);
        isUserActionRef.current = false;
      }, 100);
    },
    [localMaterials, setMaterialItems]
  );

  const handleDeleteMaterial = useCallback(
    (id: string) => {
      isUserActionRef.current = true;
      setLocalMaterials((prev) => prev.filter((item) => item.id !== id));
      setTimeout(() => {
        const updatedMaterials = localMaterials.filter(
          (item) => item.id !== id
        );
        setMaterialItems('floors', updatedMaterials);
        isUserActionRef.current = false;
      }, 100);
    },
    [localMaterials, setMaterialItems]
  );

  const handleSearchOnlinePrices = useCallback(
    (materialName: string, category: string, specifications?: string) => {
      setOnlinePricesModal({
        isOpen: true,
        materialName,
        category,
        specifications,
      });
    },
    []
  );

  const handlePriceSelect = useCallback(
    (materialId: string, price: number, source: string) => {
      const updatedMaterials = localMaterials.map((item) =>
        item.id === materialId
          ? { ...item, price: price.toString(), source }
          : item
      );
      setLocalMaterials(updatedMaterials);
      setMaterialItems('floors', updatedMaterials);
    },
    [localMaterials, setMaterialItems]
  );

  const materials = localMaterials;

  // Separate materials by scope
  const designMaterials = useMemo(() => {
    return materials.filter((item) => item.scope === 'design');
  }, [materials]);

  const heatedFloorMaterials = useMemo(() => {
    return materials.filter(
      (item) =>
        item.scope === 'heated_floor' ||
        item.name.toLowerCase().includes('heated') ||
        item.name.toLowerCase().includes('thermostat') ||
        item.name.toLowerCase().includes('schluter-ditra-heat') ||
        item.name.toLowerCase().includes('nuheat') ||
        item.name.toLowerCase().includes('heated floor')
    );
  }, [materials]);

  const constructionMaterials = useMemo(() => {
    return materials.filter(
      (item) =>
        item.scope === 'construction' &&
        !item.name.toLowerCase().includes('heated') &&
        !item.name.toLowerCase().includes('thermostat') &&
        !item.name.toLowerCase().includes('schluter-ditra-heat') &&
        !item.name.toLowerCase().includes('nuheat') &&
        !item.name.toLowerCase().includes('heated floor')
    );
  }, [materials]);

  // Calculate totals for each category
  const designTotal = designMaterials.reduce(
    (sum, item) =>
      sum + (parseFloat(item.quantity) || 0) * (parseFloat(item.price) || 0),
    0
  );

  const heatedFloorTotal = heatedFloorMaterials.reduce(
    (sum, item) =>
      sum + (parseFloat(item.quantity) || 0) * (parseFloat(item.price) || 0),
    0
  );

  const constructionTotal = constructionMaterials.reduce(
    (sum, item) =>
      sum + (parseFloat(item.quantity) || 0) * (parseFloat(item.price) || 0),
    0
  );

  const renderMaterialItem = useCallback(
    (material: MaterialItem) => {
      return (
        <div
          key={material.id}
          className={`p-3 bg-white rounded-lg border ${
            material.isAutoGenerated ? 'border-blue-200' : 'border-slate-300'
          }`}
        >
          <div className='flex items-center gap-2 mb-2'>
            <Input
              type='text'
              value={material.name}
              onChange={(e) =>
                handleMaterialChange(material.id, 'name', e.target.value)
              }
              placeholder='Supply Name'
              className={`border-b-2 border-t-0 border-l-0 border-r-0 bg-transparent border-blue-300 focus:border-blue-500 focus:outline-none`}
            />
            <Button
              onClick={() => handleDeleteMaterial(material.id)}
              variant='ghost'
              size='sm'
              className='text-red-500 hover:text-red-700 p-1 h-auto'
            >
              <Trash2 size={16} />
            </Button>
          </div>
          <div className='grid grid-cols-2 gap-3'>
            <div>
              <label className='text-xs text-slate-500'>Quantity</label>
              <Input
                type='number'
                value={material.quantity}
                onChange={(e) =>
                  handleMaterialChange(material.id, 'quantity', e.target.value)
                }
                placeholder='0'
                className={`text-center border-blue-300 focus:border-blue-500`}
              />
            </div>
            <div>
              <label className='text-xs text-slate-500'>Unit</label>
              <Input
                type='text'
                value={material.unit}
                onChange={(e) =>
                  handleMaterialChange(material.id, 'unit', e.target.value)
                }
                placeholder='sq/ft'
                className={`text-center border-blue-300 focus:border-blue-500`}
              />
            </div>
            <div className='col-span-2'>
              <label className='text-xs text-slate-500'>Price/Unit ($)</label>
              <div className='flex gap-1'>
                <Input
                  type='number'
                  value={material.price}
                  onChange={(e) =>
                    handleMaterialChange(material.id, 'price', e.target.value)
                  }
                  placeholder='0.00'
                  className={`text-center border-blue-300 focus:border-blue-500 flex-1`}
                />
                <Button
                  onClick={() =>
                    handleSearchOnlinePrices(
                      material.name || 'Material',
                      'Flooring',
                      material.unit ? `Unit: ${material.unit}` : undefined
                    )
                  }
                  variant='outline'
                  size='sm'
                  className='px-2'
                  title='Search online prices'
                >
                  <Search size={14} />
                </Button>
              </div>
              {material.source && (
                <div className='text-xs text-blue-600 mt-1'>
                  Source: {material.source}
                </div>
              )}
            </div>
            <div className='col-span-2'>
              <label className='text-xs text-slate-500'>Total</label>
              <div className='w-full p-2 text-center font-semibold text-slate-800 bg-slate-50 rounded-md'>
                $
                {(
                  (parseFloat(material.quantity) || 0) *
                  (parseFloat(material.price) || 0)
                ).toFixed(2)}
              </div>
            </div>
          </div>
        </div>
      );
    },
    [handleMaterialChange, handleDeleteMaterial, handleSearchOnlinePrices]
  );

  const total = designTotal + heatedFloorTotal + constructionTotal;

  return (
    <div className='space-y-5'>
      <div className='flex justify-between items-center'>
        <h2 className='text-2xl font-bold text-slate-800'>
          Materials & Supplies
        </h2>
        <div className='text-right'>
          <p className='font-bold text-blue-600 text-lg'>${total.toFixed(2)}</p>
        </div>
      </div>

      <div className='space-y-4'>
        {/* Design Materials Section */}
        <Card>
          <CardContent className='p-3 space-y-3'>
            <div
              className='flex justify-between items-center cursor-pointer'
              onClick={() => setIsDesignOpen(!isDesignOpen)}
            >
              <div className='flex items-center gap-2 justify-between w-full'>
                <div className='flex items-center gap-2'>
                  {isDesignOpen ? (
                    <ChevronDown className='h-4 w-4 text-slate-600' />
                  ) : (
                    <ChevronRight className='h-4 w-4 text-slate-600' />
                  )}
                  <h3 className='text-lg font-semibold text-slate-700'>
                    Design Materials
                  </h3>
                </div>
                <p className='font-bold text-blue-600 text-sm'>
                  ${designTotal.toFixed(2)}
                </p>
              </div>
            </div>
            {isDesignOpen && (
              <>
                {designMaterials.length > 0 ? (
                  <div className='space-y-2'>
                    {designMaterials.map(renderMaterialItem)}
                  </div>
                ) : (
                  <p className='text-sm text-slate-500 text-center py-4'>
                    No design materials added yet.
                  </p>
                )}
                <div className='flex justify-center'>
                  <Button
                    onClick={handleAddDesignMaterial}
                    variant='default'
                    className='w-auto mt-2 flex items-center justify-center gap-2 py-2.5 px-4 text-white font-semibold border-blue-200'
                  >
                    <Plus size={16} />
                    Add Item
                  </Button>
                </div>
              </>
            )}
          </CardContent>
        </Card>

        {/* Heated Floor Materials Section */}
        <Card>
          <CardContent className='p-3 space-y-3'>
            <div
              className='flex justify-between items-center cursor-pointer'
              onClick={() => setIsHeatedFloorOpen(!isHeatedFloorOpen)}
            >
              <div className='flex items-center gap-2 justify-between w-full'>
                <div className='flex items-center gap-2'>
                  {isHeatedFloorOpen ? (
                    <ChevronDown className='h-4 w-4 text-slate-600' />
                  ) : (
                    <ChevronRight className='h-4 w-4 text-slate-600' />
                  )}
                  <h3 className='text-lg font-semibold text-slate-700'>
                    Heated Floor Materials
                  </h3>
                </div>
                <p className='font-bold text-blue-600 text-sm'>
                  ${heatedFloorTotal.toFixed(2)}
                </p>
              </div>
            </div>
            {isHeatedFloorOpen && (
              <>
                {heatedFloorMaterials.length > 0 ? (
                  <div className='space-y-2'>
                    {heatedFloorMaterials.map(renderMaterialItem)}
                  </div>
                ) : (
                  <p className='text-sm text-slate-500 text-center py-4'>
                    No heated floor materials added yet.
                  </p>
                )}
                <div className='flex justify-center'>
                  <Button
                    onClick={handleAddHeatedFloorMaterial}
                    variant='default'
                    className='w-auto mt-2 flex items-center justify-center gap-2 py-2.5 px-4 text-white font-semibold border-blue-200'
                  >
                    <Plus size={16} />
                    Add Item
                  </Button>
                </div>
              </>
            )}
          </CardContent>
        </Card>

        {/* Construction Materials Section */}
        <Card>
          <CardContent className='p-3 space-y-3'>
            <div
              className='flex justify-between items-center cursor-pointer'
              onClick={() => setIsConstructionOpen(!isConstructionOpen)}
            >
              <div className='flex items-center gap-2 justify-between w-full'>
                <div className='flex items-center gap-2'>
                  {isConstructionOpen ? (
                    <ChevronDown className='h-4 w-4 text-slate-600' />
                  ) : (
                    <ChevronRight className='h-4 w-4 text-slate-600' />
                  )}
                  <h3 className='text-lg font-semibold text-slate-700'>
                    Construction Materials
                  </h3>
                </div>
                <p className='font-bold text-blue-600 text-sm'>
                  ${constructionTotal.toFixed(2)}
                </p>
              </div>
            </div>
            {isConstructionOpen && (
              <>
                {constructionMaterials.length > 0 ? (
                  <div className='space-y-2'>
                    {constructionMaterials.map(renderMaterialItem)}
                  </div>
                ) : (
                  <p className='text-sm text-slate-500 text-center py-4'>
                    No construction materials added yet.
                  </p>
                )}
                <div className='flex justify-center'>
                  <Button
                    onClick={handleAddConstructionMaterial}
                    variant='default'
                    className='w-auto mt-2 flex items-center justify-center gap-2 py-2.5 px-4 text-white font-semibold border-blue-200'
                  >
                    <Plus size={16} />
                    Add Item
                  </Button>
                </div>
              </>
            )}
          </CardContent>
        </Card>
      </div>

      {/* Online Prices Modal */}
      <OnlinePricesModal
        isOpen={onlinePricesModal.isOpen}
        onClose={() =>
          setOnlinePricesModal((prev) => ({ ...prev, isOpen: false }))
        }
        materialName={onlinePricesModal.materialName}
        category={onlinePricesModal.category}
        specifications={onlinePricesModal.specifications}
        onPriceSelect={(price, source) => {
          // Find the material ID that matches the current search
          const materialId = localMaterials.find(
            (m) => m.name === onlinePricesModal.materialName
          )?.id;
          if (materialId) {
            handlePriceSelect(materialId, price, source);
          }
        }}
      />
    </div>
  );
}
