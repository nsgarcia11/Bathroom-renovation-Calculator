'use client';

import React, {
  useState,
  useEffect,
  useCallback,
  useMemo,
  useRef,
} from 'react';
import { Card, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { useEstimateWorkflowContext } from '@/contexts/EstimateWorkflowContext';
import { useContractorContext } from '@/contexts/ContractorContext';
import { Plus, Trash2, ChevronDown, ChevronRight } from 'lucide-react';

interface LaborItem {
  id: string;
  name: string;
  hours: string;
  rate: string;
  scope?: string;
  category?: 'design' | 'construction' | 'general';
  isAutoGenerated?: boolean;
  color?: string;
}

interface TradeDesignData {
  // Plumbing - Rough-in
  moveToiletDrainSupply: boolean;
  addVanityPlumbingRoughIn: boolean;
  installNewShowerValve: boolean;
  addFreestandingTubRoughIn: boolean;
  relocateFixtureDrain: boolean;
  addBidetPlumbingRoughIn: boolean;

  // Plumbing - Fixture Installation
  vanityInstallationType: 'none' | 'single' | 'double';
  connectSinkDrains: boolean;
  installVanityFaucetSupplyLines: boolean;
  showerTrimValveTrim: boolean;
  showerTrimShowerHead: boolean;
  showerTrimHandheld: boolean;
  showerTrimRainhead: boolean;
  showerTrimSpout: boolean;
  installToilet: boolean;
  installBidetSeat: boolean;
  installFreestandingTubFaucet: boolean;

  // Electrical - Rough-in
  heatedFloorThermostatPower: boolean;
  addRecessedPotLights: boolean;
  addVanityGFCIOutlets: boolean;
  addToiletBidetPowerOutlet: boolean;
  ledMirrorCabinetPower: boolean;

  // Electrical - Fixture Installation
  replaceBathroomExhaustFan: boolean;
  exhaustFanControl: boolean;
  vanityWallLightFixtures: boolean;
  replaceLightSwitchDimmer: boolean;
  replaceSwitchOrOutlet: boolean;
  replaceShowerPotLight: boolean;
}

export default function TradeLaborSection() {
  const { getDesignData, getLaborItems, setLaborItems, isReloading } =
    useEstimateWorkflowContext();

  const { hourlyRate: contractorHourlyRate } = useContractorContext();

  const designData = getDesignData('trade') as TradeDesignData | null;
  const design = useMemo(
    () =>
      designData || {
        // Plumbing - Rough-in
        moveToiletDrainSupply: false,
        addVanityPlumbingRoughIn: false,
        installNewShowerValve: false,
        addFreestandingTubRoughIn: false,
        relocateFixtureDrain: false,
        addBidetPlumbingRoughIn: false,

        // Plumbing - Fixture Installation
        vanityInstallationType: 'none' as const,
        connectSinkDrains: false,
        installVanityFaucetSupplyLines: false,
        showerTrimValveTrim: false,
        showerTrimShowerHead: false,
        showerTrimHandheld: false,
        showerTrimRainhead: false,
        showerTrimSpout: false,
        installToilet: false,
        installBidetSeat: false,
        installFreestandingTubFaucet: false,

        // Electrical - Rough-in
        heatedFloorThermostatPower: false,
        addRecessedPotLights: false,
        addVanityGFCIOutlets: false,
        addToiletBidetPowerOutlet: false,
        ledMirrorCabinetPower: false,

        // Electrical - Fixture Installation
        replaceBathroomExhaustFan: false,
        exhaustFanControl: false,
        vanityWallLightFixtures: false,
        replaceLightSwitchDimmer: false,
        replaceSwitchOrOutlet: false,
        replaceShowerPotLight: false,
      },
    [designData]
  );

  // Trade rates (plumbing: $110/hr, electrical: $95/hr)
  const PLUMBING_RATE = 110;
  const ELECTRICAL_RATE = 95;

  const [localLaborItems, setLocalLaborItems] = useState<LaborItem[]>([]);
  const [isPlumbingOpen, setIsPlumbingOpen] = useState(true);
  const [isElectricalOpen, setIsElectricalOpen] = useState(true);
  const [isCustomOpen, setIsCustomOpen] = useState(true);

  // Refs to track user actions
  const userActionRef = useRef(false);
  const processedChoicesRef = useRef<string>('');

  // Get current items from context
  const contextLaborItems = getLaborItems('trade');

  // Auto-populate labor items based on selected tasks
  useEffect(() => {
    if (isReloading || userActionRef.current) {
      userActionRef.current = false;
      return;
    }

    // Create a key based on all design choices to detect changes
    const choicesKey = JSON.stringify(design);

    // Skip if choices haven't changed
    if (processedChoicesRef.current === choicesKey) return;

    // Preserve custom items (non-auto-generated)
    const contextLabor = contextLaborItems || [];
    const customLaborItems = contextLabor.filter(
      (item) => item.isAutoGenerated === false
    );

    const newLaborItems: LaborItem[] = [];

    // =========================================================================
    // PLUMBING - ROUGH-IN
    // =========================================================================

    if (design.moveToiletDrainSupply) {
      newLaborItems.push({
        id: 'move-toilet-drain-supply',
        name: 'Move toilet drain and supply',
        hours: '5',
        rate: PLUMBING_RATE.toString(),
        category: 'construction',
        isAutoGenerated: true,
        color: 'blue',
      });
    }

    if (design.addVanityPlumbingRoughIn) {
      newLaborItems.push({
        id: 'add-vanity-plumbing-rough-in',
        name: 'Add Vanity Plumbing Rough-In',
        hours: '4',
        rate: PLUMBING_RATE.toString(),
        category: 'construction',
        isAutoGenerated: true,
        color: 'blue',
      });
    }

    if (design.installNewShowerValve) {
      newLaborItems.push({
        id: 'install-new-shower-valve',
        name: 'Install new shower valve',
        hours: '4',
        rate: PLUMBING_RATE.toString(),
        category: 'construction',
        isAutoGenerated: true,
        color: 'blue',
      });
    }

    if (design.addFreestandingTubRoughIn) {
      newLaborItems.push({
        id: 'add-freestanding-tub-rough-in',
        name: 'Add Freestanding Tub Rough-In',
        hours: '6',
        rate: PLUMBING_RATE.toString(),
        category: 'construction',
        isAutoGenerated: true,
        color: 'blue',
      });
    }

    if (design.relocateFixtureDrain) {
      newLaborItems.push({
        id: 'relocate-fixture-drain',
        name: 'Relocate Fixture Drain (Sink / Shower / Tub)',
        hours: '4',
        rate: PLUMBING_RATE.toString(),
        category: 'construction',
        isAutoGenerated: true,
        color: 'blue',
      });
    }

    if (design.addBidetPlumbingRoughIn) {
      newLaborItems.push({
        id: 'add-bidet-plumbing-rough-in',
        name: 'Add Bidet Plumbing Rough-In',
        hours: '3',
        rate: PLUMBING_RATE.toString(),
        category: 'construction',
        isAutoGenerated: true,
        color: 'blue',
      });
    }

    // =========================================================================
    // PLUMBING - FIXTURE INSTALLATION
    // =========================================================================

    // Vanity sink drain connection based on type
    if (design.vanityInstallationType === 'single' && design.connectSinkDrains) {
      newLaborItems.push({
        id: 'connect-single-sink-drain',
        name: 'Connect Sink Drain (Single)',
        hours: '1.5',
        rate: PLUMBING_RATE.toString(),
        category: 'construction',
        isAutoGenerated: true,
        color: 'blue',
      });
    }

    if (design.vanityInstallationType === 'double' && design.connectSinkDrains) {
      newLaborItems.push({
        id: 'connect-double-sink-drain',
        name: 'Connect Sink Drains (Double)',
        hours: '2.5',
        rate: PLUMBING_RATE.toString(),
        category: 'construction',
        isAutoGenerated: true,
        color: 'blue',
      });
    }

    if (design.installVanityFaucetSupplyLines) {
      const hrs = design.vanityInstallationType === 'double' ? '3' : '1.5';
      newLaborItems.push({
        id: 'install-vanity-faucet-supply',
        name: 'Install Vanity Faucet & Supply Lines',
        hours: hrs,
        rate: PLUMBING_RATE.toString(),
        category: 'construction',
        isAutoGenerated: true,
        color: 'blue',
      });
    }

    // Shower Trim Components - each selected component adds labor
    const showerTrimComponents = [];
    if (design.showerTrimValveTrim) showerTrimComponents.push('Valve Trim');
    if (design.showerTrimShowerHead) showerTrimComponents.push('Shower Head');
    if (design.showerTrimHandheld) showerTrimComponents.push('Handheld');
    if (design.showerTrimRainhead) showerTrimComponents.push('Rainhead');
    if (design.showerTrimSpout) showerTrimComponents.push('Spout');

    if (showerTrimComponents.length > 0) {
      newLaborItems.push({
        id: 'install-shower-trim-components',
        name: `Shower Trim Components (${showerTrimComponents.join(', ')})`,
        hours: (showerTrimComponents.length * 0.75).toFixed(2),
        rate: PLUMBING_RATE.toString(),
        category: 'construction',
        isAutoGenerated: true,
        color: 'blue',
      });
    }

    if (design.installToilet) {
      newLaborItems.push({
        id: 'install-toilet',
        name: 'Install Toilet',
        hours: '1.5',
        rate: PLUMBING_RATE.toString(),
        category: 'construction',
        isAutoGenerated: true,
        color: 'blue',
      });
    }

    if (design.installBidetSeat) {
      newLaborItems.push({
        id: 'install-bidet-seat',
        name: 'Install Bidet / Bidet Seat',
        hours: '1',
        rate: PLUMBING_RATE.toString(),
        category: 'construction',
        isAutoGenerated: true,
        color: 'blue',
      });
    }

    if (design.installFreestandingTubFaucet) {
      newLaborItems.push({
        id: 'install-freestanding-tub-faucet',
        name: 'Install Freestanding Tub & Faucet',
        hours: '3',
        rate: PLUMBING_RATE.toString(),
        category: 'construction',
        isAutoGenerated: true,
        color: 'blue',
      });
    }

    // =========================================================================
    // ELECTRICAL - ROUGH-IN
    // =========================================================================

    if (design.heatedFloorThermostatPower) {
      newLaborItems.push({
        id: 'heated-floor-thermostat-power',
        name: 'Heated Floor Thermostat & Power',
        hours: '3',
        rate: ELECTRICAL_RATE.toString(),
        category: 'construction',
        isAutoGenerated: true,
        color: 'green',
      });
    }

    if (design.addRecessedPotLights) {
      newLaborItems.push({
        id: 'add-recessed-pot-lights',
        name: 'Add Recessed Pot Light(s)',
        hours: '2',
        rate: ELECTRICAL_RATE.toString(),
        category: 'construction',
        isAutoGenerated: true,
        color: 'green',
      });
    }

    if (design.addVanityGFCIOutlets) {
      newLaborItems.push({
        id: 'add-vanity-gfci-outlets',
        name: 'Add Vanity GFCI Outlet(s)',
        hours: '2.5',
        rate: ELECTRICAL_RATE.toString(),
        category: 'construction',
        isAutoGenerated: true,
        color: 'green',
      });
    }

    if (design.addToiletBidetPowerOutlet) {
      newLaborItems.push({
        id: 'add-toilet-bidet-power-outlet',
        name: 'Add Toilet / Bidet Power Outlet',
        hours: '2',
        rate: ELECTRICAL_RATE.toString(),
        category: 'construction',
        isAutoGenerated: true,
        color: 'green',
      });
    }

    if (design.ledMirrorCabinetPower) {
      newLaborItems.push({
        id: 'led-mirror-cabinet-power',
        name: 'LED Mirror / Medicine Cabinet Power',
        hours: '2',
        rate: ELECTRICAL_RATE.toString(),
        category: 'construction',
        isAutoGenerated: true,
        color: 'green',
      });
    }

    // =========================================================================
    // ELECTRICAL - FIXTURE INSTALLATION
    // =========================================================================

    if (design.replaceBathroomExhaustFan) {
      newLaborItems.push({
        id: 'replace-bathroom-exhaust-fan',
        name: 'Replace Bathroom Exhaust Fan',
        hours: '1.5',
        rate: ELECTRICAL_RATE.toString(),
        category: 'construction',
        isAutoGenerated: true,
        color: 'green',
      });
    }

    if (design.exhaustFanControl) {
      newLaborItems.push({
        id: 'exhaust-fan-control',
        name: 'Exhaust Fan Control (Timer / Humidity Sensor)',
        hours: '1',
        rate: ELECTRICAL_RATE.toString(),
        category: 'construction',
        isAutoGenerated: true,
        color: 'green',
      });
    }

    if (design.vanityWallLightFixtures) {
      newLaborItems.push({
        id: 'vanity-wall-light-fixtures',
        name: 'Vanity / Wall Light Fixture(s) (finish-only)',
        hours: '1',
        rate: ELECTRICAL_RATE.toString(),
        category: 'construction',
        isAutoGenerated: true,
        color: 'green',
      });
    }

    if (design.replaceLightSwitchDimmer) {
      newLaborItems.push({
        id: 'replace-light-switch-dimmer',
        name: 'Replace Light Switch with Dimmer (finish-only)',
        hours: '0.5',
        rate: ELECTRICAL_RATE.toString(),
        category: 'construction',
        isAutoGenerated: true,
        color: 'green',
      });
    }

    if (design.replaceSwitchOrOutlet) {
      newLaborItems.push({
        id: 'replace-switch-or-outlet',
        name: 'Replace Switch or Outlet (Finish-Only)',
        hours: '0.5',
        rate: ELECTRICAL_RATE.toString(),
        category: 'construction',
        isAutoGenerated: true,
        color: 'green',
      });
    }

    if (design.replaceShowerPotLight) {
      newLaborItems.push({
        id: 'replace-shower-pot-light',
        name: 'Replace Shower Pot Light (Wet-Rated) (finish-only)',
        hours: '1',
        rate: ELECTRICAL_RATE.toString(),
        category: 'construction',
        isAutoGenerated: true,
        color: 'green',
      });
    }

    // Merge custom items with auto-generated items
    const mergedLaborItems = [...customLaborItems, ...newLaborItems];

    // Update context
    setLaborItems('trade', mergedLaborItems);
    setLocalLaborItems(mergedLaborItems);

    // Update processed choices
    processedChoicesRef.current = choicesKey;
  }, [design, isReloading, setLaborItems, contextLaborItems]);

  // Sync with context changes
  useEffect(() => {
    if (!isReloading) {
      setLocalLaborItems(contextLaborItems as LaborItem[]);
    }
  }, [contextLaborItems, isReloading]);

  // Handlers
  const handleAddLaborItem = useCallback(() => {
    const newItem: LaborItem = {
      id: `labor-${Date.now()}`,
      name: '',
      hours: '1',
      rate: contractorHourlyRate.toString(),
      category: 'construction',
      isAutoGenerated: false,
      color: 'gray',
    };

    const updatedItems = [...localLaborItems, newItem];
    setLocalLaborItems(updatedItems);
    setLaborItems('trade', updatedItems);
    userActionRef.current = true;
  }, [localLaborItems, contractorHourlyRate, setLaborItems]);

  const handleUpdateLaborItem = useCallback(
    (id: string, field: keyof LaborItem, value: string) => {
      const updatedItems = localLaborItems.map((item) =>
        item.id === id ? { ...item, [field]: value } : item
      );
      setLocalLaborItems(updatedItems);
      setLaborItems('trade', updatedItems);
      userActionRef.current = true;
    },
    [localLaborItems, setLaborItems]
  );

  const handleDeleteLaborItem = useCallback(
    (id: string) => {
      const updatedItems = localLaborItems.filter((item) => item.id !== id);
      setLocalLaborItems(updatedItems);
      setLaborItems('trade', updatedItems);
      userActionRef.current = true;
    },
    [localLaborItems, setLaborItems]
  );

  // Calculate totals
  const laborTotal = useMemo(() => {
    return localLaborItems.reduce((total, item) => {
      const hours = parseFloat(item.hours) || 0;
      const rate = parseFloat(item.rate) || 0;
      return total + hours * rate;
    }, 0);
  }, [localLaborItems]);

  const totalHours = useMemo(() => {
    return localLaborItems.reduce((total, item) => {
      const hours = parseFloat(item.hours) || 0;
      return total + hours;
    }, 0);
  }, [localLaborItems]);

  // Group items by category
  const plumbingItems = localLaborItems.filter((item) => item.color === 'blue');
  const electricalItems = localLaborItems.filter(
    (item) => item.color === 'green'
  );
  const customItems = localLaborItems.filter((item) => item.color === 'gray');

  // Calculate totals for each category
  const plumbingHours = plumbingItems.reduce(
    (sum, item) => sum + (parseFloat(item.hours) || 0),
    0
  );
  const plumbingTotal = plumbingItems.reduce(
    (sum, item) =>
      sum + (parseFloat(item.hours) || 0) * (parseFloat(item.rate) || 0),
    0
  );

  const electricalHours = electricalItems.reduce(
    (sum, item) => sum + (parseFloat(item.hours) || 0),
    0
  );
  const electricalTotal = electricalItems.reduce(
    (sum, item) =>
      sum + (parseFloat(item.hours) || 0) * (parseFloat(item.rate) || 0),
    0
  );

  const customHours = customItems.reduce(
    (sum, item) => sum + (parseFloat(item.hours) || 0),
    0
  );
  const customTotal = customItems.reduce(
    (sum, item) =>
      sum + (parseFloat(item.hours) || 0) * (parseFloat(item.rate) || 0),
    0
  );

  const renderLaborItem = useCallback(
    (item: LaborItem) => (
      <div
        key={item.id}
        className='p-3 bg-white rounded-lg border border-slate-200 shadow-sm w-full'
      >
        <div className='flex items-center gap-2 mb-2 w-full'>
          <Input
            type='text'
            value={item.name}
            onChange={(e) =>
              handleUpdateLaborItem(item.id, 'name', e.target.value)
            }
            placeholder='Labor Task'
            className='border-b-2 border-t-0 border-l-0 border-r-0 bg-transparent border-blue-300 focus:border-blue-500 focus:outline-none w-44 sm:w-full'
          />
          <Button
            onClick={() => handleDeleteLaborItem(item.id)}
            variant='ghost'
            size='sm'
            className='text-red-500 hover:text-red-700 p-1 h-auto flex-shrink-0'
          >
            <Trash2 size={16} />
          </Button>
        </div>
        <div className='grid grid-cols-2 gap-3'>
          <div className='w-full'>
            <label className='text-xs text-slate-500'>Hours</label>
            <Input
              type='number'
              value={item.hours}
              onChange={(e) =>
                handleUpdateLaborItem(item.id, 'hours', e.target.value)
              }
              placeholder='0'
              className='text-center w-full border-blue-300 focus:border-blue-500'
            />
          </div>
          <div className='w-full'>
            <label className='text-xs text-slate-500'>Rate ($/hr)</label>
            <Input
              type='number'
              value={item.rate}
              onChange={(e) =>
                handleUpdateLaborItem(item.id, 'rate', e.target.value)
              }
              placeholder='0'
              className='text-center w-full border-blue-300 focus:border-blue-500'
            />
          </div>
          <div className='col-span-2 w-full'>
            <label className='text-xs text-slate-500'>Total</label>
            <div className='w-full p-2 text-center font-semibold text-slate-800 bg-slate-50 rounded-md'>
              $
              {(
                (parseFloat(item.hours) || 0) * (parseFloat(item.rate) || 0)
              ).toFixed(2)}
            </div>
          </div>
        </div>
      </div>
    ),
    [handleUpdateLaborItem, handleDeleteLaborItem]
  );

  return (
    <div className='space-y-5'>
      <div className='flex justify-between items-baseline'>
        <h2 className='text-2xl font-bold text-slate-800'>Labor</h2>
        {totalHours > 0 && (
          <div className='flex items-center gap-2 text-sm text-slate-600'>
            <span className='font-semibold text-xl text-slate-800'>
              {totalHours.toFixed(1)} hrs
            </span>
          </div>
        )}
        <div className='flex items-center gap-2 text-sm text-slate-600'>
          <span className='font-semibold text-xl text-blue-600'>
            ${laborTotal.toFixed(2)}
          </span>
        </div>
      </div>

      <div className='space-y-4'>
        {/* Plumbing */}
        <Card>
          <CardContent className='p-3 space-y-3'>
            <div
              className='flex justify-between items-center cursor-pointer'
              onClick={() => setIsPlumbingOpen(!isPlumbingOpen)}
            >
              <div className='flex items-center gap-2 justify-between w-full'>
                <div className='flex items-center gap-2'>
                  {isPlumbingOpen ? (
                    <ChevronDown className='h-4 w-4 text-slate-600' />
                  ) : (
                    <ChevronRight className='h-4 w-4 text-slate-600' />
                  )}
                  <h3 className='text-lg font-semibold text-slate-700'>
                    Plumbing
                  </h3>
                </div>
                <span className='text-sm text-slate-500'>
                  {plumbingHours.toFixed(1)} hrs
                </span>
                <p className='font-bold text-blue-600 text-sm'>
                  ${plumbingTotal.toFixed(2)}
                </p>
              </div>
            </div>
            {isPlumbingOpen && (
              <>
                {plumbingItems.length > 0 ? (
                  <div className='space-y-2'>
                    {plumbingItems.map(renderLaborItem)}
                  </div>
                ) : (
                  <p className='text-sm text-slate-500 text-center py-4'>
                    No plumbing items added yet. Select tasks in Design section.
                  </p>
                )}
              </>
            )}
          </CardContent>
        </Card>

        {/* Electrical */}
        <Card>
          <CardContent className='p-3 space-y-3'>
            <div
              className='flex justify-between items-center cursor-pointer'
              onClick={() => setIsElectricalOpen(!isElectricalOpen)}
            >
              <div className='flex items-center gap-2 justify-between w-full'>
                <div className='flex items-center gap-2'>
                  {isElectricalOpen ? (
                    <ChevronDown className='h-4 w-4 text-slate-600' />
                  ) : (
                    <ChevronRight className='h-4 w-4 text-slate-600' />
                  )}
                  <h3 className='text-lg font-semibold text-slate-700'>
                    Electrical
                  </h3>
                </div>
                <span className='text-sm text-slate-500'>
                  {electricalHours.toFixed(1)} hrs
                </span>
                <p className='font-bold text-blue-600 text-sm'>
                  ${electricalTotal.toFixed(2)}
                </p>
              </div>
            </div>
            {isElectricalOpen && (
              <>
                {electricalItems.length > 0 ? (
                  <div className='space-y-2'>
                    {electricalItems.map(renderLaborItem)}
                  </div>
                ) : (
                  <p className='text-sm text-slate-500 text-center py-4'>
                    No electrical items added yet. Select tasks in Design section.
                  </p>
                )}
              </>
            )}
          </CardContent>
        </Card>

        {/* Custom Items */}
        <Card>
          <CardContent className='p-3 space-y-3'>
            <div
              className='flex justify-between items-center cursor-pointer'
              onClick={() => setIsCustomOpen(!isCustomOpen)}
            >
              <div className='flex items-center gap-2 justify-between w-full'>
                <div className='flex items-center gap-2'>
                  {isCustomOpen ? (
                    <ChevronDown className='h-4 w-4 text-slate-600' />
                  ) : (
                    <ChevronRight className='h-4 w-4 text-slate-600' />
                  )}
                  <h3 className='text-lg font-semibold text-slate-700'>
                    Custom Items
                  </h3>
                </div>
                <span className='text-sm text-slate-500'>
                  {customHours.toFixed(1)} hrs
                </span>
                <p className='font-bold text-blue-600 text-sm'>
                  ${customTotal.toFixed(2)}
                </p>
              </div>
            </div>
            {isCustomOpen && (
              <>
                {customItems.length > 0 ? (
                  <div className='space-y-2'>
                    {customItems.map(renderLaborItem)}
                  </div>
                ) : (
                  <p className='text-sm text-slate-500 text-center py-4'>
                    No custom items added yet.
                  </p>
                )}
                <div className='flex justify-center'>
                  <Button
                    onClick={handleAddLaborItem}
                    variant='default'
                    className='w-auto mt-2 flex items-center justify-center gap-2 py-2.5 px-4 text-white font-semibold border-blue-200'
                  >
                    <Plus size={16} />
                    Add Item
                  </Button>
                </div>
              </>
            )}
          </CardContent>
        </Card>
      </div>
    </div>
  );
}
