'use client';

import React, {
  useState,
  useEffect,
  useCallback,
  useMemo,
  useRef,
} from 'react';
import { Card, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { useEstimateWorkflowContext } from '@/contexts/EstimateWorkflowContext';
import { Plus, Trash2, ChevronDown, ChevronRight } from 'lucide-react';

interface MaterialItem {
  id: string;
  name: string;
  quantity: string;
  price: string;
  unit: string;
  scope?: string;
  category?: 'design' | 'construction' | 'general';
  isAutoGenerated?: boolean;
  color?: string;
  source?: string;
}

interface TradeDesignData {
  // Plumbing - Rough-in
  roughInNewPlumbing: boolean;
  moveToiletDrainSupply: boolean;
  installNewShowerValve: boolean;
  moveDrain: boolean;
  roughInStandaloneTub: boolean;

  // Plumbing - Finishing
  installVanitySinkPlumbing: boolean;
  installVanityFaucetSupply: boolean;
  installShowerTubTrimKit: boolean;
  installNewToilet: boolean;
  installStandaloneTubFaucet: boolean;

  // Electrical - Rough-in
  installNewOutlet: boolean;
  installNewGFCIOutlet: boolean;
  installNewPotLight: boolean;

  // Electrical - Finishing
  installNewLightFixture: boolean;
  installNewExhaustFan: boolean;
}

export default function TradeMaterialsSection() {
  const { getDesignData, getMaterialItems, setMaterialItems, isReloading } =
    useEstimateWorkflowContext();

  const designData = getDesignData('trade') as TradeDesignData | null;
  const design = useMemo(
    () =>
      designData || {
        // Plumbing - Rough-in
        roughInNewPlumbing: false,
        moveToiletDrainSupply: false,
        installNewShowerValve: false,
        moveDrain: false,
        roughInStandaloneTub: false,

        // Plumbing - Finishing
        installVanitySinkPlumbing: false,
        installVanityFaucetSupply: false,
        installShowerTubTrimKit: false,
        installNewToilet: false,
        installStandaloneTubFaucet: false,

        // Electrical - Rough-in
        installNewOutlet: false,
        installNewGFCIOutlet: false,
        installNewPotLight: false,

        // Electrical - Finishing
        installNewLightFixture: false,
        installNewExhaustFan: false,
      },
    [designData]
  );

  const [localMaterialItems, setLocalMaterialItems] = useState<MaterialItem[]>(
    []
  );
  const [isPlumbingOpen, setIsPlumbingOpen] = useState(true);
  const [isElectricalOpen, setIsElectricalOpen] = useState(true);
  const userActionRef = useRef(false);
  const processedChoicesRef = useRef<string>('');

  // Get current items from context
  const contextMaterialItems = getMaterialItems('trade');

  // Auto-populate material items based on selected tasks
  useEffect(() => {
    if (isReloading || userActionRef.current) {
      userActionRef.current = false;
      return;
    }

    const newMaterialItems: MaterialItem[] = [];

    // Plumbing - Rough-in
    if (design.roughInNewPlumbing) {
      newMaterialItems.push(
        {
          id: 'rough-in-plumbing-pipes',
          name: 'Copper pipes (1/2")',
          quantity: '50',
          price: '2.50',
          unit: 'ft',
          category: 'construction',
          isAutoGenerated: true,
          color: 'blue',
        },
        {
          id: 'rough-in-plumbing-fittings',
          name: 'Pipe fittings',
          quantity: '20',
          price: '3.00',
          unit: 'each',
          category: 'construction',
          isAutoGenerated: true,
          color: 'blue',
        }
      );
    }

    if (design.moveToiletDrainSupply) {
      newMaterialItems.push(
        {
          id: 'toilet-drain-pipe',
          name: '3" PVC drain pipe',
          quantity: '10',
          price: '4.50',
          unit: 'ft',
          category: 'construction',
          isAutoGenerated: true,
          color: 'blue',
        },
        {
          id: 'toilet-supply-line',
          name: 'Toilet supply line',
          quantity: '1',
          price: '15.00',
          unit: 'each',
          category: 'construction',
          isAutoGenerated: true,
          color: 'blue',
        }
      );
    }

    if (design.installNewShowerValve) {
      newMaterialItems.push({
        id: 'shower-valve',
        name: 'Shower valve assembly',
        quantity: '1',
        price: '120.00',
        unit: 'each',
        category: 'construction',
        isAutoGenerated: true,
        color: 'blue',
      });
    }

    if (design.moveDrain) {
      newMaterialItems.push(
        {
          id: 'drain-pipe',
          name: '2" PVC drain pipe',
          quantity: '15',
          price: '3.50',
          unit: 'ft',
          category: 'construction',
          isAutoGenerated: true,
          color: 'blue',
        },
        {
          id: 'drain-fittings',
          name: 'Drain fittings',
          quantity: '8',
          price: '5.00',
          unit: 'each',
          category: 'construction',
          isAutoGenerated: true,
          color: 'blue',
        }
      );
    }

    if (design.roughInStandaloneTub) {
      newMaterialItems.push(
        {
          id: 'tub-supply-pipes',
          name: 'Tub supply pipes',
          quantity: '20',
          price: '2.50',
          unit: 'ft',
          category: 'construction',
          isAutoGenerated: true,
          color: 'blue',
        },
        {
          id: 'tub-drain-assembly',
          name: 'Tub drain assembly',
          quantity: '1',
          price: '45.00',
          unit: 'each',
          category: 'construction',
          isAutoGenerated: true,
          color: 'blue',
        }
      );
    }

    // Plumbing - Finishing
    if (design.installVanitySinkPlumbing) {
      newMaterialItems.push(
        {
          id: 'vanity-p-trap',
          name: 'P-trap assembly',
          quantity: '1',
          price: '25.00',
          unit: 'each',
          category: 'construction',
          isAutoGenerated: true,
          color: 'blue',
        },
        {
          id: 'vanity-supply-lines',
          name: 'Supply lines',
          quantity: '2',
          price: '12.00',
          unit: 'each',
          category: 'construction',
          isAutoGenerated: true,
          color: 'blue',
        }
      );
    }

    if (design.installVanityFaucetSupply) {
      newMaterialItems.push({
        id: 'vanity-faucet',
        name: 'Vanity faucet',
        quantity: '1',
        price: '180.00',
        unit: 'each',
        category: 'construction',
        isAutoGenerated: true,
        color: 'blue',
      });
    }

    if (design.installShowerTubTrimKit) {
      newMaterialItems.push({
        id: 'shower-trim-kit',
        name: 'Shower trim kit',
        quantity: '1',
        price: '85.00',
        unit: 'each',
        category: 'construction',
        isAutoGenerated: true,
        color: 'blue',
      });
    }

    if (design.installNewToilet) {
      newMaterialItems.push(
        {
          id: 'toilet-wax-ring',
          name: 'Wax ring',
          quantity: '1',
          price: '8.00',
          unit: 'each',
          category: 'construction',
          isAutoGenerated: true,
          color: 'blue',
        },
        {
          id: 'toilet-bolts',
          name: 'Toilet bolts',
          quantity: '1',
          price: '5.00',
          unit: 'set',
          category: 'construction',
          isAutoGenerated: true,
          color: 'blue',
        }
      );
    }

    if (design.installStandaloneTubFaucet) {
      newMaterialItems.push({
        id: 'tub-faucet',
        name: 'Tub faucet',
        quantity: '1',
        price: '220.00',
        unit: 'each',
        category: 'construction',
        isAutoGenerated: true,
        color: 'blue',
      });
    }

    // Electrical - Rough-in
    if (design.installNewOutlet) {
      newMaterialItems.push(
        {
          id: 'outlet-box',
          name: 'Electrical outlet box',
          quantity: '1',
          price: '8.00',
          unit: 'each',
          category: 'construction',
          isAutoGenerated: true,
          color: 'green',
        },
        {
          id: 'outlet-wire',
          name: '12 AWG wire',
          quantity: '25',
          price: '1.50',
          unit: 'ft',
          category: 'construction',
          isAutoGenerated: true,
          color: 'green',
        }
      );
    }

    if (design.installNewGFCIOutlet) {
      newMaterialItems.push(
        {
          id: 'gfci-outlet',
          name: 'GFCI outlet',
          quantity: '1',
          price: '25.00',
          unit: 'each',
          category: 'construction',
          isAutoGenerated: true,
          color: 'green',
        },
        {
          id: 'gfci-wire',
          name: '12 AWG wire',
          quantity: '30',
          price: '1.50',
          unit: 'ft',
          category: 'construction',
          isAutoGenerated: true,
          color: 'green',
        }
      );
    }

    if (design.installNewPotLight) {
      newMaterialItems.push(
        {
          id: 'pot-light-fixture',
          name: 'Pot light fixture',
          quantity: '1',
          price: '45.00',
          unit: 'each',
          category: 'construction',
          isAutoGenerated: true,
          color: 'green',
        },
        {
          id: 'pot-light-wire',
          name: '14 AWG wire',
          quantity: '20',
          price: '1.20',
          unit: 'ft',
          category: 'construction',
          isAutoGenerated: true,
          color: 'green',
        }
      );
    }

    // Electrical - Finishing
    if (design.installNewLightFixture) {
      newMaterialItems.push(
        {
          id: 'light-fixture',
          name: 'Light fixture',
          quantity: '1',
          price: '85.00',
          unit: 'each',
          category: 'construction',
          isAutoGenerated: true,
          color: 'green',
        },
        {
          id: 'light-fixture-wire',
          name: '14 AWG wire',
          quantity: '15',
          price: '1.20',
          unit: 'ft',
          category: 'construction',
          isAutoGenerated: true,
          color: 'green',
        }
      );
    }

    if (design.installNewExhaustFan) {
      newMaterialItems.push(
        {
          id: 'exhaust-fan',
          name: 'Exhaust fan',
          quantity: '1',
          price: '120.00',
          unit: 'each',
          category: 'construction',
          isAutoGenerated: true,
          color: 'green',
        },
        {
          id: 'exhaust-duct',
          name: 'Exhaust duct',
          quantity: '10',
          price: '3.50',
          unit: 'ft',
          category: 'construction',
          isAutoGenerated: true,
          color: 'green',
        }
      );
    }

    // Update context
    setMaterialItems('trade', newMaterialItems);
    setLocalMaterialItems(newMaterialItems);

    // Update processed choices
    const choicesString = JSON.stringify(design);
    processedChoicesRef.current = choicesString;
  }, [design, isReloading, setMaterialItems]);

  // Sync with context changes
  useEffect(() => {
    if (!isReloading) {
      setLocalMaterialItems(contextMaterialItems);
    }
  }, [contextMaterialItems, isReloading]);

  // Handlers
  const handleAddMaterialItem = useCallback(() => {
    const newItem: MaterialItem = {
      id: `material-${Date.now()}`,
      name: '',
      quantity: '1',
      price: '0',
      unit: '',
      category: 'construction',
      isAutoGenerated: false,
      color: 'gray',
    };

    const updatedItems = [...localMaterialItems, newItem];
    setLocalMaterialItems(updatedItems);
    setMaterialItems('trade', updatedItems);
    userActionRef.current = true;
  }, [localMaterialItems, setMaterialItems]);

  const handleUpdateMaterialItem = useCallback(
    (id: string, field: keyof MaterialItem, value: string) => {
      const updatedItems = localMaterialItems.map((item) =>
        item.id === id ? { ...item, [field]: value } : item
      );
      setLocalMaterialItems(updatedItems);
      setMaterialItems('trade', updatedItems);
      userActionRef.current = true;
    },
    [localMaterialItems, setMaterialItems]
  );

  const handleDeleteMaterialItem = useCallback(
    (id: string) => {
      const updatedItems = localMaterialItems.filter((item) => item.id !== id);
      setLocalMaterialItems(updatedItems);
      setMaterialItems('trade', updatedItems);
      userActionRef.current = true;
    },
    [localMaterialItems, setMaterialItems]
  );

  // Calculate totals
  const materialTotal = useMemo(() => {
    return localMaterialItems.reduce((total, item) => {
      const quantity = parseFloat(item.quantity) || 0;
      const price = parseFloat(item.price) || 0;
      return total + quantity * price;
    }, 0);
  }, [localMaterialItems]);

  // Group items by category
  const plumbingItems = localMaterialItems.filter(
    (item) => item.color === 'blue'
  );
  const electricalItems = localMaterialItems.filter(
    (item) => item.color === 'green'
  );
  const customItems = localMaterialItems.filter(
    (item) => item.color === 'gray'
  );

  const renderMaterialItem = (item: MaterialItem) => (
    <div
      key={item.id}
      className={`p-3 rounded-lg border bg-white border-gray-200`}
    >
      <div className='flex items-center gap-3'>
        <div className='flex-1'>
          <Input
            value={item.name}
            onChange={(e) =>
              handleUpdateMaterialItem(item.id, 'name', e.target.value)
            }
            placeholder='Item name'
            className='font-medium'
          />
        </div>
        <div className='w-20'>
          <Input
            type='number'
            value={item.quantity}
            onChange={(e) =>
              handleUpdateMaterialItem(item.id, 'quantity', e.target.value)
            }
            placeholder='Qty'
            className='text-center'
          />
        </div>
        <div className='w-16'>
          <Input
            value={item.unit}
            onChange={(e) =>
              handleUpdateMaterialItem(item.id, 'unit', e.target.value)
            }
            placeholder='Unit'
            className='text-center'
          />
        </div>
        <div className='w-24'>
          <Input
            type='number'
            value={item.price}
            onChange={(e) =>
              handleUpdateMaterialItem(item.id, 'price', e.target.value)
            }
            placeholder='Price'
            className='text-center'
          />
        </div>
        <div className='w-24 text-right font-semibold text-gray-700'>
          ${(parseFloat(item.quantity) * parseFloat(item.price)).toFixed(2)}
        </div>
        {!item.isAutoGenerated && (
          <Button
            onClick={() => handleDeleteMaterialItem(item.id)}
            variant='ghost'
            size='sm'
            className='p-1 text-red-500 hover:text-red-700'
          >
            <Trash2 size={16} />
          </Button>
        )}
      </div>
    </div>
  );

  return (
    <div className='space-y-6'>
      <div className='pt-2'>
        <div className='flex justify-between items-baseline'>
          <h2 className='text-2xl font-bold text-slate-800'>Materials</h2>
          <div className='text-xl font-bold text-blue-600'>
            ${materialTotal.toFixed(2)}
          </div>
        </div>
      </div>

      {/* Plumbing */}
      <Card>
        <CardContent className='p-0'>
          <div
            className='flex items-center justify-between p-4 cursor-pointer hover:bg-gray-50'
            onClick={() => setIsPlumbingOpen(!isPlumbingOpen)}
          >
            <h3 className='text-lg font-semibold text-gray-900'>Plumbing</h3>
            {isPlumbingOpen ? (
              <ChevronDown className='h-5 w-5 text-gray-500' />
            ) : (
              <ChevronRight className='h-5 w-5 text-gray-500' />
            )}
          </div>
          {isPlumbingOpen && (
            <div className='px-4 pb-4 space-y-3'>
              {plumbingItems.length > 0 ? (
                plumbingItems.map(renderMaterialItem)
              ) : (
                <div className='text-center py-8 text-gray-500'>
                  No plumbing materials yet. Select tasks in the Design section
                  to auto-populate items.
                </div>
              )}
            </div>
          )}
        </CardContent>
      </Card>

      {/* Electrical */}
      <Card>
        <CardContent className='p-0'>
          <div
            className='flex items-center justify-between p-4 cursor-pointer hover:bg-gray-50'
            onClick={() => setIsElectricalOpen(!isElectricalOpen)}
          >
            <h3 className='text-lg font-semibold text-gray-900'>Electrical</h3>
            {isElectricalOpen ? (
              <ChevronDown className='h-5 w-5 text-gray-500' />
            ) : (
              <ChevronRight className='h-5 w-5 text-gray-500' />
            )}
          </div>
          {isElectricalOpen && (
            <div className='px-4 pb-4 space-y-3'>
              {electricalItems.length > 0 ? (
                electricalItems.map(renderMaterialItem)
              ) : (
                <div className='text-center py-8 text-gray-500'>
                  No electrical materials yet. Select tasks in the Design
                  section to auto-populate items.
                </div>
              )}
            </div>
          )}
        </CardContent>
      </Card>

      {/* Custom Items */}
      <Card>
        <CardContent className='p-0'>
          <div className='flex items-center justify-between p-4'>
            <h3 className='text-lg font-semibold text-gray-900'>
              Custom Items
            </h3>
            <Button
              onClick={handleAddMaterialItem}
              variant='outline'
              size='sm'
              className='flex items-center gap-2'
            >
              <Plus size={16} />
              Add Material Item
            </Button>
          </div>
          <div className='px-4 pb-4 space-y-3'>
            {customItems.length > 0 ? (
              customItems.map(renderMaterialItem)
            ) : (
              <div className='text-center py-8 text-gray-500'>
                No custom items yet. Click &quot;Add Material Item&quot; to
                create one.
              </div>
            )}
          </div>
        </CardContent>
      </Card>

      {/* Totals */}
      <Card>
        <CardContent className='p-4'>
          <div className='space-y-2'>
            <div className='flex justify-between items-center'>
              <span className='text-lg font-medium text-gray-700'>
                Materials Total:
              </span>
              <span className='text-xl font-bold text-blue-600'>
                ${materialTotal.toFixed(2)}
              </span>
            </div>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}
