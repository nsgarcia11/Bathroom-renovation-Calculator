// Supabase-specific types for estimate data storage

export interface EstimateRecord {
  id: string;
  project_id: string;
  data: EstimateDataPayload;
  created_at: string;
  updated_at: string;
}

export interface EstimateDataPayload {
  // Project metadata
  projectNotes: string;
  lastUpdated: string;

  // Workflow data - stored as JSONB in Supabase
  workflows: {
    demolition: {
      design: {
        demolitionChoices: Record<string, 'yes' | 'no'>;
        debrisDisposal: 'yes' | 'no';
        isDemolitionFlatFee: 'yes' | 'no';
        flatFeeAmount: string;
        flatFeeDescription: string;
      };
      labor: {
        hourlyItems: Array<{
          id: string;
          name: string;
          hours: string;
          rate: string;
          scope?: string;
          category?: string;
          isAutoGenerated?: boolean;
        }>;
        flatFeeItems: Array<{
          id: string;
          name: string;
          unitPrice: string;
          description?: string;
        }>;
      };
      materials: {
        items: Array<{
          id: string;
          name: string;
          quantity: string;
          price: string;
          unit: string;
          scope?: string;
          category?: string;
          isAutoGenerated?: boolean;
        }>;
      };
      notes: {
        contractorNotes: string;
        clientNotes: string;
      };
      estimate: {
        laborTotal: number;
        materialsTotal: number;
        grandTotal: number;
        lastUpdated: string;
      };
    };
    showerWalls: {
      design: {
        measurements: {
          length: string;
          width: string;
          height: string;
        };
        wallType: 'tile' | 'panels' | 'paint';
        tileType?: string;
        panelType?: string;
        paintType?: string;
        waterproofing: 'yes' | 'no';
        groutType?: string;
        trimType?: string;
      };
      labor: {
        hourlyItems: Array<{
          id: string;
          name: string;
          hours: string;
          rate: string;
          scope?: string;
          category?: string;
          isAutoGenerated?: boolean;
        }>;
        flatFeeItems: Array<{
          id: string;
          name: string;
          unitPrice: string;
          description?: string;
        }>;
      };
      materials: {
        items: Array<{
          id: string;
          name: string;
          quantity: string;
          price: string;
          unit: string;
          scope?: string;
          category?: string;
          isAutoGenerated?: boolean;
        }>;
      };
      notes: {
        contractorNotes: string;
        clientNotes: string;
      };
      estimate: {
        laborTotal: number;
        materialsTotal: number;
        grandTotal: number;
        lastUpdated: string;
      };
    };
    // Similar structure for other workflows...
    [key: string]: {
      design: Record<string, unknown>;
      labor: {
        hourlyItems: Array<{
          id: string;
          name: string;
          hours: string;
          rate: string;
          scope?: string;
          category?: string;
          isAutoGenerated?: boolean;
        }>;
        flatFeeItems: Array<{
          id: string;
          name: string;
          unitPrice: string;
          description?: string;
        }>;
      };
      materials: {
        items: Array<{
          id: string;
          name: string;
          quantity: string;
          price: string;
          unit: string;
          scope?: string;
          category?: string;
          isAutoGenerated?: boolean;
        }>;
      };
      notes: {
        contractorNotes: string;
        clientNotes: string;
      };
      estimate: {
        laborTotal: number;
        materialsTotal: number;
        grandTotal: number;
        lastUpdated: string;
      };
    };
  };

  // Overall estimate summary
  estimate: {
    totalLabor: number;
    totalMaterials: number;
    grandTotal: number;
    breakdown: Array<{
      workflow: string;
      name: string;
      laborCost: number;
      materialsCost: number;
      total: number;
    }>;
  };
}

// Migration helpers for converting old data to new structure
export function migrateOldDataToNewStructure(
  oldData: Record<string, unknown>
): EstimateDataPayload {
  return {
    projectNotes: (oldData.projectNotes as string) || '',
    lastUpdated: new Date().toISOString(),
    workflows: {
      demolition: {
        design: {
          demolitionChoices:
            (oldData.demolitionChoices as Record<string, 'yes' | 'no'>) || {},
          debrisDisposal: (oldData.debrisDisposal as 'yes' | 'no') || 'no',
          isDemolitionFlatFee:
            (oldData.isDemolitionFlatFee as 'yes' | 'no') || 'no',
          flatFeeAmount: (oldData.flatFeeAmount as string) || '0',
          flatFeeDescription:
            (oldData.flatFeeDescription as string) ||
            'Demolition & Debris Removal',
        },
        labor: {
          hourlyItems:
            (
              (oldData.categoryWorkflowData as Record<string, unknown>)
                ?.demolition as Record<string, unknown>
            )?.labor?.laborItems || [],
          flatFeeItems:
            (
              (oldData.categoryWorkflowData as Record<string, unknown>)
                ?.demolition as Record<string, unknown>
            )?.labor?.flatFeeItems || [],
        },
        materials: {
          items:
            ((oldData.categoryWorkflowData as Record<string, unknown>)?.demolition as Record<string, unknown>)?.materials?.constructionMaterials || [],
        },
        notes: {
          contractorNotes: (oldData.demolitionContractorNotes as string) || '',
          clientNotes: (oldData.demolitionClientNotes as string) || '',
        },
        estimate: {
          laborTotal: 0,
          materialsTotal: 0,
          grandTotal: 0,
          lastUpdated: new Date().toISOString(),
        },
      },
      showerWalls: {
        design: {
          measurements: {
            length: '0',
            width: '0',
            height: '0',
          },
          wallType: 'tile',
          waterproofing: 'no',
        },
        labor: {
          hourlyItems:
            (oldData.categoryWorkflowData as Record<string, unknown>)?.[
              'shower-walls'
            ]?.labor?.laborItems || [],
          flatFeeItems:
            (oldData.categoryWorkflowData as Record<string, unknown>)?.[
              'shower-walls'
            ]?.labor?.flatFeeItems || [],
        },
        materials: {
          items:
            (oldData.categoryWorkflowData as Record<string, unknown>)?.[
              'shower-walls'
            ]?.materials?.constructionMaterials || [],
        },
        notes: { contractorNotes: '', clientNotes: '' },
        estimate: {
          laborTotal: 0,
          materialsTotal: 0,
          grandTotal: 0,
          lastUpdated: new Date().toISOString(),
        },
      },
      // Add other workflows with similar migration logic...
    },
    estimate: {
      totalLabor: 0,
      totalMaterials: 0,
      grandTotal: 0,
      breakdown: [],
    },
  };
}
